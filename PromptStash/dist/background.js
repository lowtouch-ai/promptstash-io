(()=>{const e=["https://grok.com/","https://chatgpt.com/","https://www.perplexity.ai/","https://gemini.google.com/","https://claude.ai/"],t="grok.com, chatgpt.com, perplexity.ai, gemini.google.com, and claude.ai";function r(){const e="promptstash-popup";let t=document.getElementById(e);t?(t.remove(),console.log("------------------- Pop-up closed -------------------")):(t=document.createElement("div"),t.id=e,t.innerHTML=`\n      <iframe src="${chrome.runtime.getURL("popup.html")}" style="width: 100%; height: 100%; border: none;"></iframe>\n    `,document.body.appendChild(t),console.log("------------------- Pop-up opened -------------------"),chrome.storage.local.get(["isFullscreen"],(e=>{console.log("logged from background.js: value of isFullscreen in chrome.storage.local on opening popup =",e.isFullscreen);const r=e.isFullscreen||!1,o=window.innerWidth<=768,s=r||o?"100vw":"50vw",n=r||o?"100vh":"96vh",c=r||o?"0":.49*window.innerWidth+"px",i=r||o?"0":"2vh";Object.assign(t.style,{width:s,height:n,position:"absolute",top:i,left:c,zIndex:"10000",backgroundColor:"none",border:"2px solid #8888",borderRadius:r?"0":"10px",boxShadow:r?"none":"0 4px 15px rgba(0, 0, 0, 0.2)",overflow:"hidden",transition:"width 0.3s ease, height 0.3s ease, top 0.3s ease, left 0.3s ease"})})),document.addEventListener("keydown",(e=>{"Escape"===e.key&&t&&(t.remove(),chrome.storage.local.set({isFullscreen:!1}))})),document.addEventListener("click",(e=>{const r=document.getElementById("promptstash-widget");!t||t.contains(e.target)||r.contains(e.target)||(t.remove(),chrome.storage.local.set({isFullscreen:!1}))})))}function o(e){let t=document.getElementById("promptstash-toast");t&&t.remove(),t=document.createElement("div"),t.id="promptstash-toast",t.className="promptstash-toast",t.textContent=e,document.body.appendChild(t),Object.assign(t.style,{position:"fixed",top:"20px",right:"20px",padding:"10px 20px",borderRadius:"6px",background:"#fdd",color:"#800",zIndex:"10001",opacity:"0",transform:"translateY(-20px)",transition:"opacity 0.3s ease, transform 0.3s ease"}),setTimeout((()=>{t.style.opacity="1",t.style.transform="translateY(0)"}),10),setTimeout((()=>{t.style.opacity="0",t.style.transform="translateY(-20px)",setTimeout((()=>t.remove()),300)}),3e3)}chrome.runtime.onConnect.addListener((e=>{"keepAlive"===e.name&&e.onDisconnect.addListener((()=>{chrome.tabs.query({active:!0,currentWindow:!0},(e=>{e[0]&&!e[0].url.match(/^(chrome|file|about):\/\//)&&(document.getElementById("promptstash-widget").remove(),chrome.scripting.executeScript({target:{tabId:e[0].id},files:["content.js"]},(()=>{chrome.runtime.lastError&&console.error("Periodic content script injection error:",chrome.runtime.lastError.message)})))}))}))})),setInterval((()=>{chrome.tabs.query({active:!0,currentWindow:!0},(e=>{e[0]&&!e[0].url.match(/^(chrome|file|about):\/\//)&&chrome.tabs.sendMessage(e[0].id,{action:"ping"},(t=>{chrome.runtime.lastError&&chrome.scripting.executeScript({target:{tabId:e[0].id},files:["content.js"]},(()=>{chrome.runtime.lastError&&console.error("Periodic content script injection error:",chrome.runtime.lastError.message)}))}))}))}),3e5),chrome.action.onClicked.addListener((s=>s.url.match(/^(chrome|file|about):\/\//)?(console.error("Cannot inject into restricted URLs:",s.url),void chrome.scripting.executeScript({target:{tabId:s.id},function:o,args:[`PromptStash cannot be used on restricted URLs (e.g., chrome://, file://, about://). Please navigate to a supported AI platform (e.g., ${t.replace(", and ",", or ")}).`]})):e.some((e=>new RegExp(`^${e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}.*`).test(s.url)))?void chrome.scripting.executeScript({target:{tabId:s.id},function:r},(()=>{chrome.runtime.lastError&&(console.error("Injection error:",chrome.runtime.lastError.message),chrome.scripting.executeScript({target:{tabId:s.id},function:o,args:["Failed to open PromptStash: "+chrome.runtime.lastError.message]}))})):(console.error("Tab URL not supported:",s.url),void chrome.scripting.executeScript({target:{tabId:s.id},function:o,args:[`PromptStash is only supported on ${t}. Please navigate to a supported site.`]})))),chrome.runtime.onMessage.addListener(((s,n,c)=>{if("closePopup"===s.action)chrome.tabs.query({active:!0,currentWindow:!0},(e=>{e[0]&&chrome.scripting.executeScript({target:{tabId:e[0].id},function:()=>{const e=document.getElementById("promptstash-popup");e&&e.remove()}},(()=>{chrome.runtime.lastError&&console.error("Close popup error:",chrome.runtime.lastError.message),chrome.storage.local.set({isFullscreen:!1},(()=>{chrome.runtime.lastError&&console.error("Storage error:",chrome.runtime.lastError.message)}))}))}));else if("toggleFullscreen"===s.action)chrome.storage.local.get(["isFullscreen"],(e=>{const t=e.isFullscreen;chrome.tabs.query({active:!0,currentWindow:!0},(e=>{e[0]&&chrome.scripting.executeScript({target:{tabId:e[0].id},function:e=>{console.log("logged from background.js: value of isFullscreen passed as arg:",e);const t=document.getElementById("promptstash-popup");if(t){const r=window.innerWidth<=768;Object.assign(t.style,{width:e||r?"100vw":"50vw",height:e||r?"100vh":"96vh",left:e||r?"0":.49*window.innerWidth+"px",top:e||r?"0":"2vh",borderRadius:e?"0":"10px",boxShadow:e?"none":"0 4px 15px rgba(0, 0, 0, 0.2)",transition:"width 0.3s ease, height 0.3s ease, top 0.3s ease, left 0.3s ease"})}},args:[t]},(()=>{chrome.runtime.lastError&&console.error("Fullscreen toggle error:",chrome.runtime.lastError.message)}))}))}));else{if("getTargetTabId"===s.action)return chrome.tabs.query({active:!0,currentWindow:!0},(r=>{r[0]&&!r[0].url.match(/^(chrome|file|about):\/\//)?e.some((e=>new RegExp(`^${e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}.*`).test(r[0].url)))?c({tabId:r[0].id}):(console.error("Tab URL not supported:",r[0].url),chrome.scripting.executeScript({target:{tabId:r[0].id},function:o,args:[`PromptStash is only supported on ${t}. Please navigate to a supported site.`]}),c({tabId:null})):(console.error("Restricted URL:",r[0]?.url||"No active tab"),chrome.scripting.executeScript({target:{tabId:r[0]?.id},function:o,args:[`PromptStash cannot be used on restricted URLs (e.g., chrome://, file://, about://). Please navigate to a supported AI platform (e.g., ${t.replace(", and ",", or ")}).`]}),c({tabId:null}))})),!0;if("reInjectContentScript"===s.action)return chrome.scripting.executeScript({target:{tabId:s.tabId},files:["content.js"]},(()=>{chrome.runtime.lastError?(console.error("Content script re-injection error:",chrome.runtime.lastError.message),c({success:!1})):c({success:!0})})),!0;"togglePopup"===s.action?chrome.storage.local.set({openWithSearch:!1},(()=>{chrome.tabs.query({active:!0,currentWindow:!0},(e=>{e[0]&&chrome.scripting.executeScript({target:{tabId:e[0].id},function:r})}))})):"ping"===s.action&&c({status:"alive"})}}))})();