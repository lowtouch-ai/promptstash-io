(()=>{const e=["https://grok.com/","https://chatgpt.com/","https://www.perplexity.ai/","https://gemini.google.com/","https://claude.ai/"],t="grok.com, chatgpt.com, perplexity.ai, gemini.google.com, and claude.ai";function r(){let e=document.getElementById("promptstash-popup");if(e)e.resizeListener&&window.removeEventListener("resize",e.resizeListener),e.remove();else{function t(t){const r=window.innerWidth>767,o=window.innerWidth<400,n=t||o;Object.assign(e.style,{width:n?"100vw":r?"50vw":"383.5px",height:n?"100vh":"96vh",position:"absolute",right:n?"0":"8px",top:n?"0":"8px",zIndex:"10000",backgroundColor:"none",border:"2px solid #8888",borderRadius:n?"0":"10px",boxShadow:n?"none":"0 4px 15px rgba(0, 0, 0, 0.2)",overflow:"hidden",transition:"width 0.3s ease, height 0.3s ease, top 0.3s ease, right 0.3s ease"})}e=document.createElement("div"),e.id="promptstash-popup",e.innerHTML=`\n      <iframe src="${chrome.runtime.getURL("popup.html")}" style="width: 100%; height: 100%; border: none;"></iframe>\n    `,document.body.appendChild(e),e.style.userSelect="none",e.style.webkitUserSelect="none",Array.from(e.querySelectorAll("*")).forEach((e=>{e.setAttribute("disabled","true"),e.style.pointerEvents="none"})),setTimeout((()=>{Array.from(e.querySelectorAll("*")).forEach((e=>{e.removeAttribute("disabled"),e.style.pointerEvents=""})),e.style.pointerEvents="auto"}),250),chrome.storage.local.get(["isFullscreen"],(e=>{t(e.isFullscreen||!1)}));const r=function(){let e;return function(...r){clearTimeout(e),e=setTimeout((()=>{clearTimeout(e),(()=>{document.getElementById("promptstash-popup")&&chrome.storage.local.get(["isFullscreen"],(e=>{t(e.isFullscreen||!1)}))})(...r)}),10)}}();window.addEventListener("resize",r),e.resizeListener=r;const o=e=>{if("Escape"===e.key){const e=document.getElementById("promptstash-popup");e&&(e.resizeListener&&window.removeEventListener("resize",e.resizeListener),e.remove(),document.removeEventListener("keydown",o))}};document.addEventListener("keydown",o);const n=e=>{const t=document.getElementById("promptstash-popup");t&&!t.contains(e.target)&&(t.resizeListener&&window.removeEventListener("resize",t.resizeListener),t.remove(),document.removeEventListener("click",n))};document.addEventListener("click",n)}}function o(e){let t=document.getElementById("promptstash-toast");t&&t.remove(),t=document.createElement("div"),t.id="promptstash-toast",t.className="promptstash-toast",t.textContent=e,document.body.appendChild(t),Object.assign(t.style,{position:"fixed",top:"20px",right:"20px",padding:"10px 20px",borderRadius:"6px",background:"#fdd",color:"#800",zIndex:"10001",opacity:"0",transform:"translateY(-20px)",transition:"opacity 0.3s ease, transform 0.3s ease"}),setTimeout((()=>{t.style.opacity="1",t.style.transform="translateY(0)"}),10),setTimeout((()=>{t.style.opacity="0",t.style.transform="translateY(-20px)",setTimeout((()=>t.remove()),300)}),3e3)}setInterval((()=>{chrome.tabs.query({active:!0,currentWindow:!0},(e=>{e[0]&&!e[0].url.match(/^(chrome|file|about):\/\//)&&chrome.tabs.sendMessage(e[0].id,{action:"ping"},(t=>{chrome.runtime.lastError&&chrome.scripting.executeScript({target:{tabId:e[0].id},files:["content.js"]},(()=>{chrome.runtime.lastError&&console.error("Periodic content script injection error:",chrome.runtime.lastError.message)}))}))}))}),3e5),chrome.action.onClicked.addListener((n=>n.url.match(/^(chrome|file|about):\/\//)?(console.error("Cannot inject into restricted URLs:",n.url),void chrome.scripting.executeScript({target:{tabId:n.id},function:o,args:[`PromptStash cannot be used on restricted URLs (e.g., chrome://, file://, about://). Please navigate to a supported AI platform (e.g., ${t.replace(", and ",", or ")}).`]})):e.some((e=>new RegExp(`^${e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}.*`).test(n.url)))?void chrome.scripting.executeScript({target:{tabId:n.id},function:r},(()=>{chrome.runtime.lastError&&(console.error("Injection error:",chrome.runtime.lastError.message),chrome.scripting.executeScript({target:{tabId:n.id},function:o,args:["Failed to open PromptStash: "+chrome.runtime.lastError.message]}))})):(console.error("Tab URL not supported:",n.url),void chrome.scripting.executeScript({target:{tabId:n.id},function:o,args:[`PromptStash is only supported on ${t}. Please navigate to a supported site.`]})))),chrome.runtime.onMessage.addListener(((n,s,i)=>{if("closePopup"===n.action)chrome.tabs.query({active:!0,currentWindow:!0},(e=>{e[0]&&chrome.scripting.executeScript({target:{tabId:e[0].id},function:()=>{const e=document.getElementById("promptstash-popup");e.resizeListener&&window.removeEventListener("resize",e.resizeListener),e&&e.remove()}},(()=>{chrome.runtime.lastError&&console.error("Close popup error:",chrome.runtime.lastError.message)}))}));else if("toggleFullscreen"===n.action)chrome.storage.local.get(["isFullscreen"],(e=>{const t=e.isFullscreen;chrome.tabs.query({active:!0,currentWindow:!0},(e=>{e[0]&&chrome.scripting.executeScript({target:{tabId:e[0].id},function:e=>{const t=document.getElementById("promptstash-popup");if(t){const r=window.innerWidth>767,o=window.innerWidth<400,n=e||o;Object.assign(t.style,{width:n?"100vw":r?"50vw":"383.5px",height:n?"100vh":"96vh",right:n?"0":"8px",top:n?"0":"8px",borderRadius:n?"0":"10px",boxShadow:n?"none":"0 4px 15px rgba(0, 0, 0, 0.2)",transition:"width 0.3s ease, height 0.3s ease, top 0.3s ease, left 0.3s ease"})}},args:[t]},(()=>{chrome.runtime.lastError&&console.error("Fullscreen toggle error:",chrome.runtime.lastError.message)}))}))}));else{if("getTargetTabId"===n.action)return chrome.tabs.query({active:!0,currentWindow:!0},(r=>{r[0]&&!r[0].url.match(/^(chrome|file|about):\/\//)?e.some((e=>new RegExp(`^${e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}.*`).test(r[0].url)))?i({tabId:r[0].id}):(console.error("Tab URL not supported:",r[0].url),chrome.scripting.executeScript({target:{tabId:r[0].id},function:o,args:[`PromptStash is only supported on ${t}. Please navigate to a supported site.`]}),i({tabId:null})):(console.error("Restricted URL:",r[0]?.url||"No active tab"),chrome.scripting.executeScript({target:{tabId:r[0]?.id},function:o,args:[`PromptStash cannot be used on restricted URLs (e.g., chrome://, file://, about://). Please navigate to a supported AI platform (e.g., ${t.replace(", and ",", or ")}).`]}),i({tabId:null}))})),!0;if("reInjectContentScript"===n.action)return chrome.scripting.executeScript({target:{tabId:n.tabId},files:["content.js"]},(()=>{chrome.runtime.lastError?(console.error("Content script re-injection error:",chrome.runtime.lastError.message),i({success:!1})):i({success:!0})})),!0;"togglePopup"===n.action?chrome.storage.local.set({openWithSearch:!1},(()=>{chrome.tabs.query({active:!0,currentWindow:!0},(e=>{e[0]&&chrome.scripting.executeScript({target:{tabId:e[0].id},function:r})}))})):"ping"===n.action&&i({status:"alive"})}}))})();