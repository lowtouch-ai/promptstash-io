(()=>{function e(){const e="promptstash-popup";let t=document.getElementById(e);t?t.remove():(t=document.createElement("div"),t.id=e,t.innerHTML=`\n      <iframe src="${chrome.runtime.getURL("popup.html")}" style="width: 100%; height: 100%; border: none;"></iframe>\n    `,document.body.appendChild(t),chrome.storage.local.get(["isFullscreen"],(e=>{const r=e.isFullscreen||!1,o=window.innerWidth<=768,s=r||o?"100vw":"50vw",n=r||o?"100vh":"96vh",a=r||o?"0":.49*window.innerWidth+"px",c=r||o?"0":"2vh";Object.assign(t.style,{width:s,height:n,position:"absolute",top:c,left:a,zIndex:"10000",backgroundColor:"none",border:"2px solid #8888",borderRadius:r?"0":"10px",boxShadow:r?"none":"0 4px 15px rgba(0, 0, 0, 0.2)",overflow:"hidden",transition:"width 0.3s ease, height 0.3s ease, top 0.3s ease, left 0.3s ease"})})),document.addEventListener("keydown",(e=>{"Escape"===e.key&&t&&(t.remove(),chrome.storage.local.set({isFullscreen:!1}))})),document.addEventListener("click",(e=>{const r=document.getElementById("promptstash-widget");!t||t.contains(e.target)||r.contains(e.target)||(t.remove(),console.log("Is widget targeted (background):"+!r.contains(e.target)),chrome.storage.local.set({isFullscreen:!1}))})))}function t(e){let t=document.getElementById("promptstash-toast");t&&t.remove(),t=document.createElement("div"),t.id="promptstash-toast",t.className="promptstash-toast",t.textContent=e,document.body.appendChild(t),Object.assign(t.style,{position:"fixed",top:"20px",right:"20px",padding:"10px 20px",borderRadius:"6px",background:"#fdd",color:"#800",zIndex:"10001",opacity:"0",transform:"translateY(-20px)",transition:"opacity 0.3s ease, transform 0.3s ease"}),setTimeout((()=>{t.style.opacity="1",t.style.transform="translateY(0)"}),10),setTimeout((()=>{t.style.opacity="0",t.style.transform="translateY(-20px)",setTimeout((()=>t.remove()),300)}),3e3)}chrome.action.onClicked.addListener((r=>r.url.match(/^(chrome|file|about):\/\//)?(console.error("Cannot inject into restricted URLs:",r.url),void chrome.scripting.executeScript({target:{tabId:r.id},function:t,args:["PromptStash cannot be used on restricted URLs (e.g., chrome://, file://, about://). Please navigate to a supported AI platform (e.g., grok.com, perplexity.ai, or chatgpt.com)."]})):["https://grok.com/","https://www.perplexity.ai/","https://chatgpt.com/"].some((e=>new RegExp(`^${e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}.*`).test(r.url)))?void chrome.scripting.executeScript({target:{tabId:r.id},function:e},(()=>{chrome.runtime.lastError&&(console.error("Injection error:",chrome.runtime.lastError.message),chrome.scripting.executeScript({target:{tabId:r.id},function:t,args:["Failed to open PromptStash: "+chrome.runtime.lastError.message]}))})):(console.error("Tab URL not supported:",r.url),void chrome.scripting.executeScript({target:{tabId:r.id},function:t,args:["PromptStash is only supported on grok.com, perplexity.ai, and chatgpt.com. Please navigate to a supported site."]})))),chrome.runtime.onMessage.addListener(((r,o,s)=>{if("closePopup"===r.action)chrome.tabs.query({active:!0,currentWindow:!0},(e=>{e[0]&&chrome.scripting.executeScript({target:{tabId:e[0].id},function:()=>{const e=document.getElementById("promptstash-popup");e&&e.remove()}},(()=>{chrome.runtime.lastError&&console.error("Close popup error:",chrome.runtime.lastError.message),chrome.storage.local.set({isFullscreen:!1},(()=>{chrome.runtime.lastError&&console.error("Storage error:",chrome.runtime.lastError.message)}))}))}));else if("toggleFullscreen"===r.action)chrome.storage.local.get(["isFullscreen"],(e=>{console.log("after get in background.js:",e.isFullscreen);const t=!e.isFullscreen;console.log("after swap in background.js:",t),chrome.storage.local.set({isFullscreen:t},(()=>{console.log("after set in background.js:",t),chrome.runtime.lastError?console.error("Storage set error:",chrome.runtime.lastError.message):chrome.tabs.query({active:!0,currentWindow:!0},(e=>{e[0]&&chrome.scripting.executeScript({target:{tabId:e[0].id},function:e=>{console.log("passing as arg in background.js:",e);const t=document.getElementById("promptstash-popup");if(t){const r=window.innerWidth<=768;Object.assign(t.style,{width:e||r?"100vw":"50vw",height:e||r?"100vh":"96vh",left:e||r?"0":.49*window.innerWidth+"px",top:e||r?"0":"2vh",borderRadius:e?"0":"10px",boxShadow:e?"none":"0 4px 15px rgba(0, 0, 0, 0.2)",transition:"width 0.3s ease, height 0.3s ease, top 0.3s ease, left 0.3s ease"})}},args:[t]},(()=>{chrome.runtime.lastError&&console.error("Fullscreen toggle error:",chrome.runtime.lastError.message)}))}))}))}));else{if("getTargetTabId"===r.action)return chrome.tabs.query({active:!0,currentWindow:!0},(e=>{e[0]&&!e[0].url.match(/^(chrome|file|about):\/\//)?["https://grok.com/","https://www.perplexity.ai/","https://chatgpt.com/"].some((t=>new RegExp(`^${t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}.*`).test(e[0].url)))?s({tabId:e[0].id}):(console.error("Tab URL not supported:",e[0].url),chrome.scripting.executeScript({target:{tabId:e[0].id},function:t,args:["PromptStash is only supported on grok.com, perplexity.ai, and chatgpt.com. Please navigate to a supported site."]}),s({tabId:null})):(console.error("Restricted URL:",e[0]?.url||"No active tab"),chrome.scripting.executeScript({target:{tabId:e[0]?.id},function:t,args:["PromptStash cannot be used on restricted URLs (e.g., chrome://, file://, about://). Please navigate to a supported AI platform (e.g., grok.com, perplexity.ai, or chatgpt.com)."]}),s({tabId:null}))})),!0;if("reInjectContentScript"===r.action)return chrome.scripting.executeScript({target:{tabId:r.tabId},files:["content.js"]},(()=>{chrome.runtime.lastError?(console.error("Content script re-injection error:",chrome.runtime.lastError.message),s({success:!1})):(console.log("Content script re-injected successfully"),s({success:!0}))})),!0;"togglePopup"===r.action&&chrome.storage.local.set({openWithSearch:!1},(()=>{chrome.tabs.query({active:!0,currentWindow:!0},(t=>{t[0]&&chrome.scripting.executeScript({target:{tabId:t[0].id},function:e})}))}))}}))})();