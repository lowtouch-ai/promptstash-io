(()=>{function e(){const e="promptstash-popup";let r=document.getElementById(e);r?r.remove():(r=document.createElement("div"),r.id=e,r.innerHTML=`\n      <iframe src="${chrome.runtime.getURL("popup.html")}" style="width: 100%; height: 100%; border: none;"></iframe>\n    `,document.body.appendChild(r),chrome.storage.local.get(["isFullscreen"],(e=>{const t=e.isFullscreen||!1,o=window.innerWidth<=768,n=t||o?"100vw":"50vw",s=t||o?"100vh":"96vh",i=t||o?"0":.49*window.innerWidth+"px",c=t||o?"0":"2vh";Object.assign(r.style,{width:n,height:s,position:"absolute",top:c,left:i,zIndex:"10000",backgroundColor:"none",border:"2px solid #8888",borderRadius:t?"0":"10px",boxShadow:t?"none":"0 4px 15px rgba(0, 0, 0, 0.2)",overflow:"hidden",transition:"width 0.3s ease, height 0.3s ease, top 0.3s ease, left 0.3s ease"})})),document.addEventListener("keydown",(e=>{"Escape"===e.key&&r&&r.remove()})),document.addEventListener("click",(e=>{r&&!r.contains(e.target)&&r.remove()})))}chrome.action.onClicked.addListener((r=>{if(r.url.startsWith("chrome://"))return console.error("Cannot inject into chrome:// URLs"),void alert("Cannot inject into chrome:// URLs");chrome.scripting.executeScript({target:{tabId:r.id},function:e},(()=>{chrome.runtime.lastError&&console.error("Injection error:",chrome.runtime.lastError.message)}))})),chrome.runtime.onMessage.addListener(((e,r,t)=>{if("closePopup"===e.action)chrome.tabs.query({active:!0,currentWindow:!0},(e=>{e[0]&&(chrome.scripting.executeScript({target:{tabId:e[0].id},function:()=>{const e=document.getElementById("promptstash-popup");e&&e.remove()}},(()=>{chrome.runtime.lastError&&console.error("Close popup error:",chrome.runtime.lastError.message),chrome.storage.local.set({isFullscreen:!1},(()=>{chrome.runtime.lastError&&console.error("Storage error:",chrome.runtime.lastError.message)}))})),chrome.storage.local.set({isFullscreen:!1}))}));else if("toggleFullscreen"===e.action)chrome.storage.local.get(["isFullscreen"],(e=>{const r=!e.isFullscreen;chrome.storage.local.set({isFullscreen:r},(()=>{chrome.tabs.query({active:!0,currentWindow:!0},(e=>{e[0]&&chrome.scripting.executeScript({target:{tabId:e[0].id},function:e=>{const r=document.getElementById("promptstash-popup");if(r){const t=window.innerWidth<=768;Object.assign(r.style,{width:e||t?"100vw":"50vw",height:e||t?"100vh":"96vh",left:e||t?"0":.49*window.innerWidth+"px",top:e||t?"0":"2vh",borderRadius:e?"0":"10px",boxShadow:e?"none":"0 4px 15px rgba(0, 0, 0, 0.2)",transition:"width 0.3s ease, height 0.3s ease, top 0.3s ease, left 0.3s ease",transform:"none"})}},args:[r]},(()=>{chrome.runtime.lastError&&console.error("Fullscreen toggle error:",chrome.runtime.lastError.message)}))}))}))}));else{if("getTargetTabId"===e.action)return chrome.tabs.query({active:!0,currentWindow:!0},(e=>{e[0]&&!e[0].url.startsWith("chrome://")?t({tabId:e[0].id}):t({tabId:null})})),!0;if("reInjectContentScript"===e.action)return chrome.scripting.executeScript({target:{tabId:e.tabId},files:["content.js"]},(()=>{chrome.runtime.lastError?(console.error("Content script re-injection error:",chrome.runtime.lastError.message),t({success:!1})):(console.log("Content script re-injected successfully"),t({success:!0}))})),!0}}))})();