(()=>{"use strict";const e=[{name:"Business Analyst Report",tags:"analysis, report, business",type:"pre-built",content:"# Your Role\nBusiness Analyst\n\n# Your Task\nAnalyze the provided data and generate a concise report.\n\n# Relevant Background Information\nUse formal tone, focus on key metrics.\n\n# Output Format\nExecutive summary (200 words), followed by bullet points.",favorite:!1},{name:"Code Debugging Assistant",tags:"coding, debug, tech",type:"pre-built",content:"# Your Role\nSenior Developer\n\n# Your Task\nIdentify and fix bugs in the provided code snippet.\n\n# Relevant Background Information\nCode is in Python, prioritize efficiency.\n\n# Output Format\nExplanation of issue, corrected code block.",favorite:!1},{name:"Content Generator",tags:"marketing, content, quick",type:"pre-built",content:"# Your Role\nContent Writer\n\n# Your Task\nWrite a 500-word blog post on the given topic.\n\n# Relevant Background Information\nCasual tone, SEO-friendly.\n\n# Output Format\nTitle, intro, 3 sections, conclusion.",favorite:!1}];document.addEventListener("DOMContentLoaded",(()=>{const t={searchBox:document.getElementById("searchBox"),typeSelect:document.getElementById("typeSelect"),dropdownResults:document.getElementById("dropdownResults"),templateName:document.getElementById("templateName"),templateTags:document.getElementById("templateTags"),promptArea:document.getElementById("promptArea"),fetchBtn:document.getElementById("fetchBtn"),saveBtn:document.getElementById("saveBtn"),saveAsBtn:document.getElementById("saveAsBtn"),deleteBtn:document.getElementById("deleteBtn"),clearPrompt:document.getElementById("clearPrompt"),clearTags:document.getElementById("clearTags"),sendBtn:document.getElementById("sendBtn"),clearSearch:document.getElementById("clearSearch"),themeToggle:document.getElementById("themeToggle"),favoriteSuggestions:document.getElementById("favoriteSuggestions"),fullscreenToggle:document.getElementById("fullscreenToggle"),closeBtn:document.getElementById("closeBtn"),toast:document.getElementById("toast"),renameBtn:document.getElementById("renameBtn"),confirmRename:document.getElementById("confirmRename"),cancelRename:document.getElementById("cancelRename"),favoriteStar:document.getElementById("favoriteStar")};if(Object.values(t).some((e=>!e)))return void console.error("One or more DOM elements not found");let a=null,n="light",o=null,s=0;function r(){chrome.storage.local.set({sidebarState:{name:t.templateName.value,tags:t.templateTags.value,content:t.promptArea.value,selectedName:a},theme:n,nextIndex:s})}function l(){o={name:t.templateName.value,tags:t.templateTags.value,content:t.promptArea.value,selectedName:a,templates:null}}function m(e){t.toast.textContent=e,t.toast.classList.add("show"),setTimeout((()=>t.toast.classList.remove("show")),3e3)}function c(){const e=document.querySelector("header"),a=document.querySelector(".search-select"),n=(document.querySelector(".template"),document.querySelector("#buttons")),o=window.innerHeight-e.offsetHeight-a.offsetHeight-n.offsetHeight-40;t.promptArea.style.height=`${Math.max(100,o)}px`}function i(e){return e?e.split(",").map((e=>e.trim().replace(/\s+/g,""))).filter((e=>e)).join(", "):""}function d(n,o=""){chrome.storage.sync.get(["templates"],(s=>{let l=s.templates||e.map(((e,t)=>({...e,index:t})));t.dropdownResults.innerHTML="",t.favoriteSuggestions.innerHTML="";let m=l.filter((e=>"all"===n||e.type===n));o&&(m=m.filter((e=>e.name.toLowerCase().includes(o)||e.tags.toLowerCase().includes(o))),m.sort(((e,t)=>{const a=e.name.toLowerCase().indexOf(o)+e.tags.toLowerCase().indexOf(o),n=t.name.toLowerCase().indexOf(o)+t.tags.toLowerCase().indexOf(o);return a!==n?a-n:e.name.localeCompare(t.name)}))),m.sort(((e,t)=>(t.favorite||0)-(e.favorite||0))),m.forEach((e=>{const n=document.createElement("div");n.textContent=(e.favorite,`${e.name} (${e.tags})`),n.setAttribute("role","option"),n.setAttribute("aria-selected",a===e.name),n.addEventListener("click",(n=>{n.target.classList.contains("favorite-toggle")||(a=e.name,t.templateName.value=e.name,t.templateTags.value=e.tags,t.promptArea.value=e.content,t.searchBox.value="",t.dropdownResults.innerHTML="",t.templateName.setAttribute("readonly","true"),t.renameBtn.classList.remove("d-none"),t.confirmRename.classList.add("d-none"),t.cancelRename.classList.add("d-none"),r(),t.promptArea.focus())})),n.innerHTML+=`<button class="favorite-toggle ${e.favorite?"favorited":"unfavorited"}" data-name="${e.name}" aria-label="${e.favorite?"Unfavorite":"Favorite"} template">${e.favorite?"★":"☆"}</button>`,t.dropdownResults.appendChild(n)}));const c=l.filter((e=>e.favorite));c.length>0?(t.favoriteStar.classList.remove("d-none"),t.favoriteSuggestions.classList.remove("d-none"),c.forEach((e=>{const n=document.createElement("span");n.textContent=e.name,n.className="favorite-suggestion",n.setAttribute("role","button"),n.setAttribute("tabindex","0"),n.addEventListener("click",(()=>{a=e.name,t.templateName.value=e.name,t.templateTags.value=e.tags,t.promptArea.value=e.content,t.searchBox.value="",r(),t.promptArea.focus()})),n.addEventListener("keydown",(e=>{"Enter"!==e.key&&" "!==e.key||n.click()})),t.favoriteSuggestions.appendChild(n)}))):(t.favoriteStar.classList.add("d-none"),t.favoriteSuggestions.classList.add("d-none"))}))}function u(e,t,a=!1){const n=function(e){const t=JSON.stringify(e),a=(new TextEncoder).encode(t).length;return{isValid:a<=8192,size:a}}({templates:e});n.isValid?chrome.storage.sync.set({templates:e},(()=>{chrome.runtime.lastError?(m("Failed to save template: "+chrome.runtime.lastError.message),console.error("Sync storage error:",chrome.runtime.lastError)):(m(a?"Template saved. Press Ctrl+Z to undo.":"Template updated. Press Ctrl+Z to undo."),t())})):confirm(`Template size (${(n.size/1024).toFixed(2)} KB) exceeds sync storage limit (8 KB).\nWould you like to save it to local storage instead?`)?chrome.storage.local.set({templates:e},(()=>{chrome.runtime.lastError?(m("Failed to save template to local storage: "+chrome.runtime.lastError.message),console.error("Local storage error:",chrome.runtime.lastError)):(m(a?"Template saved to local storage. Press Ctrl+Z to undo.":"Template updated in local storage. Press Ctrl+Z to undo."),t())})):m("Template too large to save. Consider removing less relevant parts or saving to local storage.")}chrome.storage.local.get(["sidebarState","theme","nextIndex"],(o=>{const r=o.sidebarState||{};t.templateName.value=r.name||"",t.templateTags.value=r.tags||"",t.promptArea.value=r.content||"",a=r.selectedName||null,n=o.theme||"light",s=o.nextIndex||e.length,document.body.className=n,c()})),t.themeToggle.addEventListener("click",(()=>{n="light"===n?"dark":"light",document.body.className=n,r()})),t.fullscreenToggle.addEventListener("click",(()=>{r(),chrome.runtime.sendMessage({action:"toggleFullscreen"})})),t.closeBtn.addEventListener("click",(()=>{chrome.runtime.sendMessage({action:"closeSidebar"})})),t.clearSearch.addEventListener("click",(()=>{t.searchBox.value="",d(t.typeSelect.value),t.searchBox.focus()})),document.addEventListener("keydown",(e=>{"Escape"===e.key&&chrome.runtime.sendMessage({action:"closeSidebar"})})),t.promptArea.addEventListener("keydown",(e=>{if("Tab"===e.key){e.preventDefault();const a=t.promptArea.selectionStart,n=t.promptArea.selectionEnd,o=t.promptArea.value;t.promptArea.value=o.substring(0,a)+"  "+o.substring(n),t.promptArea.selectionStart=t.promptArea.selectionEnd=a+2,r()}})),t.promptArea.addEventListener("input",(()=>{l(),r()})),t.templateTags.addEventListener("input",(()=>{l();let e=t.templateTags.value.trim();if(e){const a=e.split(",").map((e=>e.trim().replace(/\s+/g,"")));e=a.filter((e=>e)).join(", "),t.templateTags.value=e}r()})),t.clearTags.addEventListener("click",(()=>{l(),t.templateTags.value="",r()})),t.searchBox.addEventListener("click",(e=>{e.stopPropagation(),d(t.typeSelect.value,t.searchBox.value.toLowerCase())})),t.searchBox.addEventListener("input",(()=>{d(t.typeSelect.value,t.searchBox.value.toLowerCase())})),t.typeSelect.addEventListener("change",(()=>{d(t.typeSelect.value,t.searchBox.value.toLowerCase())})),document.addEventListener("click",(e=>{t.searchBox.contains(e.target)||t.dropdownResults.contains(e.target)||t.themeToggle.contains(e.target)||(t.dropdownResults.innerHTML=""),t.typeSelect.contains(e.target)||t.typeSelect.blur()})),t.saveBtn.addEventListener("click",(()=>{a?chrome.storage.sync.get(["templates"],(n=>{let s=n.templates||e.map(((e,t)=>({...e,index:t})));const c=s.find((e=>e.name===a));if(!c)return void alert("Selected template not found.");if(i(t.templateTags.value)===c.tags&&t.promptArea.value===c.content)return void m("No changes to save.");l(),o.templates=[...s];const p="pre-built"===c.type;if(!confirm(`Are you sure you want to edit the content/tags of "${a}"?${p?"\nThis is a pre-built template.":""}`))return;const g=s.findIndex((e=>e.name===a));s[g]={name:a,tags:i(t.templateTags.value),content:t.promptArea.value,type:c.type,favorite:c.favorite||!1,index:c.index},u(s,(()=>{d(t.typeSelect.value),r()}))})):alert("Please select a template to save changes.")})),t.saveAsBtn.addEventListener("click",(()=>{chrome.storage.sync.get(["templates"],(n=>{const c=n.templates||e.map(((e,t)=>({...e,index:t})));let p="New Template",g=1;for(;c.some((e=>e.name===p));)p="New Template "+g++;let v=prompt("Enter template name (required):",p);if(null===v)return;if(v=v.trim(),!v)return void m("Name is mandatory.");if(c.some((e=>e.name===v)))return void m("Name already exists.");let f=prompt("Enter tags (optional, comma-separated):",t.templateTags.value);null===f&&(f="");const y=i(f);!function(n,m){chrome.storage.sync.get(["templates"],(c=>{let i=c.templates||e.map(((e,t)=>({...e,index:t})));if(l(),o.templates=[...i],!confirm(`Save as new template "${n}"?`))return;const p={name:n,tags:m,content:t.promptArea.value,type:"custom",favorite:!1,index:s++};i.push(p),u(i,(()=>{a=n,t.templateName.value=n,d(t.typeSelect.value),r()}),!0)}))}(v,y)}))})),t.fetchBtn.addEventListener("click",(()=>{chrome.tabs.query({active:!0,currentWindow:!0},(e=>{chrome.tabs.sendMessage(e[0].id,{action:"getPrompt"},(e=>{e&&e.prompt&&(l(),t.promptArea.value=e.prompt,r())}))}))})),t.sendBtn.addEventListener("click",(()=>{chrome.tabs.query({active:!0,currentWindow:!0},(e=>{chrome.tabs.sendMessage(e[0].id,{action:"sendPrompt",prompt:t.promptArea.value},(()=>{chrome.runtime.sendMessage({action:"closeSidebar"})}))}))})),t.deleteBtn.addEventListener("click",(()=>{a?chrome.storage.sync.get(["templates"],(n=>{const s=n.templates||e.map(((e,t)=>({...e,index:t}))),c="pre-built"===s.find((e=>e.name===a)).type;if(!confirm(`Are you sure you want to delete "${a}"?${c?"\nThis is a pre-built template.":""}`))return;l(),o.templates=[...s];const i=s.findIndex((e=>e.name===a));s.splice(i,1),chrome.storage.sync.set({templates:s},(()=>{m("Template deleted. Press Ctrl+Z to undo."),a=null,t.templateName.value="",t.templateTags.value="",t.promptArea.value="",t.searchBox.value="",d(t.typeSelect.value),r()}))})):alert("Please select a template to delete.")})),document.addEventListener("keydown",(e=>{e.ctrlKey&&"z"===e.key&&o&&(t.templateName.value=o.name||"",t.templateTags.value=o.tags||"",t.promptArea.value=o.content||"",a=o.selectedName||null,o.templates&&chrome.storage.sync.set({templates:o.templates},(()=>{d(t.typeSelect.value)})),m("Action undone."),o=null,r())})),t.clearPrompt.addEventListener("click",(()=>{l(),t.promptArea.value="",r()})),document.addEventListener("click",(a=>{if(a.target.classList.contains("favorite-toggle")){const n=a.target.dataset.name;chrome.storage.sync.get(["templates"],(a=>{const o=a.templates||e.map(((e,t)=>({...e,index:t}))),s=o.find((e=>e.name===n));s&&(s.favorite=!s.favorite,chrome.storage.sync.set({templates:o},(()=>{d(t.typeSelect.value,t.searchBox.value.toLowerCase())})))}))}})),t.renameBtn.addEventListener("click",(()=>{a?(t.templateName.removeAttribute("readonly"),t.templateName.focus(),t.renameBtn.classList.add("d-none"),t.confirmRename.classList.remove("d-none"),t.cancelRename.classList.remove("d-none"),t.templateName.dataset.originalName=a):m("Please select a template to rename.")})),t.cancelRename.addEventListener("click",(()=>{const e=t.templateName.dataset.originalName;t.templateName.value=e,t.templateName.setAttribute("readonly","true"),t.renameBtn.classList.remove("d-none"),t.confirmRename.classList.add("d-none"),t.cancelRename.classList.add("d-none")})),t.confirmRename.addEventListener("click",(()=>{const n=t.templateName.value.trim(),o=t.templateName.dataset.originalName;if(n===o)return t.templateName.setAttribute("readonly","true"),t.renameBtn.classList.remove("d-none"),t.confirmRename.classList.add("d-none"),void t.cancelRename.classList.add("d-none");n?chrome.storage.sync.get(["templates"],(s=>{const r=s.templates||e.map(((e,t)=>({...e,index:t})));if(r.some((e=>e.name===n)))return void m("Name already exists.");const l=r.findIndex((e=>e.name===o));-1!==l?(r[l].name=n,chrome.storage.sync.set({templates:r},(()=>{m("Template renamed."),a=n,t.templateName.value=n,t.templateName.setAttribute("readonly","true"),t.renameBtn.classList.remove("d-none"),t.confirmRename.classList.add("d-none"),t.cancelRename.classList.add("d-none"),d(t.typeSelect.value)}))):m("Template not found.")})):m("Name is mandatory.")})),document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach((e=>new bootstrap.Tooltip(e,{delay:{show:100,hide:100}}))),t.dropdownResults.addEventListener("keydown",(e=>{const a=t.dropdownResults.querySelectorAll("div[role='option']"),n=document.activeElement;let o=Array.from(a).indexOf(n);"ArrowDown"===e.key?(e.preventDefault(),o=(o+1)%a.length,a[o].focus()):"ArrowUp"===e.key?(e.preventDefault(),o=(o-1+a.length)%a.length,a[o].focus()):"Enter"===e.key&&(e.preventDefault(),n.click())})),window.addEventListener("resize",c)})),elements.searchBox.addEventListener("input",(()=>{elements.clearSearch.style.display=elements.searchBox.value?"block":"none",loadTemplates(elements.typeSelect.value,elements.searchBox.value.toLowerCase())}))})();