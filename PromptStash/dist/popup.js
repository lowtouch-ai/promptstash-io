(()=>{"use strict";const e=[{name:"Business Analyst Report",tags:"analysis, report, business",type:"pre-built",content:"# Your Role\nBusiness Analyst\n\n# Your Task\nAnalyze the provided data and generate a concise report.\n\n# Relevant Background Information\nUse formal tone, focus on key metrics.\n\n# Output Format\nExecutive summary (200 words), followed by bullet points.",favorite:!1},{name:"Code Debugging Assistant",tags:"coding, debug, tech",type:"pre-built",content:"# Your Role\nSenior Developer\n\n# Your Task\nIdentify and fix bugs in the provided code snippet.\n\n# Relevant Background Information\nCode is in Python, prioritize efficiency.\n\n# Output Format\nExplanation of issue, corrected code block.",favorite:!1},{name:"Content Generator",tags:"marketing, content, quick",type:"pre-built",content:"# Your Role\nContent Writer\n\n# Your Task\nWrite a 500-word blog post on the given topic.\n\n# Relevant Background Information\nCasual tone, SEO-friendly.\n\n# Output Format\nTitle, intro, 3 sections, conclusion.",favorite:!1}];document.addEventListener("DOMContentLoaded",(()=>{const t={searchBox:document.getElementById("searchBox"),typeSelect:document.getElementById("typeSelect"),dropdownResults:document.getElementById("dropdownResults"),template:document.getElementById("template"),templateName:document.getElementById("templateName"),templateTags:document.getElementById("templateTags"),promptArea:document.getElementById("promptArea"),buttons:document.getElementById("buttons"),fetchBtn:document.getElementById("fetchBtn"),saveBtn:document.getElementById("saveBtn"),saveAsBtn:document.getElementById("saveAsBtn"),deleteBtn:document.getElementById("deleteBtn"),clearPrompt:document.getElementById("clearPrompt"),clearTags:document.getElementById("clearTags"),sendBtn:document.getElementById("sendBtn"),clearSearch:document.getElementById("clearSearch"),favoriteSuggestions:document.getElementById("favoriteSuggestions"),fullscreenToggle:document.getElementById("fullscreenToggle"),closeBtn:document.getElementById("closeBtn"),toast:document.getElementById("toast"),favoriteStar:document.getElementById("favoriteStar"),themeToggle:document.getElementById("themeToggle")},n=Object.entries(t).filter((([e,t])=>!t)).map((([e])=>e));n.length>0?(console.error("Missing DOM elements:",n),u("Extension UI failed to load. Please reload the extension.")):console.log("All DOM elements found:",Object.keys(t));let a,o,s=null,r="light",l=null,c=0,i=!1,m=[];function d(){chrome.storage.local.set({popupState:{name:t.templateName.value,tags:t.templateTags.value,content:t.promptArea.value,selectedName:s},theme:r,nextIndex:c}),chrome.storage.sync.set({recentIndices:m})}function p(){l={name:t.templateName.value,tags:t.templateTags.value,content:t.promptArea.value,selectedName:s,templates:null}}function u(e){t.toast.textContent=e,t.toast.classList.add("show"),setTimeout((()=>t.toast.classList.remove("show")),4e3)}function g(e){m.unshift(e),m=[...new Set(m)],m.length>20&&(m=m.slice(0,20)),d()}function v(e){return e?e.split(",").map((e=>e.trim().replace(/\s+/g,""))).filter((e=>e)).join(", "):""}function f(e){const t=setTimeout((()=>{u("No response from tab. Please activate a supported webpage."),e(null)}),5e3);chrome.runtime.sendMessage({action:"getTargetTabId"},(n=>{clearTimeout(t),n&&n.tabId?e(n.tabId):(u("No valid tab selected. Please activate a supported webpage."),e(null))}))}function y(n,a="",o=!1){chrome.storage.sync.get(["templates"],(r=>{let l=r.templates||e.map(((e,t)=>({...e,index:t})));t.dropdownResults.innerHTML="",t.favoriteSuggestions.innerHTML="";let c=l.filter((e=>"all"===n||e.type===n));a?(c=c.filter((e=>e.name.toLowerCase().includes(a)||e.tags.toLowerCase().includes(a))),c.sort(((e,t)=>{const n=e.name.toLowerCase().indexOf(a)+e.tags.toLowerCase().indexOf(a),o=t.name.toLowerCase().indexOf(a)+t.tags.toLowerCase().indexOf(a);return n!==o?n-o:e.name.localeCompare(t.name)}))):c.sort(((e,t)=>{const n=m.indexOf(e.index),a=m.indexOf(t.index);return-1===n&&-1===a?e.name.localeCompare(t.name):-1===n?1:-1===a?-1:n-a})),o&&c.forEach(((e,n)=>{const a=document.createElement("div");a.textContent=(e.favorite,`${e.name} (${e.tags})`),a.setAttribute("role","option"),a.setAttribute("aria-selected",s===e.name),a.addEventListener("click",(n=>{n.target.classList.contains("favorite-toggle")||(s=e.name,t.templateName.value=e.name,t.templateTags.value=e.tags,t.promptArea.value=e.content,t.searchBox.value="",t.dropdownResults.innerHTML="",t.fetchBtn.style.display=e.content?"none":"block",d(),t.promptArea.focus())})),a.innerHTML+=`<button class="favorite-toggle ${e.favorite?"favorited":"unfavorited"}" data-name="${e.name}" aria-label="${e.favorite?"Unfavorite":"Favorite"} template">${e.favorite?"★":"☆"}</button>`,t.dropdownResults.appendChild(a)}));const i=l.filter((e=>e.favorite));i.length>0?(i.sort(((e,t)=>{const n=m.indexOf(e.index),a=m.indexOf(t.index);return-1===n&&-1===a?e.name.localeCompare(t.name):-1===n?1:-1===a?-1:n-a})),t.favoriteStar.classList.remove("d-none"),t.favoriteSuggestions.classList.remove("d-none"),i.forEach((e=>{const n=document.createElement("span");n.textContent=e.name,n.className="favorite-suggestion",n.setAttribute("role","button"),n.setAttribute("tabindex","0"),n.addEventListener("click",(()=>{s=e.name,t.templateName.value=e.name,t.templateTags.value=e.tags,t.promptArea.value=e.content,t.searchBox.value="",t.fetchBtn.style.display=e.content?"none":"block",d(),t.promptArea.focus()})),n.addEventListener("keydown",(e=>{"Enter"!==e.key&&" "!==e.key||n.click()})),t.favoriteSuggestions.appendChild(n)}))):(t.favoriteStar.classList.add("d-none"),t.favoriteSuggestions.classList.add("d-none"))}))}function h(e,t,n=!1){const a=function(e){const t=JSON.stringify(e),n=(new TextEncoder).encode(t).length;return{isValid:n<=8192,size:n}}({templates:e});a.isValid?chrome.storage.sync.set({templates:e},(()=>{chrome.runtime.lastError?(u("Failed to save template: "+chrome.runtime.lastError.message),console.error("Sync storage error:",chrome.runtime.lastError)):(u(n?"Template saved. Press Ctrl+Z to undo.":"Template updated. Press Ctrl+Z to undo."),t())})):u(`Template size (${(a.size/1024).toFixed(2)} KB) exceeds sync limit of 8 KB per item. Please reduce the size.`)}chrome.storage.local.get(["popupState","theme","nextIndex"],(n=>{chrome.storage.sync.get(["recentIndices"],(a=>{const o=n.popupState||{};t.templateName.value=o.name||"",t.templateTags.value=o.tags||"",t.promptArea.value=o.content||"",s=o.selectedName||null,r=n.theme||"light",c=n.nextIndex||e.length,m=a.recentIndices||[],document.body.className=r,t.fetchBtn.style.display=t.promptArea.value?"none":"block",y(t.typeSelect.value,"",!1),function(){const e=document.querySelector("header"),n=document.querySelector(".search-select"),a=document.querySelector("#template > .row.g-2"),o=document.querySelector("#buttons");if(!(e&&n&&a&&o))return void console.warn("One or more elements not found for height adjustment");const s=e.offsetHeight,r=n.offsetHeight,l=a.offsetHeight,c=o.offsetHeight,i=s+r+l+c,m=window.innerHeight-i;t.promptArea.style.height=`${Math.max(80,m-50)}px`,t.promptArea.style.marginBottom=`${c+20}px`}()}))})),new ResizeObserver((()=>{clearTimeout(a),a=setTimeout((()=>{const e=document.body.clientWidth,t=Math.min(Math.max(e/20,14),24);document.documentElement.style.setProperty("--base-font-size",`${t}px`)}),100)})).observe(document.body),t.themeToggle.addEventListener("click",(()=>{r="light"===r?"dark":"light",document.body.className=r,d()})),t.fullscreenToggle.addEventListener("click",(()=>{i=!i,t.fullscreenToggle.querySelector("svg use").setAttribute("href",i?"sprite.svg#compress":"sprite.svg#fullscreen"),d(),chrome.runtime.sendMessage({action:"toggleFullscreen"})})),t.closeBtn.addEventListener("click",(()=>{chrome.runtime.sendMessage({action:"closePopup"})})),t.clearSearch.addEventListener("click",(()=>{t.searchBox.value="",y(t.typeSelect.value,"",!1),t.searchBox.focus()})),document.addEventListener("keydown",(e=>{"Escape"===e.key&&chrome.runtime.sendMessage({action:"closePopup"})})),t.promptArea.addEventListener("keydown",(e=>{if("Tab"===e.key){e.preventDefault();const n=t.promptArea.selectionStart,a=t.promptArea.selectionEnd,o=t.promptArea.value;t.promptArea.value=o.substring(0,n)+"  "+o.substring(a),t.promptArea.selectionStart=t.promptArea.selectionEnd=n+2,d()}})),t.promptArea.addEventListener("input",(()=>{p(),t.fetchBtn.style.display=t.promptArea.value?"none":"block",d()})),t.templateTags.addEventListener("input",(()=>{p();let e=t.templateTags.value;e&&(e=e.replace(/^[,\s]+/g,""),e=e.replace(/[,\s.;/]+/g,", "),e=e.replace(/[^a-zA-Z0-9_, ]/g,""),t.templateTags.value=e),d()})),t.clearTags.addEventListener("click",(()=>{p(),t.templateTags.value="",d()})),t.searchBox.addEventListener("focus",(()=>{y(t.typeSelect.value,t.searchBox.value.toLowerCase(),!0)})),t.searchBox.addEventListener("input",(()=>{y(t.typeSelect.value,t.searchBox.value.toLowerCase(),!0)})),t.typeSelect.addEventListener("change",(()=>{y(t.typeSelect.value,t.searchBox.value.toLowerCase(),!0)})),document.addEventListener("click",(e=>{t.searchBox.contains(e.target)||t.dropdownResults.contains(e.target)||(t.dropdownResults.innerHTML=""),t.typeSelect.contains(e.target)||t.typeSelect.blur()})),t.saveBtn.addEventListener("click",(()=>{s?chrome.storage.sync.get(["templates"],(n=>{let a=n.templates||e.map(((e,t)=>({...e,index:t})));const o=a.find((e=>e.name===s));if(!o)return void u("Selected template not found.");if(t.templateName.value===o.name&&v(t.templateTags.value)===o.tags&&t.promptArea.value===o.content)return void u("No changes to save.");p(),l.templates=[...a];const r=a.findIndex((e=>e.name===s));a[r]={name:t.templateName.value,tags:v(t.templateTags.value),content:t.promptArea.value,type:"custom",favorite:o.favorite||!1,index:o.index},h(a,(()=>{y(t.typeSelect.value,"",!1),d()}))})):u("Please select a template to save changes.")})),t.saveAsBtn.addEventListener("click",(()=>{chrome.storage.sync.get(["templates"],(n=>{const a=n.templates||e.map(((e,t)=>({...e,index:t})));p();let o=t.templateName.value;if(o=o.trim(),a.some((e=>e.name===o)))return u("Name already exists."),void t.templateName.focus();if(!o){u("Name is mandatory."),o="New template";let e=2;const n=o;for(;a.some((e=>e.name===o));)o=`${n} ${e++}`;return t.templateName.value=o,void t.templateName.focus()}const r=v(t.templateTags.value);!function(n,a){chrome.storage.sync.get(["templates"],(o=>{let r=o.templates||e.map(((e,t)=>({...e,index:t})));p(),l.templates=[...r];const i={name:n,tags:a,content:t.promptArea.value,type:"custom",favorite:!1,index:c};r.push(i),h(r,(()=>{s=n,t.templateName.value=n,g(c),c++,y(t.typeSelect.value,"",!1),d()}),!0)}))}(o,r)}))})),t.fetchBtn.addEventListener("click",(()=>{f((e=>{e?chrome.tabs.sendMessage(e,{action:"getPrompt"},(e=>{if(chrome.runtime.lastError)return console.error("Fetch error:",chrome.runtime.lastError.message),void u("Failed to fetch prompt.\nTry refreshing the page");e&&e.prompt?(p(),t.promptArea.value=e.prompt,t.fetchBtn.style.display="none",d()):u("No input field found on the page.\nTry refreshing the page")})):u("No valid tab selected. Please activate a supported webpage.")}))})),t.sendBtn.addEventListener("click",(()=>{f((n=>{n?chrome.tabs.sendMessage(n,{action:"sendPrompt",prompt:t.promptArea.value},(t=>{if(chrome.runtime.lastError)return console.error("Send error:",chrome.runtime.lastError.message),void u("Failed to send prompt.\nTry refreshing the page");t&&t.success?s?chrome.storage.sync.get(["templates"],(t=>{const n=(t.templates||e.map(((e,t)=>({...e,index:t})))).find((e=>e.name===s));n&&g(n.index),chrome.runtime.sendMessage({action:"closePopup"})})):chrome.runtime.sendMessage({action:"closePopup"}):u("Failed to send prompt.\nTry refreshing the page")})):u("No valid tab selected. Please activate a supported webpage.")}))})),t.deleteBtn.addEventListener("click",(()=>{s?chrome.storage.sync.get(["templates"],(n=>{const a=n.templates||e.map(((e,t)=>({...e,index:t}))),o="pre-built"===a.find((e=>e.name===s)).type;if(!confirm(`Are you sure you want to delete "${s}"?${o?"\nThis is a pre-built template.":""}`))return;p(),l.templates=[...a];const r=a.findIndex((e=>e.name===s)),c=a[r].index;a.splice(r,1),m=m.filter((e=>e!==c)),chrome.storage.sync.set({templates:a},(()=>{u("Template deleted. Press Ctrl+Z to undo."),s=null,t.templateName.value="",t.templateTags.value="",t.promptArea.value="",t.searchBox.value="",t.fetchBtn.style.display="block",y(t.typeSelect.value,"",!1),d()}))})):u("Please select a template to delete.")})),document.addEventListener("keydown",(e=>{e.ctrlKey&&"z"===e.key&&l&&(t.templateName.value=l.name||"",t.templateTags.value=l.tags||"",t.promptArea.value=l.content||"",s=l.selectedName||null,l.templates&&chrome.storage.sync.set({templates:l.templates},(()=>{y(t.typeSelect.value,"",!1)})),t.fetchBtn.style.display=t.promptArea.value?"none":"block",u("Action undone."),l=null,d())})),t.clearPrompt.addEventListener("click",(()=>{p(),t.promptArea.value="",t.fetchBtn.style.display="block",t.promptArea.focus(),d()})),document.addEventListener("click",(n=>{if(n.target.classList.contains("favorite-toggle")){const a=n.target.dataset.name;chrome.storage.sync.get(["templates"],(n=>{const o=n.templates||e.map(((e,t)=>({...e,index:t}))),s=o.find((e=>e.name===a));s&&(s.favorite=!s.favorite,chrome.storage.sync.set({templates:o},(()=>{y(t.typeSelect.value,t.searchBox.value.toLowerCase(),!0)})))}))}})),t.dropdownResults.addEventListener("keydown",(e=>{const n=t.dropdownResults.querySelectorAll("div[role='option']"),a=document.activeElement;let o=Array.from(n).indexOf(a);"ArrowDown"===e.key?(e.preventDefault(),o=(o+1)%n.length,n[o].focus()):"ArrowUp"===e.key?(e.preventDefault(),o=(o-1+n.length)%n.length,n[o].focus()):"Enter"===e.key&&(e.preventDefault(),a.click())})),document.addEventListener("mousemove",(e=>{clearTimeout(o),o=setTimeout((()=>{t.clearSearch.style.display=t.searchBox.contains(e.target)&&t.searchBox.value?"block":"none",t.clearTags.style.display=t.templateTags.contains(e.target)&&t.templateTags.value?"block":"none",t.clearPrompt.style.display=t.promptArea.value?"block":"none"}),50)})),document.addEventListener("click",(e=>{t.template.style.opacity=t.buttons.style.opacity=t.searchBox.contains(e.target)||t.dropdownResults.contains(e.target)?"0.1":"1"}))}))})();