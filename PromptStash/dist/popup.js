(()=>{"use strict";const e=[{name:"Business Analyst Report",tags:"analysis, report, business",type:"pre-built",content:"# Your Role\nBusiness Analyst\n\n# Your Task\nAnalyze the provided data and generate a concise report.\n\n# Relevant Background Information\nUse formal tone, focus on key metrics.\n\n# Output Format\nExecutive summary (200 words), followed by bullet points.",favorite:!1},{name:"Code Debugging Assistant",tags:"coding, debug, tech",type:"pre-built",content:"# Your Role\nSenior Developer\n\n# Your Task\nIdentify and fix bugs in the provided code snippet.\n\n# Relevant Background Information\nCode is in Python, prioritize efficiency.\n\n# Output Format\nExplanation of issue, corrected code block.",favorite:!1},{name:"Content Generator",tags:"marketing, content, quick",type:"pre-built",content:"# Your Role\nContent Writer\n\n# Your Task\nWrite a 500-word blog post on the given topic.\n\n# Relevant Background Information\nCasual tone, SEO-friendly.\n\n# Output Format\nTitle, intro, 3 sections, conclusion.",favorite:!1}];document.addEventListener("DOMContentLoaded",(()=>{const t={searchBox:document.getElementById("searchBox"),typeSelect:document.getElementById("typeSelect"),dropdownResults:document.getElementById("dropdownResults"),templateName:document.getElementById("templateName"),templateTags:document.getElementById("templateTags"),promptArea:document.getElementById("promptArea"),fetchBtn:document.getElementById("fetchBtn"),saveBtn:document.getElementById("saveBtn"),saveAsBtn:document.getElementById("saveAsBtn"),deleteBtn:document.getElementById("deleteBtn"),clearPrompt:document.getElementById("clearPrompt"),clearTags:document.getElementById("clearTags"),sendBtn:document.getElementById("sendBtn"),clearSearch:document.getElementById("clearSearch"),favoriteSuggestions:document.getElementById("favoriteSuggestions"),fullscreenToggle:document.getElementById("fullscreenToggle"),closeBtn:document.getElementById("closeBtn"),toast:document.getElementById("toast"),renameBtn:document.getElementById("renameBtn"),confirmRename:document.getElementById("confirmRename"),cancelRename:document.getElementById("cancelRename"),favoriteStar:document.getElementById("favoriteStar"),dragHandle:document.querySelector(".drag-handle"),resizeHandle:document.querySelector(".resize-handle"),menuBtn:document.getElementById("menuBtn"),menuDropdown:document.getElementById("menuDropdown"),themeToggleMenu:document.getElementById("themeToggleMenu")};if(Object.values(t).some((e=>!e)))return void console.error("One or more DOM elements not found");let n=null,a="light",o=null,r=0,s=!1,l=null;function m(){chrome.storage.local.set({sidebarState:{name:t.templateName.value,tags:t.templateTags.value,content:t.promptArea.value,selectedName:n},theme:a,nextIndex:r})}function c(){o={name:t.templateName.value,tags:t.templateTags.value,content:t.promptArea.value,selectedName:n,templates:null}}function i(e){t.toast.textContent=e,t.toast.classList.add("show"),setTimeout((()=>t.toast.classList.remove("show")),3e3)}function d(){const e=document.querySelector("header"),n=document.querySelector(".search-select"),a=document.querySelector(".template"),o=document.querySelector("#buttons"),r=a.getBoundingClientRect(),s=o.getBoundingClientRect(),l=window.innerHeight-e.offsetHeight-n.offsetHeight-r.height-s.height;t.promptArea.style.height=`${Math.max(100,l)}px`,t.promptArea.style.marginBottom=`${s.height+10}px`}function u(e){return e?e.split(",").map((e=>e.trim().replace(/\s+/g,""))).filter((e=>e)).join(", "):""}function p(a,o="",r=!1){chrome.storage.sync.get(["templates"],(s=>{let l=s.templates||e.map(((e,t)=>({...e,index:t})));t.dropdownResults.innerHTML="",t.favoriteSuggestions.innerHTML="";let c=l.filter((e=>"all"===a||e.type===a));o&&(c=c.filter((e=>e.name.toLowerCase().includes(o)||e.tags.toLowerCase().includes(o))),c.sort(((e,t)=>{const n=e.name.toLowerCase().indexOf(o)+e.tags.toLowerCase().indexOf(o),a=t.name.toLowerCase().indexOf(o)+t.tags.toLowerCase().indexOf(o);return n!==a?n-a:e.name.localeCompare(t.name)}))),c.sort(((e,t)=>(t.favorite||0)-(e.favorite||0))),r&&c.forEach((e=>{const a=document.createElement("div");a.textContent=(e.favorite,`${e.name} (${e.tags})`),a.setAttribute("role","option"),a.setAttribute("aria-selected",n===e.name),a.addEventListener("click",(a=>{a.target.classList.contains("favorite-toggle")||(n=e.name,t.templateName.value=e.name,t.templateTags.value=e.tags,t.promptArea.value=e.content,t.searchBox.value="",t.dropdownResults.innerHTML="",t.templateName.setAttribute("readonly","true"),t.templateName.classList.remove("highlight"),t.renameBtn.classList.remove("d-none"),t.confirmRename.classList.add("d-none"),t.cancelRename.classList.add("d-none"),m(),t.promptArea.focus())})),a.innerHTML+=`<button class="favorite-toggle ${e.favorite?"favorited":"unfavorited"}" data-name="${e.name}" aria-label="${e.favorite?"Unfavorite":"Favorite"} template">${e.favorite?"★":"☆"}</button>`,t.dropdownResults.appendChild(a)}));const i=l.filter((e=>e.favorite));i.length>0?(t.favoriteStar.classList.remove("d-none"),t.favoriteSuggestions.classList.remove("d-none"),i.forEach((e=>{const a=document.createElement("span");a.textContent=e.name,a.className="favorite-suggestion",a.setAttribute("role","button"),a.setAttribute("tabindex","0"),a.addEventListener("click",(()=>{n=e.name,t.templateName.value=e.name,t.templateTags.value=e.tags,t.promptArea.value=e.content,t.searchBox.value="",m(),t.promptArea.focus()})),a.addEventListener("keydown",(e=>{"Enter"!==e.key&&" "!==e.key||a.click()})),t.favoriteSuggestions.appendChild(a)}))):(t.favoriteStar.classList.add("d-none"),t.favoriteSuggestions.classList.add("d-none"))}))}function g(e,t,n=!1){const a=function(e){const t=JSON.stringify(e),n=(new TextEncoder).encode(t).length;return{isValid:n<=8192,size:n}}({templates:e});a.isValid?chrome.storage.sync.set({templates:e},(()=>{chrome.runtime.lastError?(i("Failed to save template: "+chrome.runtime.lastError.message),console.error("Sync storage error:",chrome.runtime.lastError)):(i(n?"Template saved. Press Ctrl+Z to undo.":"Template updated. Press Ctrl+Z to undo."),t())})):i(`Template size (${(a.size/1024).toFixed(2)} KB) exceeds sync storage limit (8 KB). Please reduce the size.`)}chrome.runtime.sendMessage({action:"getWindowId"},(e=>{e&&e.windowId&&(l=e.windowId)})),chrome.storage.local.get(["sidebarState","theme","nextIndex"],(o=>{const s=o.sidebarState||{};t.templateName.value=s.name||"",t.templateTags.value=s.tags||"",t.promptArea.value=s.content||"",n=s.selectedName||null,a=o.theme||"light",r=o.nextIndex||e.length,document.body.className=a,t.fetchBtn.style.display=t.promptArea.value?"none":"block",p(t.typeSelect.value,"",!1),d(),t.themeToggleMenu.textContent="light"===a?"Darkmode":"Lightmode"})),t.dragHandle.addEventListener("mousedown",(e=>{if(e.preventDefault(),!l)return;let t=e.screenX,n=e.screenY,a=null;function o(e){if(!a)return;const o=e.screenX-t,r=e.screenY-n,s=a.left+o,m=a.top+r;chrome.windows.update(l,{left:s,top:m}),t=e.screenX,n=e.screenY}chrome.windows.get(l,(e=>{a=e})),document.addEventListener("mousemove",o),document.addEventListener("mouseup",(function e(){document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",e)}))})),t.resizeHandle.addEventListener("mousedown",(e=>{if(e.preventDefault(),!l)return;let t=e.screenX,n=e.screenY,a=null;function o(e){if(!a)return;const o=e.screenX-t,r=e.screenY-n,s=Math.max(300,Math.min(a.width+o,.9*window.screen.width)),m=Math.max(400,Math.min(a.height+r,.9*window.screen.height));chrome.windows.update(l,{width:Math.round(s),height:Math.round(m)}),t=e.screenX,n=e.screenY}chrome.windows.get(l,(e=>{a=e})),document.addEventListener("mousemove",o),document.addEventListener("mouseup",(function e(){document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",e)}))})),new ResizeObserver((e=>{for(let t of e){const e=t.contentRect.width,n=Math.min(Math.max(e/20,14),24);document.documentElement.style.setProperty("--base-font-size",`${n}px`)}})).observe(document.body),t.menuBtn.addEventListener("click",(e=>{e.stopPropagation(),t.menuDropdown.style.display="none"===t.menuDropdown.style.display?"block":"none"})),document.addEventListener("click",(e=>{t.menuBtn.contains(e.target)||t.menuDropdown.contains(e.target)||(t.menuDropdown.style.display="none")})),t.themeToggleMenu.addEventListener("click",(()=>{a="light"===a?"dark":"light",document.body.className=a,t.themeToggleMenu.textContent="light"===a?"Darkmode":"Lightmode",m()})),t.menuDropdown.querySelector("#saveLocally").addEventListener("click",(()=>{alert("Save locally functionality to be implemented.")})),t.menuDropdown.querySelector("#toggleMarkdown").addEventListener("click",(()=>{alert("Toggle markdown functionality to be implemented.")})),t.menuDropdown.querySelector("#exportData").addEventListener("click",(()=>{alert("Export data functionality to be implemented.")})),t.menuDropdown.querySelector("#importData").addEventListener("click",(()=>{alert("Import data functionality to be implemented.")})),t.fullscreenToggle.addEventListener("click",(()=>{s=!s,t.fullscreenToggle.querySelector("svg use").setAttribute("href",s?"sprite.svg#compress":"sprite.svg#fullscreen"),m(),chrome.runtime.sendMessage({action:"toggleFullscreen",windowId:l})})),t.closeBtn.addEventListener("click",(()=>{chrome.runtime.sendMessage({action:"closeSidebar",windowId:l})})),t.clearSearch.addEventListener("click",(()=>{t.searchBox.value="",p(t.typeSelect.value,"",!1),t.searchBox.focus()})),document.addEventListener("keydown",(e=>{"Escape"===e.key&&chrome.runtime.sendMessage({action:"closeSidebar",windowId:l})})),t.promptArea.addEventListener("keydown",(e=>{if("Tab"===e.key){e.preventDefault();const n=t.promptArea.selectionStart,a=t.promptArea.selectionEnd,o=t.promptArea.value;t.promptArea.value=o.substring(0,n)+"  "+o.substring(a),t.promptArea.selectionStart=t.promptArea.selectionEnd=n+2,m()}})),t.promptArea.addEventListener("input",(()=>{c(),t.fetchBtn.style.display=t.promptArea.value?"none":"block",m()})),t.templateTags.addEventListener("input",(()=>{c();let e=t.templateTags.value;e&&(e=e.replace(/^[,\s]/g,""),e=e.replace(/[,\s.;/]+/g,", "),e=e.replace(/[^a-zA-Z0-9_, ]/g,""),t.templateTags.value=e),m()})),t.clearTags.addEventListener("click",(()=>{c(),t.templateTags.value="",m()})),t.searchBox.addEventListener("focus",(()=>{p(t.typeSelect.value,t.searchBox.value.toLowerCase(),!0)})),t.searchBox.addEventListener("input",(()=>{p(t.typeSelect.value,t.searchBox.value.toLowerCase(),!0)})),t.typeSelect.addEventListener("change",(()=>{p(t.typeSelect.value,t.searchBox.value.toLowerCase(),!0)})),document.addEventListener("click",(e=>{t.searchBox.contains(e.target)||t.dropdownResults.contains(e.target)||(t.dropdownResults.innerHTML=""),t.typeSelect.contains(e.target)||t.typeSelect.blur()})),t.saveBtn.addEventListener("click",(()=>{n?chrome.storage.sync.get(["templates"],(a=>{let r=a.templates||e.map(((e,t)=>({...e,index:t})));const s=r.find((e=>e.name===n));if(!s)return void alert("Selected template not found.");if(u(t.templateTags.value)===s.tags&&t.promptArea.value===s.content)return void i("No changes to save.");c(),o.templates=[...r];const l="pre-built"===s.type;if(!confirm(`Are you sure you want to edit the content/tags of "${n}"?${l?"\nThis is a pre-built template.":""}`))return;const d=r.findIndex((e=>e.name===n));r[d]={name:n,tags:u(t.templateTags.value),content:t.promptArea.value,type:s.type,favorite:s.favorite||!1,index:s.index},g(r,(()=>{p(t.typeSelect.value,"",!1),m()}))})):alert("Please select a template to save changes.")})),t.saveAsBtn.addEventListener("click",(()=>{chrome.storage.sync.get(["templates"],(a=>{const s=a.templates||e.map(((e,t)=>({...e,index:t})));let l="New Template",d=1;for(;s.some((e=>e.name===l));)l="New Template "+d++;let v=prompt("Enter template name (required):",l);if(null===v)return;if(v=v.trim(),!v)return void i("Name is mandatory.");if(s.some((e=>e.name===v)))return void i("Name already exists.");let h=prompt("Enter tags (optional, comma-separated):",t.templateTags.value);null===h&&(h="");const f=u(h);!function(a,s){chrome.storage.sync.get(["templates"],(l=>{let i=l.templates||e.map(((e,t)=>({...e,index:t})));if(c(),o.templates=[...i],!confirm(`Save as new template "${a}"?`))return;const d={name:a,tags:s,content:t.promptArea.value,type:"custom",favorite:!1,index:r++};i.push(d),g(i,(()=>{n=a,t.templateName.value=a,p(t.typeSelect.value,"",!1),m()}),!0)}))}(v,f)}))})),t.fetchBtn.addEventListener("click",(()=>{chrome.tabs.query({active:!0,currentWindow:!0},(e=>{chrome.tabs.sendMessage(e[0].id,{action:"getPrompt"},(e=>{e&&e.prompt&&(c(),t.promptArea.value=e.prompt,t.fetchBtn.style.display="none",m())}))}))})),t.sendBtn.addEventListener("click",(()=>{chrome.tabs.query({active:!0,currentWindow:!0},(e=>{chrome.tabs.sendMessage(e[0].id,{action:"sendPrompt",prompt:t.promptArea.value},(()=>{chrome.runtime.sendMessage({action:"closeSidebar",windowId:l})}))}))})),t.deleteBtn.addEventListener("click",(()=>{n?chrome.storage.sync.get(["templates"],(a=>{const r=a.templates||e.map(((e,t)=>({...e,index:t}))),s="pre-built"===r.find((e=>e.name===n)).type;if(!confirm(`Are you sure you want to delete "${n}"?${s?"\nThis is a pre-built template.":""}`))return;c(),o.templates=[...r];const l=r.findIndex((e=>e.name===n));r.splice(l,1),chrome.storage.sync.set({templates:r},(()=>{i("Template deleted. Press Ctrl+Z to undo."),n=null,t.templateName.value="",t.templateTags.value="",t.promptArea.value="",t.searchBox.value="",p(t.typeSelect.value,"",!1),m()}))})):alert("Please select a template to delete.")})),document.addEventListener("keydown",(e=>{e.ctrlKey&&"z"===e.key&&o&&(t.templateName.value=o.name||"",t.templateTags.value=o.tags||"",t.promptArea.value=o.content||"",n=o.selectedName||null,o.templates&&chrome.storage.sync.set({templates:o.templates},(()=>{p(t.typeSelect.value,"",!1)})),i("Action undone."),o=null,m())})),t.clearPrompt.addEventListener("click",(()=>{c(),t.promptArea.value="",t.fetchBtn.style.display="block",t.promptArea.focus(),m()})),document.addEventListener("click",(n=>{if(n.target.classList.contains("favorite-toggle")){const a=n.target.dataset.name;chrome.storage.sync.get(["templates"],(n=>{const o=n.templates||e.map(((e,t)=>({...e,index:t}))),r=o.find((e=>e.name===a));r&&(r.favorite=!r.favorite,chrome.storage.sync.set({templates:o},(()=>{p(t.typeSelect.value,t.searchBox.value.toLowerCase(),!0)})))}))}})),t.renameBtn.addEventListener("click",(()=>{n?(t.templateName.removeAttribute("readonly"),t.templateName.classList.add("highlight"),t.templateName.focus(),t.renameBtn.classList.add("d-none"),t.confirmRename.classList.remove("d-none"),t.cancelRename.classList.remove("d-none"),t.templateName.dataset.originalName=n):i("Please select a template to rename.")})),t.cancelRename.addEventListener("click",(()=>{const e=t.templateName.dataset.originalName;t.templateName.value=e,t.templateName.setAttribute("readonly","true"),t.templateName.classList.remove("highlight"),t.renameBtn.classList.remove("d-none"),t.confirmRename.classList.add("d-none"),t.cancelRename.classList.add("d-none")})),t.confirmRename.addEventListener("click",(()=>{const a=t.templateName.value.trim(),o=t.templateName.dataset.originalName;if(a===o)return t.templateName.setAttribute("readonly","true"),t.templateName.classList.remove("highlight"),t.renameBtn.classList.remove("d-none"),t.confirmRename.classList.add("d-none"),void t.cancelRename.classList.add("d-none");a?chrome.storage.sync.get(["templates"],(r=>{const s=r.templates||e.map(((e,t)=>({...e,index:t})));if(s.some((e=>e.name===a)))return void i("Name already exists.");const l=s.findIndex((e=>e.name===o));-1!==l?(s[l].name=a,chrome.storage.sync.set({templates:s},(()=>{i("Template renamed."),n=a,t.templateName.value=a,t.templateName.setAttribute("readonly","true"),t.templateName.classList.remove("highlight"),t.renameBtn.classList.remove("d-none"),t.confirmRename.classList.add("d-none"),t.cancelRename.classList.add("d-none"),p(t.typeSelect.value,"",!1)}))):i("Template not found.")})):i("Name is mandatory.")})),document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach((e=>new bootstrap.Tooltip(e,{delay:{show:100,hide:100}}))),t.dropdownResults.addEventListener("keydown",(e=>{const n=t.dropdownResults.querySelectorAll("div[role='option']"),a=document.activeElement;let o=Array.from(n).indexOf(a);"ArrowDown"===e.key?(e.preventDefault(),o=(o+1)%n.length,n[o].focus()):"ArrowUp"===e.key?(e.preventDefault(),o=(o-1+n.length)%n.length,n[o].focus()):"Enter"===e.key&&(e.preventDefault(),a.click())})),window.addEventListener("resize",d),t.searchBox.addEventListener("input",(()=>{t.clearSearch.style.display=t.searchBox.value?"block":"none",p(t.typeSelect.value,t.searchBox.value.toLowerCase(),!0)}))}))})();