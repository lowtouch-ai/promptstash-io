(()=>{"use strict";const e=[{name:"Business Analyst Report",tags:"analysis, report, business",type:"pre-built",content:"# Your Role\nBusiness Analyst\n\n# Your Task\nAnalyze the provided data and generate a concise report.\n\n# Relevant Background Information\nUse formal tone, focus on key metrics.\n\n# Output Format\nExecutive summary (200 words), followed by bullet points.",favorite:!1},{name:"Code Debugging Assistant",tags:"coding, debug, tech",type:"pre-built",content:"# Your Role\nSenior Developer\n\n# Your Task\nIdentify and fix bugs in the provided code snippet.\n\n# Relevant Background Information\nCode is in Python, prioritize efficiency.\n\n# Output Format\nExplanation of issue, corrected code block.",favorite:!1},{name:"Content Generator",tags:"marketing, content, quick",type:"pre-built",content:"# Your Role\nContent Writer\n\n# Your Task\nWrite a 500-word blog post on the given topic.\n\n# Relevant Background Information\nCasual tone, SEO-friendly.\n\n# Output Format\nTitle, intro, 3 sections, conclusion.",favorite:!1}],t="1.0.0";function a(e,t){let a;return function(...n){clearTimeout(a),a=setTimeout((()=>e.apply(this,n)),t)}}document.addEventListener("DOMContentLoaded",(()=>{const n={searchBox:document.getElementById("searchBox"),typeSelect:document.getElementById("typeSelect"),dropdownResults:document.getElementById("dropdownResults"),template:document.getElementById("template"),templateName:document.getElementById("templateName"),templateTags:document.getElementById("templateTags"),promptArea:document.getElementById("promptArea"),buttons:document.getElementById("buttons"),fetchBtns:document.querySelectorAll("#fetchBtn, #fetchBtn2"),fetchBtn2:document.getElementById("fetchBtn2"),saveBtn:document.getElementById("saveBtn"),saveAsBtn:document.getElementById("saveAsBtn"),deleteBtn:document.getElementById("deleteBtn"),clearSearch:document.getElementById("clearSearch"),clearPrompt:document.getElementById("clearPrompt"),clearAllBtn:document.getElementById("clearAllBtn"),sendBtn:document.getElementById("sendBtn"),favoriteSuggestions:document.getElementById("favoriteSuggestions"),fullscreenToggle:document.getElementById("fullscreenToggle"),closeBtn:document.getElementById("closeBtn"),minimizeBtn:document.getElementById("minimizeBtn"),newBtn:document.getElementById("newBtn"),overlay:document.getElementById("overlay"),toast:document.getElementById("toast"),themeToggle:document.getElementById("themeToggle")},o=Object.entries(n).filter((([e,t])=>!t)).map((([e])=>e));o.length>0?(console.error("Missing DOM elements:",o),f("Error: Extension UI failed to load. Please reload the extension.")):console.log("All DOM elements found:",Object.keys(n));let r,s,l=null,i="light",c=null,m=0,d=!1,p=[];function u(){const e={popupState:{name:n.templateName.value,tags:n.templateTags.value,content:n.promptArea.value,selectedName:l},theme:i,isFullscreen:d,extensionVersion:t};chrome.storage.local.set(e,(()=>{chrome.runtime.lastError&&(console.error("Failed to save state:",chrome.runtime.lastError.message),f("Error: Failed to save extension state. Some data may not persist."))}))}function g(){chrome.storage.sync.set({nextIndex:m},(()=>{chrome.runtime.lastError&&(console.error("Failed to save nextIndex:",chrome.runtime.lastError.message),f("Error: Failed to save nextIndex. Some data may not persist."))}))}function v(){c={name:n.templateName.value,tags:n.templateTags.value,content:n.promptArea.value,selectedName:l,templates:null}}function f(e){n.toast.textContent=e,n.toast.classList.add("show"),setTimeout((()=>n.toast.classList.remove("show")),4e3)}function y(e,t,a=!1){const n=e.trim();if(!n)return f("Error: Template name is required."),{isValid:!1,sanitizedName:null};if(n.length>50)return f("Error: Template name must be 50 characters or less."),{isValid:!1,sanitizedName:null};const o=n.replace(/[^a-zA-Z0-9\s]/g,"");return o!==n?(f("Error: Template name can only contain letters, numbers, and spaces."),{isValid:!1,sanitizedName:null}):t.some((e=>e.name===o&&(a||e.name!==l)))?(f("Error: Template name must be unique."),{isValid:!1,sanitizedName:null}):{isValid:!0,sanitizedName:o}}function h(e){if(!e)return"";const t=e.split(",").map((e=>e.trim())).filter((e=>e));if(t.length>5)return f("Error: Maximum of 5 tags allowed per template."),null;const a=t.map((e=>e.replace(/[^a-zA-Z0-9]/g,"").slice(0,20)));return a.some((e=>0===e.length))?(f("Error: Each tag must contain only letters or numbers and be 20 characters or less."),null):a.join(", ")}function E(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,"")}function B(e){p.unshift(e),p=[...new Set(p)],p.length>10&&(p=p.slice(0,10));const t=JSON.stringify({recentIndices:p});(new TextEncoder).encode(t).length>8192&&(console.warn("Recent indices size exceeds sync quota, pruning older entries."),p=p.slice(0,5)),chrome.storage.sync.set({recentIndices:p},(()=>{chrome.runtime.lastError&&console.error("Failed to save recent indices:",chrome.runtime.lastError.message)}))}function T(e){const t=setTimeout((()=>{f("Error: No response from tab. Please activate a supported webpage."),e(null)}),5e3);chrome.runtime.sendMessage({action:"getTargetTabId"},(a=>{clearTimeout(t),a&&a.tabId?e(a.tabId):(f("Error: No valid tab selected. Please activate a supported webpage."),e(null))}))}function x(t,a="",o=!1){chrome.storage.sync.get(["templates"],(r=>{console.log(r);let s=r.templates||e.map(((e,t)=>({...e,index:t})));n.dropdownResults.innerHTML="",n.favoriteSuggestions.innerHTML="";let i=s.filter((e=>"all"===t||e.type===t));a?(i=i.filter((e=>e.name.toLowerCase().includes(a)||e.tags.toLowerCase().includes(a))),i.sort(((e,t)=>{const n=e.name.toLowerCase().indexOf(a)+e.tags.toLowerCase().indexOf(a),o=t.name.toLowerCase().indexOf(a)+t.tags.toLowerCase().indexOf(a);return n!==o?n-o:e.name.localeCompare(t.name)}))):i.sort(((e,t)=>{const a=p.indexOf(e.index),n=p.indexOf(t.index);return-1===a&&-1===n?e.name.localeCompare(t.name):-1===a?1:-1===n?-1:a-n})),o&&i.forEach(((e,t)=>{const a=document.createElement("div");a.textContent=(e.favorite,`${e.name} (${e.tags})`),a.setAttribute("role","option"),a.setAttribute("aria-selected",l===e.name),n.overlay.style.display="block",n.dropdownResults.style.display="block",a.addEventListener("click",(t=>{t.target.classList.contains("favorite-toggle")||(l=e.name,n.templateName.value=e.name,n.templateTags.value=e.tags,n.promptArea.value=e.content,n.searchBox.value="",n.dropdownResults.innerHTML="",n.fetchBtn2.style.display=e.content?"none":"block",n.overlay.style.display="none",n.dropdownResults.style.display="none",u(),n.promptArea.focus())})),a.innerHTML+=`<button class="favorite-toggle ${e.favorite?"favorited":"unfavorited"}" data-name="${e.name}" aria-label="${e.favorite?"Unfavorite":"Favorite"} template">${e.favorite?"★":"☆"}</button>`,n.dropdownResults.appendChild(a)}));const c=s.filter((e=>e.favorite));c.length>0?(c.sort(((e,t)=>{const a=p.indexOf(e.index),n=p.indexOf(t.index);return-1===a&&-1===n?e.name.localeCompare(t.name):-1===a?1:-1===n?-1:a-n})),n.favoriteSuggestions.classList.remove("d-none"),c.forEach((e=>{const t=document.createElement("span");t.textContent=e.name,t.className="favorite-suggestion",t.setAttribute("role","button"),t.setAttribute("tabindex","0"),t.addEventListener("click",(()=>{l=e.name,n.templateName.value=e.name,n.templateTags.value=e.tags,n.promptArea.value=e.content,n.searchBox.value="",n.fetchBtn2.style.display=e.content?"none":"block",u(),n.promptArea.focus()})),t.addEventListener("keydown",(e=>{"Enter"!==e.key&&" "!==e.key||t.click()})),n.favoriteSuggestions.appendChild(t)}))):n.favoriteSuggestions.classList.add("d-none")}))}function b(e,t,a=!1){const o=function(e){const t=JSON.stringify(e),a=(new TextEncoder).encode(t).length;return{isValid:a<=8192,size:a}}(a?e[e.length-1]:e.find((e=>e.name===n.templateName.value)));o.isValid?function(e,t){chrome.storage.sync.get(null,(e=>{const a=JSON.stringify(e),n=(new TextEncoder).encode(a).length;n>92160&&f("Warning: Storage is nearly full (90% of 100KB limit). Please delete unused templates."),t(n<=102400)}))}(0,(n=>{n?chrome.storage.sync.set({templates:e},(()=>{chrome.runtime.lastError?(f("Error: Failed to save template: "+chrome.runtime.lastError.message),console.error("Sync storage error:",chrome.runtime.lastError)):(f(a?"Success: Template saved. Press Ctrl+Z to undo.":"Success: Template updated. Press Ctrl+Z to undo."),t())})):f("Error: Total storage limit (100KB) exceeded. Please delete unused templates.")})):f(`Error: Template size (${(o.size/1024).toFixed(2)} KB) exceeds 8 KB limit. Please reduce the size.`)}chrome.storage.local.get(["popupState","theme","extensionVersion"],(a=>{chrome.storage.sync.get(["recentIndices","templates","nextIndex"],(o=>{const r=a.extensionVersion||"0.0.0";r!==t&&(console.log(`Version updated from ${r} to ${t}. No schema migration needed.`),chrome.storage.local.set({extensionVersion:t},(()=>{chrome.runtime.lastError&&(console.error("Failed to save extension version:",chrome.runtime.lastError.message),f("Error: Failed to save extension version. Some data may not persist."))})));const s=a.popupState||{};n.templateName.value=s.name||"",n.templateTags.value=s.tags||"",n.promptArea.value=s.content||"",l=s.selectedName||null,i=a.theme||"light",m=o.nextIndex||e.length,p=o.recentIndices||[];const c=o.templates||e.map(((e,t)=>({...e,index:t})));o.templates||chrome.storage.sync.set({templates:c},(()=>{chrome.runtime.lastError&&(console.error("Failed to initialize templates:",chrome.runtime.lastError.message),f("Error: Failed to initialize templates. Some data may not be saved."))})),document.body.className=i,n.fetchBtn2.style.display=n.promptArea.value?"none":"block",x(n.typeSelect.value,"",!1)}))})),new ResizeObserver((()=>{clearTimeout(r),r=setTimeout((()=>{const e=document.body.clientWidth,t=Math.min(Math.max(e/20,14),24);document.documentElement.style.setProperty("--base-font-size",`${t}px`)}),100)})).observe(document.body),n.templateName.addEventListener("input",a((()=>{let e=n.templateName.value;e.length>50&&(e=e.slice(0,50),n.templateName.value=e);const t=e.replace(/[^a-zA-Z0-9\s]/g,"");t!==e&&(n.templateName.value=t,f("Error: Template name can only contain letters, numbers, and spaces.")),u()}),10)),n.templateTags.addEventListener("input",a((()=>{v();let e=n.templateTags.value;if(e){e=e.replace(/^[,\s]+/g,""),e=e.replace(/,[,\s]*/g,", "),e=e.replace(/\s+/g," ");const t=e.split(", ").map((e=>e.replace(/[^a-zA-Z0-9]/g,"").slice(0,20)));t.length>5&&(f("Error: Maximum of 5 tags allowed per template."),t.length=5),e=t.join(", "),n.templateTags.value=e}const t=n.templateTags.selectionStart;" "===e[t]&&","===e[t-1]&&(n.templateTags.selectionStart=n.templateTags.selectionEnd=t-1),u()}),10)),n.themeToggle.addEventListener("click",(()=>{i="light"===i?"dark":"light",document.body.className=i,u()})),n.fullscreenToggle.addEventListener("click",(()=>{n.fullscreenToggle.querySelector("svg use").setAttribute("href",d?"sprite.svg#compress":"sprite.svg#fullscreen"),d=!d,u(),chrome.runtime.sendMessage({action:"toggleFullscreen"})})),n.minimizeBtn.addEventListener("click",(()=>{chrome.runtime.sendMessage({action:"closePopup"})})),n.closeBtn.addEventListener("click",(()=>{n.templateName.value="",n.templateTags.value="",n.promptArea.value="",l=null,n.fetchBtn2.style.display="block",n.searchBox.value="",x(n.typeSelect.value,"",!1),u(),chrome.runtime.sendMessage({action:"closePopup"})})),n.newBtn.addEventListener("click",(()=>{v(),n.templateName.value="",n.templateTags.value="",n.promptArea.value="",l=null,n.fetchBtn2.style.display="block",n.searchBox.value="",x(n.typeSelect.value,"",!1),u(),f("New template created.")})),n.clearSearch.addEventListener("click",(()=>{n.searchBox.value="",x(n.typeSelect.value,"",!1),n.searchBox.focus()})),n.clearPrompt.addEventListener("click",(()=>{v(),n.promptArea.value="",n.fetchBtn2.style.display="block",n.promptArea.focus(),u()})),n.clearAllBtn.addEventListener("click",(()=>{v(),n.templateName.value="",n.templateTags.value="",n.promptArea.value="",l=null,n.fetchBtn2.style.display="block",n.searchBox.value="",x(n.typeSelect.value,"",!1),u(),f("All fields cleared.")})),document.addEventListener("keydown",(e=>{"Escape"===e.key&&chrome.runtime.sendMessage({action:"closePopup"})})),n.promptArea.addEventListener("keydown",(e=>{if("Tab"===e.key){e.preventDefault();const t=n.promptArea.selectionStart,a=n.promptArea.selectionEnd,o=n.promptArea.value;n.promptArea.value=o.substring(0,t)+"  "+o.substring(a),n.promptArea.selectionStart=n.promptArea.selectionEnd=t+2,u()}})),n.promptArea.addEventListener("input",(()=>{v(),n.promptArea.value=E(n.promptArea.value),n.fetchBtn2.style.display=n.promptArea.value?"none":"block",u()})),n.templateTags.addEventListener("keydown",(e=>{const t=n.templateTags.selectionStart,a=n.templateTags.value;return"Backspace"===e.key&&t>0&&" "===a[t-1]&&","===a[t-2]?(e.preventDefault(),n.templateTags.value=a.slice(0,t-2)+a.slice(t),n.templateTags.selectionStart=n.templateTags.selectionEnd=t-2,v(),void u()):"Delete"===e.key&&t<a.length&&","===a[t]&&" "===a[t+1]?(e.preventDefault(),n.templateTags.value=a.slice(0,t)+a.slice(t+2),n.templateTags.selectionStart=n.templateTags.selectionEnd=t,v(),void u()):"ArrowLeft"===e.key&&t>1&&" "===a[t-1]&&","===a[t-2]?(e.preventDefault(),void(n.templateTags.selectionStart=n.templateTags.selectionEnd=t-2)):"ArrowRight"===e.key&&t<a.length-1&&","===a[t]&&" "===a[t+1]?(e.preventDefault(),void(n.templateTags.selectionStart=n.templateTags.selectionEnd=t+2)):void 0})),n.templateTags.addEventListener("click",(()=>{const e=n.templateTags.selectionStart,t=n.templateTags.value;e>0&&" "===t[e]&&","===t[e-1]&&(n.templateTags.selectionStart=n.templateTags.selectionEnd=e-1)})),n.searchBox.addEventListener("focus",(()=>{x(n.typeSelect.value,n.searchBox.value.toLowerCase(),!0)})),n.searchBox.addEventListener("input",(()=>{x(n.typeSelect.value,n.searchBox.value.toLowerCase(),!0)})),n.typeSelect.addEventListener("change",(()=>{x(n.typeSelect.value,n.searchBox.value.toLowerCase(),!0)})),document.addEventListener("click",(e=>{n.searchBox.contains(e.target)||n.dropdownResults.contains(e.target)||n.themeToggle.contains(e.target)||n.typeSelect.contains(e.target)||(n.dropdownResults.innerHTML="",n.overlay.style.display="none",n.dropdownResults.style.display="none")})),n.saveBtn.addEventListener("click",(()=>{chrome.storage.sync.get(["templates"],(t=>{let a=t.templates||e.map(((e,t)=>({...e,index:t})));const o=y(n.templateName.value,a);if(!o.isValid)return void n.templateName.focus();const r=o.sanitizedName,s=n.templateTags.value,i=h(s);if(null===i)return void n.templateTags.focus();const d=E(n.promptArea.value);if(!d.trim())return f("Error: Prompt content is required to save a template."),void n.promptArea.focus();if(s.trim()||(n.templateTags.focus(),f("Warning: No tags provided. You can add tags in the tags field now or later.")),l){const e=a.find((e=>e.name===l));if(!e)return void f("Error: Selected template not found.");if(n.templateName.value===e.name&&h(n.templateTags.value)===e.tags&&n.promptArea.value===e.content)return void f("Info: No changes to save.");v(),c.templates=[...a];const t=a.findIndex((e=>e.name===l));a[t]={name:r,tags:i,content:d,type:"custom",favorite:e.favorite||!1,index:e.index},b(a,(()=>{l=r,x(n.typeSelect.value,"",!1),u()}))}else{v(),c.templates=[...a];const e={name:r,tags:i,content:d,type:"custom",favorite:!1,index:m};a.push(e),B(m),m++,b(a,(()=>{l=r,x(n.typeSelect.value,"",!1),u(),g()}),!0)}}))})),n.saveAsBtn.addEventListener("click",(()=>{chrome.storage.sync.get(["templates"],(t=>{const a=t.templates||e.map(((e,t)=>({...e,index:t}))),o=y(n.templateName.value,a,!0);if(!o.isValid)return void n.templateName.focus();const r=o.sanitizedName,s=n.templateTags.value,i=h(s);if(null!==i)return E(n.promptArea.value).trim()?(s.trim()||(n.templateTags.focus(),f("Warning: No tags provided. You can add tags in the tags field now or later.")),void function(t,a){chrome.storage.sync.get(["templates"],(o=>{let r=o.templates||e.map(((e,t)=>({...e,index:t})));v(),c.templates=[...r];const s={name:t,tags:a,content:E(n.promptArea.value),type:"custom",favorite:!1,index:m};r.push(s),B(m),m++,b(r,(()=>{l=t,n.templateName.value=t,x(n.typeSelect.value,"",!1),u(),g()}),!0)}))}(r,i)):(f("Error: Prompt content is required to save a template."),void n.promptArea.focus());n.templateTags.focus()}))})),n.fetchBtns.forEach((e=>{e.addEventListener("click",(()=>{T((e=>{e?chrome.tabs.sendMessage(e,{action:"getPrompt"},(e=>{if(chrome.runtime.lastError)return console.error("Fetch error:",chrome.runtime.lastError.message),void f("Error: Failed to fetch prompt. Please refresh the page.");e&&e.prompt?(v(),n.promptArea.value=E(e.prompt),n.fetchBtn2.style.display="none",u()):f("Error: No input found on the page.")})):f("Error: No valid tab selected. Please activate a supported webpage.")}))}))})),n.sendBtn.addEventListener("click",(()=>{T((t=>{t?chrome.tabs.sendMessage(t,{action:"sendPrompt",prompt:E(n.promptArea.value)},(t=>{if(chrome.runtime.lastError)return console.error("Send error:",chrome.runtime.lastError.message),void f("Error: Failed to send prompt. Please refresh the page.");t&&t.success?l?chrome.storage.sync.get(["templates"],(t=>{const a=(t.templates||e.map(((e,t)=>({...e,index:t})))).find((e=>e.name===l));a&&B(a.index),chrome.runtime.sendMessage({action:"closePopup"})})):chrome.runtime.sendMessage({action:"closePopup"}):f("Error: Failed to send prompt. Please refresh the page.")})):f("Error: No valid tab selected. Please activate a supported webpage.")}))})),n.deleteBtn.addEventListener("click",(()=>{l?chrome.storage.sync.get(["templates"],(t=>{const a=t.templates||e.map(((e,t)=>({...e,index:t}))),o="pre-built"===a.find((e=>e.name===l)).type;if(!confirm(`Are you sure you want to delete "${l}"?${o?"\nThis is a pre-built template.":""}`))return;v(),c.templates=[...a];const r=a.findIndex((e=>e.name===l)),s=a[r].index;a.splice(r,1),p=p.filter((e=>e!==s)),chrome.storage.sync.set({templates:a},(()=>{f("Template deleted successfully. Press Ctrl+Z to undo."),l=null,n.templateName.value="",n.templateTags.value="",n.promptArea.value="",n.searchBox.value="",n.fetchBtn2.style.display="block",x(n.typeSelect.value,"",!1),u()}))})):f("Error: Please select a template to delete.")})),document.addEventListener("keydown",(e=>{e.ctrlKey&&"z"===e.key&&c&&(n.templateName.value=c.name||"",n.templateTags.value=c.tags||"",n.promptArea.value=c.content||"",l=c.selectedName||null,c.templates&&chrome.storage.sync.set({templates:c.templates},(()=>{x(n.typeSelect.value,"",!1)})),n.fetchBtn2.style.display=n.promptArea.value?"none":"block",f("Action undone successfully."),c=null,u())})),document.addEventListener("click",(t=>{if(t.target.classList.contains("favorite-toggle")){const a=t.target.dataset.name;chrome.storage.sync.get(["templates"],(t=>{const o=t.templates||e.map(((e,t)=>({...e,index:t}))),r=o.find((e=>e.name===a));if(r){if(!r.favorite&&o.filter((e=>e.favorite)).length>=10)return void f("Error: Maximum of 10 favorite templates allowed.");r.favorite=!r.favorite,chrome.storage.sync.set({templates:o},(()=>{x(n.typeSelect.value,n.searchBox.value.toLowerCase(),!0)}))}}))}})),n.dropdownResults.addEventListener("keydown",(e=>{const t=n.dropdownResults.querySelectorAll("div[role='option']"),a=document.activeElement;let o=Array.from(t).indexOf(a);"ArrowDown"===e.key?(e.preventDefault(),o=(o+1)%t.length,t[o].focus()):"ArrowUp"===e.key?(e.preventDefault(),o=(o-1+t.length)%t.length,t[o].focus()):"Enter"===e.key&&(e.preventDefault(),a.click())})),document.addEventListener("mousemove",(()=>{clearTimeout(s),s=setTimeout((()=>{n.clearSearch.style.display=n.searchBox.value?"block":"none",n.clearPrompt.style.display=n.promptArea.value?"block":"none"}),50)}))}))})();