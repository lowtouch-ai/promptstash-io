(()=>{"use strict";const e=[{name:"Business Analyst Report",tags:"analysis, report, business",type:"pre-built",content:"# Your Role\nBusiness Analyst\n\n# Your Task\nAnalyze the provided data and generate a concise report.\n\n# Relevant Background Information\nUse formal tone, focus on key metrics.\n\n# Output Format\nExecutive summary (200 words), followed by bullet points.",favorite:!1},{name:"Code Debugging Assistant",tags:"coding, debug, tech",type:"pre-built",content:"# Your Role\nSenior Developer\n\n# Your Task\nIdentify and fix bugs in the provided code snippet.\n\n# Relevant Background Information\nCode is in Python, prioritize efficiency.\n\n# Output Format\nExplanation of issue, corrected code block.",favorite:!1},{name:"Content Generator",tags:"marketing, content, quick",type:"pre-built",content:"# Your Role\nContent Writer\n\n# Your Task\nWrite a 500-word blog post on the given topic.\n\n# Relevant Background Information\nCasual tone, SEO-friendly.\n\n# Output Format\nTitle, intro, 3 sections, conclusion.",favorite:!1}],t="1.0.0";function a(e,t){let a;return function(...n){clearTimeout(a),a=setTimeout((()=>e.apply(this,n)),t)}}const n=(e,t)=>{let a=0;return function(...n){const o=Date.now();o-a>=t&&(a=o,e.apply(this,n))}};let o=[],s=!1,l=null,r=null,c=null,i=null;function d(e,t){e.disabled=t}document.addEventListener("DOMContentLoaded",(()=>{const m={searchBox:document.getElementById("searchBox"),typeSelect:document.getElementById("typeSelect"),dropdownResults:document.getElementById("dropdownResults"),template:document.getElementById("template"),templateName:document.getElementById("templateName"),templateTags:document.getElementById("templateTags"),promptArea:document.getElementById("promptArea"),buttons:document.getElementById("buttons"),fetchBtns:document.querySelectorAll("#fetchBtn, #fetchBtn2"),fetchBtn2:document.getElementById("fetchBtn2"),saveBtn:document.getElementById("saveBtn"),saveAsBtn:document.getElementById("saveAsBtn"),deleteBtn:document.getElementById("deleteBtn"),clearSearch:document.getElementById("clearSearch"),clearPrompt:document.getElementById("clearPrompt"),clearAllBtn:document.getElementById("clearAllBtn"),sendBtn:document.getElementById("sendBtn"),favoriteSuggestions:document.getElementById("favoriteSuggestions"),fullscreenToggle:document.getElementById("fullscreenToggle"),closeBtn:document.getElementById("closeBtn"),minimizeBtn:document.getElementById("minimizeBtn"),newBtn:document.getElementById("newBtn"),overlay:document.getElementById("overlay"),confirmationOverlay:document.getElementById("confirmationOverlay"),toast:document.getElementById("toast"),themeToggle:document.getElementById("themeToggle")},u=Object.entries(m).filter((([e,t])=>!t)).map((([e])=>e));u.length>0?(console.error("Missing DOM elements:",u),k("Error: Extension UI failed to load. Please reload the extension.",3e3,"red",[],"init")):console.log("All DOM elements found:",Object.keys(m));let p,g=null,v="light",f=null,h=0,y=!1,B=[];function T(){const e={popupState:{name:m.templateName.value,tags:m.templateTags.value,content:m.promptArea.value,selectedName:g},theme:v,isFullscreen:y,extensionVersion:t};chrome.storage.local.set(e)}function E(){chrome.storage.local.set({nextIndex:h})}function b(){f={name:m.templateName.value,tags:m.templateTags.value,content:m.promptArea.value,selectedName:g,templates:null}}function k(e,t=4e3,a="red",n=[],l){if(console.log("Queueing toast:",{message:e,duration:t,type:a,hasButtons:n.length>0,operationId:l}),n.length>0&&-1!==o.findIndex((t=>t.message===e&&t.buttons.length>0)))console.log("Duplicate confirmation toast found, skipping");else{if(l!==c){if(s){console.log(`New operation ${l}, closing current toast and clearing queue`);const e=m.toast.className.includes("confirmation")&&o[0]||{buttons:[]},t=e.buttons.find((e=>"No"===e.text))?.callback;x(t)}o=[],c=l}l===c?(o.push({message:e,duration:t,type:a,buttons:n,operationId:l}),s||A()):console.log(`Toast for operation ${l} ignored, current operation is ${c}`)}}function x(e){console.log("Closing toast, clearing autoHideTimeout"),clearTimeout(l),l=null,clearTimeout(i),r&&(document.removeEventListener("click",r),r=null,console.log("Outside click listener removed in closeToast")),m.toast.classList.remove("show"),m.toast.classList.add("hide"),m.confirmationOverlay.style.display="none",setTimeout((()=>{m.toast.classList.remove("hide"),m.toast.innerHTML="",s=!1,console.log("Toast closed, executing callback:",!!e),e&&e(),i=setTimeout(A,350)}),300)}function A(){if(0===o.length)return s=!1,void console.log("No toasts in queue, stopping display");clearTimeout(l),l=null,s=!0;const{message:e,duration:t,type:a,buttons:n,operationId:c}=o.shift();console.log("Displaying toast:",{message:e,duration:t,type:a,hasButtons:n.length>0,operationId:c}),m.toast.innerHTML=e;const i=document.createElement("button");if(i.textContent="Ã—",i.className="toast-close-btn",i.setAttribute("aria-label","Close toast"),i.addEventListener("click",(e=>{e.stopPropagation(),console.log("Close button clicked"),r&&(document.removeEventListener("click",r),r=null,console.log("Outside click listener removed on close button click"));const t=n.find((e=>"No"===e.text));x(t?.callback)})),m.toast.appendChild(i),n.length>0){const e=document.createElement("div");e.className="toast-button-container",n.forEach((({text:t,callback:a})=>{const n=document.createElement("button");n.textContent=t,n.className="toast-action-btn",n.setAttribute("aria-label","Yes"===t?"Confirm action":"Cancel action"),n.addEventListener("click",(e=>{e.stopPropagation(),console.log(`Confirmation button clicked: ${t}`),r&&(document.removeEventListener("click",r),r=null,console.log("Outside click listener removed on confirmation button click")),x(a)})),e.appendChild(n)})),m.toast.appendChild(e),m.confirmationOverlay.style.display="block",r=e=>{if(!m.toast.contains(e.target)){console.log("Outside click detected");const e=n.find((e=>"No"===e.text));x((()=>{e&&e.callback&&e.callback()}))}},setTimeout((()=>{console.log("Attaching outside click listener"),document.addEventListener("click",r)}),50)}else console.log(`Setting auto-hide timeout for ${t}ms`),l=setTimeout((()=>{console.log("Auto-hide timeout triggered"),x()}),t);m.toast.className=`toast ${a} ${n.length>0?"confirmation":""}`,m.toast.classList.add("show")}function L(e,t,a=!1){const n=e.trim();if(!n)return k("Template name is required.",3e3,"red",[],"save"),{isValid:!1,sanitizedName:null};if(n.length>50)return k("Template name must be 50 characters or less.",3e3,"red",[],"save"),{isValid:!1,sanitizedName:null};const o=n.replace(/[^a-zA-Z0-9\s]/g,"");return o!==n?(k("Template name can only contain letters, numbers, and spaces.",3e3,"red",[],"save"),{isValid:!1,sanitizedName:null}):t.some((e=>e.name===o&&(a||e.name!==g)))?(k("Template name must be unique.",3e3,"red",[],"save"),{isValid:!1,sanitizedName:null}):{isValid:!0,sanitizedName:o}}function w(e){if(!e)return"";const t=e.split(",").map((e=>e.trim())).filter((e=>e));if(t.length>5)return k("Maximum of 5 tags allowed per template.",3e3,"red",[],"save"),null;const a=t.map((e=>e.replace(/[^a-zA-Z0-9]/g,"").slice(0,20)));return a.some((e=>0===e.length))?(k("Each tag must contain only letters or numbers and be 20 characters or less.",3e3,"red",[],"save"),null):a.join(", ")}function N(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,"")}function S(e){B.unshift(e),B=[...new Set(B)],B.length>10&&(B=B.slice(0,10)),chrome.storage.local.set({recentIndices:B},(()=>{chrome.runtime.lastError&&console.error("Failed to save recent indices:",chrome.runtime.lastError.message)}))}chrome.storage.local.get(["popupState","theme","extensionVersion","recentIndices","templates","nextIndex"],(a=>{const n=a.extensionVersion||"0.0.0";n!==t&&(console.log(`Version updated from ${n} to ${t}. No schema migration needed.`),chrome.storage.local.set({extensionVersion:t}));const o=a.popupState||{};m.templateName.value=o.name||"",m.templateTags.value=o.tags||"",m.promptArea.value=o.content||"",g=o.selectedName||null,v=a.theme||"light",h=a.nextIndex||e.length,B=a.recentIndices||[];const s=a.templates||e.map(((e,t)=>({...e,index:t})));a.templates||chrome.storage.local.set({templates:s}),document.body.className=v,m.fetchBtn2.style.display=m.promptArea.value?"none":"block",O(m.typeSelect.value,"",!1)})),new ResizeObserver((()=>{clearTimeout(p),p=setTimeout((()=>{const e=document.body.clientWidth,t=Math.min(Math.max(e/20,14),24);document.documentElement.style.setProperty("--base-font-size",`${t}px`)}),100)})).observe(document.body),m.templateName.addEventListener("input",a((()=>{let e=m.templateName.value;e.length>50&&(e=e.slice(0,50),m.templateName.value=e);const t=e.replace(/[^a-zA-Z0-9\s]/g,"");t!==e&&(m.templateName.value=t,k("Template name can only contain letters, numbers, and spaces.",3e3,"red",[],"input")),T()}),10)),m.templateTags.addEventListener("input",a((()=>{b();let e=m.templateTags.value;if(e){e=e.replace(/^[,\s]+/g,""),e=e.replace(/,[,\s]*/g,", "),e=e.replace(/\s+/g," ");const t=e.split(", ").map((e=>e.replace(/[^a-zA-Z0-9]/g,"").slice(0,20)));t.length>5&&(k("Maximum of 5 tags allowed per template.",3e3,"red",[],"input"),t.length=5),e=t.join(", "),m.templateTags.value=e}const t=m.templateTags.selectionStart;" "===e[t]&&","===e[t-1]&&(m.templateTags.selectionStart=m.templateTags.selectionEnd=t-1),T()}),10)),m.themeToggle.addEventListener("click",(()=>{v="light"===v?"dark":"light",document.body.className=v,T()})),m.fullscreenToggle.addEventListener("click",(()=>{m.fullscreenToggle.querySelector("svg use").setAttribute("href",y?"sprite.svg#compress":"sprite.svg#fullscreen"),y=!y,T(),chrome.runtime.sendMessage({action:"toggleFullscreen"})})),m.minimizeBtn.addEventListener("click",(()=>{chrome.runtime.sendMessage({action:"closePopup"})})),m.closeBtn.addEventListener("click",(()=>{m.templateName.value="",m.templateTags.value="",m.promptArea.value="",g=null,m.fetchBtn2.style.display="block",m.searchBox.value="",O(m.typeSelect.value,"",!1),T(),chrome.runtime.sendMessage({action:"closePopup"})}));const I=n(((e,t,a)=>{k(e,t,a,[],"new")}),2e3);m.newBtn.addEventListener("click",(()=>{b(),m.templateName.value="",m.templateTags.value="",m.promptArea.value="",g=null,m.fetchBtn2.style.display="block",m.searchBox.value="",O(m.typeSelect.value,"",!1),T(),I("New template created.",3e3,"green")})),m.clearSearch.addEventListener("click",(()=>{m.searchBox.value="",O(m.typeSelect.value,"",!1),m.searchBox.focus()})),m.clearPrompt.addEventListener("click",(()=>{b(),m.promptArea.value="",m.fetchBtn2.style.display="block",m.promptArea.focus(),T()}));const C=n(((e,t,a)=>{k(e,t,a,[],"clearAll")}),2e3);function P(e){const t=setTimeout((()=>{k("Error: No response from tab. Please activate a supported webpage.",3e3,"red",[],"fetch"),e(null)}),5e3);chrome.runtime.sendMessage({action:"getTargetTabId"},(a=>{clearTimeout(t),a&&a.tabId?e(a.tabId):(k("Error: No valid tab selected. Please activate a supported webpage.",3e3,"red",[],"fetch"),e(null))}))}function O(t,a="",n=!1){chrome.storage.local.get(["templates"],(o=>{console.log(o);let s=o.templates||e.map(((e,t)=>({...e,index:t})));m.dropdownResults.innerHTML="",m.favoriteSuggestions.innerHTML="";let l=s.filter((e=>"all"===t||e.type===t));a?(l=l.filter((e=>e.name.toLowerCase().includes(a)||e.tags.toLowerCase().includes(a))),l.sort(((e,t)=>{const n=e.name.toLowerCase().indexOf(a)+e.tags.toLowerCase().indexOf(a),o=t.name.toLowerCase().indexOf(a)+t.tags.toLowerCase().indexOf(a);return n!==o?n-o:e.name.localeCompare(t.name)}))):l.sort(((e,t)=>{const a=B.indexOf(e.index),n=B.indexOf(t.index);return-1===a&&-1===n?e.name.localeCompare(t.name):-1===a?1:-1===n?-1:a-n})),n&&l.forEach(((e,t)=>{const a=document.createElement("div");a.textContent=(e.favorite,`${e.name} (${e.tags})`),a.setAttribute("role","option"),a.setAttribute("aria-selected",g===e.name),m.overlay.style.display="block",m.dropdownResults.style.display="block",m.dropdownResults.classList.add("show"),a.addEventListener("click",(t=>{t.target.classList.contains("favorite-toggle")||(g=e.name,m.templateName.value=e.name,m.templateTags.value=e.tags,m.promptArea.value=e.content,m.searchBox.value="",m.dropdownResults.innerHTML="",m.fetchBtn2.style.display=e.content?"none":"block",m.overlay.style.display="none",m.dropdownResults.style.display="none",m.dropdownResults.classList.remove("show"),T(),m.promptArea.focus())})),a.innerHTML+=`<button class="favorite-toggle ${e.favorite?"favorited":"unfavorited"}" data-name="${e.name}" aria-label="${e.favorite?"Unfavorite":"Favorite"} template">${e.favorite?"â˜…":"â˜†"}</button>`,m.dropdownResults.appendChild(a)}));const r=s.filter((e=>e.favorite));r.length>0?(r.sort(((e,t)=>{const a=B.indexOf(e.index),n=B.indexOf(t.index);return-1===a&&-1===n?e.name.localeCompare(t.name):-1===a?1:-1===n?-1:a-n})),m.favoriteSuggestions.classList.remove("d-none"),r.forEach((e=>{const t=document.createElement("span");t.textContent=e.name,t.className="favorite-suggestion",t.setAttribute("role","button"),t.setAttribute("tabindex","0"),t.addEventListener("click",(()=>{g=e.name,m.templateName.value=e.name,m.templateTags.value=e.tags,m.promptArea.value=e.content,m.searchBox.value="",m.fetchBtn2.style.display=e.content?"none":"block",T(),m.promptArea.focus()})),t.addEventListener("keydown",(e=>{"Enter"!==e.key&&" "!==e.key||t.click()})),m.favoriteSuggestions.appendChild(t)}))):m.favoriteSuggestions.classList.add("d-none")}))}function M(e,t,a=!1,n){!function(e){chrome.storage.local.get(null,(t=>{const a=JSON.stringify(t);(new TextEncoder).encode(a).length>4718592&&k("Warning: Storage is nearly full (90% of 5MB limit). Please delete unused templates.",5e3,"red",[],"save"),e()}))}((()=>{const o=setTimeout((()=>{d(n,!1),k("Operation timed out. Please try again.",3e3,"red",[],"save")}),5e3);chrome.storage.local.set({templates:e},(()=>{if(clearTimeout(o),chrome.runtime.lastError){const e=chrome.runtime.lastError.message;e.includes("QUOTA_BYTES_PER_ITEM")?k("Template size exceeds 8KB limit. Please reduce the size.",3e3,"red",[],"save"):e.includes("QUOTA_BYTES")?k("Total storage limit (5MB) exceeded. Please delete unused templates.",3e3,"red",[],"save"):k("Failed to save template: "+e,3e3,"red",[],"save"),console.error("Local storage error:",e)}else k(a?"Template saved. Press Ctrl+Z to undo.":"Template updated. Press Ctrl+Z to undo.",3e3,"green",[],"save"),t();d(n,!1)}))}))}function R(t,a,n){chrome.storage.local.get(["templates"],(o=>{let s=o.templates||e.map(((e,t)=>({...e,index:t})));b(),f.templates=[...s];const l={name:t,tags:a,content:N(m.promptArea.value),type:"custom",favorite:!1,index:h};s.push(l),S(h),h++,M(s,(()=>{g=t,m.templateName.value=t,O(m.typeSelect.value,"",!1),T(),E()}),!0,n)}))}let z;m.clearAllBtn.addEventListener("click",(()=>{b(),m.templateName.value="",m.templateTags.value="",m.promptArea.value="",g=null,m.fetchBtn2.style.display="block",m.searchBox.value="",O(m.typeSelect.value,"",!1),T(),C("All fields cleared.",3e3,"green")})),document.addEventListener("keydown",(e=>{if("Escape"===e.key)if(s&&m.toast.className.includes("confirmation")&&cancelToast()){const e=o[0].buttons.find((e=>"No"===e.text));x(e?.callback)}else chrome.runtime.sendMessage({action:"closePopup"})})),m.promptArea.addEventListener("keydown",(e=>{if("Tab"===e.key){e.preventDefault();const t=m.promptArea.selectionStart,a=m.promptArea.selectionEnd,n=m.promptArea.value;m.promptArea.value=n.substring(0,t)+"  "+n.substring(a),m.promptArea.selectionStart=m.promptArea.selectionEnd=t+2,T()}})),m.promptArea.addEventListener("input",(()=>{b(),m.promptArea.value=N(m.promptArea.value),m.fetchBtn2.style.display=m.promptArea.value?"none":"block",T()})),m.templateTags.addEventListener("keydown",(e=>{const t=m.templateTags.selectionStart,a=m.templateTags.value;return"Backspace"===e.key&&t>0&&" "===a[t-1]&&","===a[t-2]?(e.preventDefault(),m.templateTags.value=a.slice(0,t-2)+a.slice(t),m.templateTags.selectionStart=m.templateTags.selectionEnd=t-2,b(),void T()):"Delete"===e.key&&t<a.length&&","===a[t]&&" "===a[t+1]?(e.preventDefault(),m.templateTags.value=a.slice(0,t)+a.slice(t+2),m.templateTags.selectionStart=m.templateTags.selectionEnd=t,b(),void T()):"ArrowLeft"===e.key&&t>1&&" "===a[t-1]&&","===a[t-2]?(e.preventDefault(),void(m.templateTags.selectionStart=m.templateTags.selectionEnd=t-2)):"ArrowRight"===e.key&&t<a.length-1&&","===a[t]&&" "===a[t+1]?(e.preventDefault(),void(m.templateTags.selectionStart=m.templateTags.selectionEnd=t+2)):void 0})),m.templateTags.addEventListener("click",(()=>{const e=m.templateTags.selectionStart,t=m.templateTags.value;e>0&&" "===t[e]&&","===t[e-1]&&(m.templateTags.selectionStart=m.templateTags.selectionEnd=e-1)})),m.searchBox.addEventListener("focus",(()=>{O(m.typeSelect.value,m.searchBox.value.toLowerCase(),!0)})),m.searchBox.addEventListener("input",(()=>{O(m.typeSelect.value,m.searchBox.value.toLowerCase(),!0)})),m.typeSelect.addEventListener("change",(()=>{O(m.typeSelect.value,m.searchBox.value.toLowerCase(),!0)})),document.addEventListener("click",(e=>{m.searchBox.contains(e.target)||m.dropdownResults.contains(e.target)||m.themeToggle.contains(e.target)||m.typeSelect.contains(e.target)||(m.dropdownResults.innerHTML="",m.overlay.style.display="none",m.dropdownResults.style.display="none",m.dropdownResults.classList.remove("show"))})),m.saveBtn.addEventListener("click",(()=>{d(m.saveBtn,!0),chrome.storage.local.get(["templates"],(t=>{let a=t.templates||e.map(((e,t)=>({...e,index:t})));const n=L(m.templateName.value,a);if(!n.isValid)return m.templateName.focus(),void d(m.saveBtn,!1);const o=n.sanitizedName,s=m.templateTags.value,l=w(s);if(null===l)return m.templateTags.focus(),void d(m.saveBtn,!1);const r=N(m.promptArea.value);if(!r.trim())return k("Prompt content is required to save a template.",3e3,"red",[],"save"),m.promptArea.focus(),void d(m.saveBtn,!1);if(!s.trim())return m.toast.focus(),void k("No tags provided. Save without tags?",0,"red",[{text:"Yes",callback:()=>{if(g){const e=a.find((e=>e.name===g));if(!e)return k("Selected template not found.",3e3,"red",[],"save"),void d(m.saveBtn,!1);if(m.templateName.value===e.name&&w(m.templateTags.value)===e.tags&&m.promptArea.value===e.content)return k("No changes to save.",3e3,"red",[],"save"),void d(m.saveBtn,!1);b(),f.templates=[...a];const t=a.findIndex((e=>e.name===g));a[t]={name:o,tags:l,content:r,type:"custom",favorite:e.favorite||!1,index:e.index},M(a,(()=>{g=o,O(m.typeSelect.value,"",!1),T()}),!1,m.saveBtn)}else{b(),f.templates=[...a];const e={name:o,tags:l,content:r,type:"custom",favorite:!1,index:h};a.push(e),S(h),h++,M(a,(()=>{g=o,O(m.typeSelect.value,"",!1),T(),E()}),!0,m.saveBtn)}}},{text:"No",callback:()=>{m.templateTags.focus(),d(m.saveBtn,!1)}}],"save");if(g){const e=a.find((e=>e.name===g));if(!e)return k("Selected template not found.",3e3,"red",[],"save"),void d(m.saveBtn,!1);if(m.templateName.value===e.name&&w(m.templateTags.value)===e.tags&&m.promptArea.value===e.content)return k("No changes to save.",3e3,"red",[],"save"),void d(m.saveBtn,!1);b(),f.templates=[...a];const t=a.findIndex((e=>e.name===g));a[t]={name:o,tags:l,content:r,type:"custom",favorite:e.favorite||!1,index:e.index},M(a,(()=>{g=o,O(m.typeSelect.value,"",!1),T()}),!1,m.saveBtn)}else{b(),f.templates=[...a];const e={name:o,tags:l,content:r,type:"custom",favorite:!1,index:h};a.push(e),S(h),h++,M(a,(()=>{g=o,O(m.typeSelect.value,"",!1),T(),E()}),!0,m.saveBtn)}}))})),m.saveAsBtn.addEventListener("click",(()=>{d(m.saveAsBtn,!0),chrome.storage.local.get(["templates"],(t=>{const a=t.templates||e.map(((e,t)=>({...e,index:t}))),n=L(m.templateName.value,a,!0);if(!n.isValid)return m.templateName.focus(),void d(m.saveAsBtn,!1);const o=n.sanitizedName,s=m.templateTags.value,l=w(s);return null===l?(m.templateTags.focus(),void d(m.saveAsBtn,!1)):N(m.promptArea.value).trim()?s.trim()?void R(o,l,m.saveAsBtn):(m.toast.focus(),void k("No tags provided. Save without tags?",0,"red",[{text:"Yes",callback:()=>{R(o,l,m.saveAsBtn)}},{text:"No",callback:()=>{m.templateTags.focus(),d(m.saveAsBtn,!1)}}],"saveAs")):(k("Prompt content is required to save a template.",3e3,"red",[],"saveAs"),m.promptArea.focus(),void d(m.saveAsBtn,!1))}))})),m.fetchBtns.forEach((e=>{e.addEventListener("click",(()=>{d(e,!0);const t=setTimeout((()=>{d(e,!1),k("Fetch operation timed out. Please try again.",3e3,"red",[],"fetch")}),5e3);P((a=>{if(!a)return clearTimeout(t),k("Error: No valid tab selected. Please activate a supported webpage.",3e3,"red",[],"fetch"),void d(e,!1);chrome.tabs.sendMessage(a,{action:"getPrompt"},(a=>{if(clearTimeout(t),chrome.runtime.lastError)return console.error("Fetch error:",chrome.runtime.lastError.message),k("Failed to fetch prompt. Please refresh the page.",3e3,"red",[],"fetch"),void d(e,!1);a&&a.prompt?(b(),m.promptArea.value=N(a.prompt),m.fetchBtn2.style.display="none",T()):k("No input found on the page.",3e3,"red",[],"fetch"),d(e,!1)}))}))}))})),m.sendBtn.addEventListener("click",(()=>{d(m.sendBtn,!0);const t=setTimeout((()=>{d(m.sendBtn,!1),k("Send operation timed out. Please try again.",3e3,"red",[],"send")}),5e3);P((a=>{if(!a)return clearTimeout(t),k("Error: No valid tab selected. Please activate a supported webpage.",3e3,"red",[],"send"),void d(m.sendBtn,!1);chrome.tabs.sendMessage(a,{action:"sendPrompt",prompt:N(m.promptArea.value)},(a=>{if(clearTimeout(t),chrome.runtime.lastError)return console.error("Send error:",chrome.runtime.lastError.message),k("Failed to send prompt. Please refresh the page.",3e3,"red",[],"send"),void d(m.sendBtn,!1);a&&a.success?g?chrome.storage.local.get(["templates"],(t=>{const a=(t.templates||e.map(((e,t)=>({...e,index:t})))).find((e=>e.name===g));a&&S(a.index),chrome.runtime.sendMessage({action:"closePopup"}),d(m.sendBtn,!1)})):(chrome.runtime.sendMessage({action:"closePopup"}),d(m.sendBtn,!1)):(k("Failed to send prompt. Please refresh the page.",3e3,"red",[],"send"),d(m.sendBtn,!1))}))}))})),m.deleteBtn.addEventListener("click",(()=>{if(d(m.deleteBtn,!0),!g)return k("Please select a template to delete.",3e3,"red",[],"delete"),void d(m.deleteBtn,!1);chrome.storage.local.get(["templates","recentIndices"],(t=>{const a=t.templates||e.map(((e,t)=>({...e,index:t}))),n="pre-built"===a.find((e=>e.name===g)).type;k(`Are you sure you want to delete "${g}"?${n?"<br>This is a pre-built template.":""}`,0,"red",[{text:"Yes",callback:()=>{b(),f.templates=[...a];const e=a.findIndex((e=>e.name===g)),t=a[e].index;a.splice(e,1),B=B.filter((e=>e!==t));const n=setTimeout((()=>{d(m.deleteBtn,!1),k("Delete operation timed out. Please try again.",3e3,"red",[],"delete")}),5e3);chrome.storage.local.set({templates:a,recentIndices:B},(()=>{clearTimeout(n),chrome.runtime.lastError?k("Failed to delete template: "+chrome.runtime.lastError.message,3e3,"red",[],"delete"):(k("Template deleted successfully. Press Ctrl+Z to undo.",3e3,"green",[],"delete"),g=null,m.templateName.value="",m.templateTags.value="",m.promptArea.value="",m.searchBox.value="",m.fetchBtn2.style.display="block",O(m.typeSelect.value,"",!1),T()),d(m.deleteBtn,!1)}))}},{text:"No",callback:()=>{d(m.deleteBtn,!1)}}],"delete")}))})),document.addEventListener("keydown",(e=>{e.ctrlKey&&"z"===e.key&&f&&(m.templateName.value=f.name||"",m.templateTags.value=f.tags||"",m.promptArea.value=f.content||"",g=f.selectedName||null,f.templates&&chrome.storage.local.set({templates:f.templates},(()=>{O(m.typeSelect.value,"",!1)})),m.fetchBtn2.style.display=m.promptArea.value?"none":"block",k("Action undone successfully.",3e3,"green",[],"undo"),f=null,T())})),document.addEventListener("click",(t=>{if(t.target.classList.contains("favorite-toggle")){const a=t.target.dataset.name;chrome.storage.local.get(["templates"],(t=>{const n=t.templates||e.map(((e,t)=>({...e,index:t}))),o=n.find((e=>e.name===a));if(o){if(!o.favorite&&n.filter((e=>e.favorite)).length>=10)return void k("Maximum of 10 favorite templates allowed.",3e3,"red",[],"favorite");o.favorite=!o.favorite,chrome.storage.local.set({templates:n},(()=>{O(m.typeSelect.value,m.searchBox.value.toLowerCase(),!0)}))}}))}})),document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach((e=>new bootstrap.Tooltip(e,{delay:{show:500,hide:50}}))),m.dropdownResults.addEventListener("keydown",(e=>{const t=m.dropdownResults.querySelectorAll("div"),a=document.activeElement;let n=Array.from(t).indexOf(a);"ArrowDown"===e.key?(e.preventDefault(),n=(n+1)%t.length,t[n].focus()):"ArrowUp"===e.key?(e.preventDefault(),n=(n-1+t.length)%t.length,t[n].focus()):"Enter"===e.key&&(e.preventDefault(),a.click())})),document.addEventListener("mousemove",(()=>{clearTimeout(z),z=setTimeout((()=>{m.clearSearch.style.display=m.searchBox.value?"block":"none",m.clearPrompt.style.display=m.promptArea.value?"block":"none"}),50)}))}))})();