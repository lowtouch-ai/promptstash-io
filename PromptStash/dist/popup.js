(()=>{"use strict";const e=[{name:"Business Analyst Report",tags:"analysis, report, business",type:"pre-built",content:"# Your Role\nBusiness Analyst\n\n# Your Task\nAnalyze the provided data and generate a concise report.\n\n# Relevant Background Information\nUse formal tone, focus on key metrics.\n\n# Output Format\nExecutive summary (200 words), followed by bullet points.",favorite:!1},{name:"Code Debugging Assistant",tags:"coding, debug, tech",type:"pre-built",content:"# Your Role\nSenior Developer\n\n# Your Task\nIdentify and fix bugs in the provided code snippet.\n\n# Relevant Background Information\nCode is in Python, prioritize efficiency.\n\n# Output Format\nExplanation of issue, corrected code block.",favorite:!1},{name:"Content Generator",tags:"marketing, content, quick",type:"pre-built",content:"# Your Role\nContent Writer\n\n# Your Task\nWrite a 500-word blog post on the given topic.\n\n# Relevant Background Information\nCasual tone, SEO-friendly.\n\n# Output Format\nTitle, intro, 3 sections, conclusion.",favorite:!1}],t="1.0.0";document.addEventListener("DOMContentLoaded",(()=>{const a={searchBox:document.getElementById("searchBox"),typeSelect:document.getElementById("typeSelect"),dropdownResults:document.getElementById("dropdownResults"),template:document.getElementById("template"),templateName:document.getElementById("templateName"),templateTags:document.getElementById("templateTags"),promptArea:document.getElementById("promptArea"),buttons:document.getElementById("buttons"),fetchBtns:document.querySelectorAll("#fetchBtn, #fetchBtn2"),fetchBtn2:document.getElementById("fetchBtn2"),saveBtn:document.getElementById("saveBtn"),saveAsBtn:document.getElementById("saveAsBtn"),deleteBtn:document.getElementById("deleteBtn"),clearSearch:document.getElementById("clearSearch"),clearPrompt:document.getElementById("clearPrompt"),clearAllBtn:document.getElementById("clearAllBtn"),sendBtn:document.getElementById("sendBtn"),favoriteSuggestions:document.getElementById("favoriteSuggestions"),fullscreenToggle:document.getElementById("fullscreenToggle"),closeBtn:document.getElementById("closeBtn"),minimizeBtn:document.getElementById("minimizeBtn"),newBtn:document.getElementById("newBtn"),overlay:document.getElementById("overlay"),toast:document.getElementById("toast"),themeToggle:document.getElementById("themeToggle")},n=Object.entries(a).filter((([e,t])=>!t)).map((([e])=>e));n.length>0?(console.error("Missing DOM elements:",n),g("Extension UI failed to load. Please reload the extension.")):console.log("All DOM elements found:",Object.keys(a));let o,s,l=null,r="light",c=null,i=0,m=!1,d=[];function p(){const e={popupState:{name:a.templateName.value,tags:a.templateTags.value,content:a.promptArea.value,selectedName:l},theme:r,nextIndex:i,isFullscreen:m,extensionVersion:t};chrome.storage.local.set(e,(()=>{chrome.runtime.lastError&&(console.error("Failed to save state:",chrome.runtime.lastError.message),g("Error saving extension state. Some data may not persist."))})),chrome.storage.sync.set({recentIndices:d},(()=>{chrome.runtime.lastError&&(console.error("Failed to save recent indices:",chrome.runtime.lastError.message),g("Error saving recent indices. Some data may not persist."))}))}function u(){c={name:a.templateName.value,tags:a.templateTags.value,content:a.promptArea.value,selectedName:l,templates:null}}function g(e){a.toast.textContent=e,a.toast.classList.add("show"),setTimeout((()=>a.toast.classList.remove("show")),4e3)}function v(e){d.unshift(e),d=[...new Set(d)],d.length>20&&(d=d.slice(0,20)),p()}function y(e){return e?e.split(",").map((e=>e.trim())).filter((e=>e)).join(", "):""}function f(e){const t=setTimeout((()=>{g("No response from tab. Please activate a supported webpage."),e(null)}),5e3);chrome.runtime.sendMessage({action:"getTargetTabId"},(a=>{clearTimeout(t),a&&a.tabId?e(a.tabId):(g("No valid tab selected. Please activate a supported webpage."),e(null))}))}function h(t,n="",o=!1){chrome.storage.sync.get(["templates"],(s=>{let r=s.templates||e.map(((e,t)=>({...e,index:t})));a.dropdownResults.innerHTML="",a.favoriteSuggestions.innerHTML="";let c=r.filter((e=>"all"===t||e.type===t));n?(c=c.filter((e=>e.name.toLowerCase().includes(n)||e.tags.toLowerCase().includes(n))),c.sort(((e,t)=>{const a=e.name.toLowerCase().indexOf(n)+e.tags.toLowerCase().indexOf(n),o=t.name.toLowerCase().indexOf(n)+t.tags.toLowerCase().indexOf(n);return a!==o?a-o:e.name.localeCompare(t.name)}))):c.sort(((e,t)=>{const a=d.indexOf(e.index),n=d.indexOf(t.index);return-1===a&&-1===n?e.name.localeCompare(t.name):-1===a?1:-1===n?-1:a-n})),o&&c.forEach(((e,t)=>{const n=document.createElement("div");n.textContent=(e.favorite,`${e.name} (${e.tags})`),n.setAttribute("role","option"),n.setAttribute("aria-selected",l===e.name),a.overlay.style.display="block",a.dropdownResults.style.display="block",n.addEventListener("click",(t=>{t.target.classList.contains("favorite-toggle")||(l=e.name,a.templateName.value=e.name,a.templateTags.value=e.tags,a.promptArea.value=e.content,a.searchBox.value="",a.dropdownResults.innerHTML="",a.fetchBtn2.style.display=e.content?"none":"block",a.overlay.style.display="none",a.dropdownResults.style.display="none",p(),a.promptArea.focus())})),n.innerHTML+=`<button class="favorite-toggle ${e.favorite?"favorited":"unfavorited"}" data-name="${e.name}" aria-label="${e.favorite?"Unfavorite":"Favorite"} template">${e.favorite?"★":"☆"}</button>`,a.dropdownResults.appendChild(n)}));const i=r.filter((e=>e.favorite));i.length>0?(i.sort(((e,t)=>{const a=d.indexOf(e.index),n=d.indexOf(t.index);return-1===a&&-1===n?e.name.localeCompare(t.name):-1===a?1:-1===n?-1:a-n})),a.favoriteSuggestions.classList.remove("d-none"),i.forEach((e=>{const t=document.createElement("span");t.textContent=e.name,t.className="favorite-suggestion",t.setAttribute("role","button"),t.setAttribute("tabindex","0"),t.addEventListener("click",(()=>{l=e.name,a.templateName.value=e.name,a.templateTags.value=e.tags,a.promptArea.value=e.content,a.searchBox.value="",a.fetchBtn2.style.display=e.content?"none":"block",p(),a.promptArea.focus()})),t.addEventListener("keydown",(e=>{"Enter"!==e.key&&" "!==e.key||t.click()})),a.favoriteSuggestions.appendChild(t)}))):a.favoriteSuggestions.classList.add("d-none")}))}function E(e,t,a=!1){const n=function(e){const t=JSON.stringify(e),a=(new TextEncoder).encode(t).length;return{isValid:a<=8192,size:a}}({templates:e});n.isValid?chrome.storage.sync.set({templates:e},(()=>{chrome.runtime.lastError?(g("Failed to save template: "+chrome.runtime.lastError.message),console.error("Sync storage error:",chrome.runtime.lastError)):(g(a?"Template saved. Press Ctrl+Z to undo.":"Template updated. Press Ctrl+Z to undo."),t())})):g(`Template size (${(n.size/1024).toFixed(2)} KB) exceeds sync limit of 8 KB per item. Please reduce the size.`)}chrome.storage.local.get(["popupState","theme","nextIndex","extensionVersion"],(n=>{chrome.storage.sync.get(["recentIndices","templates"],(o=>{const s=n.extensionVersion||"0.0.0";s!==t&&(console.log(`Version updated from ${s} to ${t}. No schema migration needed.`),chrome.storage.local.set({extensionVersion:t},(()=>{chrome.runtime.lastError&&(console.error("Failed to save extension version:",chrome.runtime.lastError.message),g("Error saving extension version. Some data may not persist."))})));const c=n.popupState||{};a.templateName.value=c.name||"",a.templateTags.value=c.tags||"",a.promptArea.value=c.content||"",l=c.selectedName||null,r=n.theme||"light",i=n.nextIndex||e.length,d=o.recentIndices||[];const m=o.templates||e.map(((e,t)=>({...e,index:t})));o.templates||chrome.storage.sync.set({templates:m},(()=>{chrome.runtime.lastError&&(console.error("Failed to initialize templates:",chrome.runtime.lastError.message),g("Error initializing templates. Some data may not be saved."))})),document.body.className=r,a.fetchBtn2.style.display=a.promptArea.value?"none":"block",h(a.typeSelect.value,"",!1)}))})),new ResizeObserver((()=>{clearTimeout(o),o=setTimeout((()=>{const e=document.body.clientWidth,t=Math.min(Math.max(e/20,14),24);document.documentElement.style.setProperty("--base-font-size",`${t}px`)}),100)})).observe(document.body),a.themeToggle.addEventListener("click",(()=>{r="light"===r?"dark":"light",document.body.className=r,p()})),a.fullscreenToggle.addEventListener("click",(()=>{a.fullscreenToggle.querySelector("svg use").setAttribute("href",m?"sprite.svg#compress":"sprite.svg#fullscreen"),m=!m,p(),chrome.runtime.sendMessage({action:"toggleFullscreen"})})),a.minimizeBtn.addEventListener("click",(()=>{chrome.runtime.sendMessage({action:"closePopup"})})),a.closeBtn.addEventListener("click",(()=>{a.templateName.value="",a.templateTags.value="",a.promptArea.value="",l=null,a.fetchBtn2.style.display="block",a.searchBox.value="",h(a.typeSelect.value,"",!1),p(),chrome.runtime.sendMessage({action:"closePopup"})})),a.newBtn.addEventListener("click",(()=>{u(),a.templateName.value="",a.templateTags.value="",a.promptArea.value="",l=null,a.fetchBtn2.style.display="block",a.searchBox.value="",h(a.typeSelect.value,"",!1),p()})),a.clearSearch.addEventListener("click",(()=>{a.searchBox.value="",h(a.typeSelect.value,"",!1),a.searchBox.focus()})),a.clearPrompt.addEventListener("click",(()=>{u(),a.promptArea.value="",a.fetchBtn2.style.display="block",a.promptArea.focus(),p()})),a.clearAllBtn.addEventListener("click",(()=>{u(),a.templateName.value="",a.templateTags.value="",a.promptArea.value="",l=null,a.fetchBtn2.style.display="block",a.searchBox.value="",h(a.typeSelect.value,"",!1),p()})),document.addEventListener("keydown",(e=>{"Escape"===e.key&&chrome.runtime.sendMessage({action:"closePopup"})})),a.promptArea.addEventListener("keydown",(e=>{if("Tab"===e.key){e.preventDefault();const t=a.promptArea.selectionStart,n=a.promptArea.selectionEnd,o=a.promptArea.value;a.promptArea.value=o.substring(0,t)+"  "+o.substring(n),a.promptArea.selectionStart=a.promptArea.selectionEnd=t+2,p()}})),a.promptArea.addEventListener("input",(()=>{u(),a.fetchBtn2.style.display=a.promptArea.value?"none":"block",p()})),a.templateTags.addEventListener("keydown",(e=>{const t=a.templateTags.selectionStart,n=a.templateTags.value;return"Backspace"===e.key&&t>0&&" "===n[t-1]&&","===n[t-2]?(e.preventDefault(),a.templateTags.value=n.slice(0,t-2)+n.slice(t),a.templateTags.selectionStart=a.templateTags.selectionEnd=t-2,u(),void p()):"Delete"===e.key&&t<n.length&&","===n[t]&&" "===n[t+1]?(e.preventDefault(),a.templateTags.value=n.slice(0,t)+n.slice(t+2),a.templateTags.selectionStart=a.templateTags.selectionEnd=t,u(),void p()):"ArrowLeft"===e.key&&t>1&&" "===n[t-1]&&","===n[t-2]?(e.preventDefault(),void(a.templateTags.selectionStart=a.templateTags.selectionEnd=t-2)):"ArrowRight"===e.key&&t<n.length-1&&","===n[t]&&" "===n[t+1]?(e.preventDefault(),void(a.templateTags.selectionStart=a.templateTags.selectionEnd=t+2)):void 0})),a.templateTags.addEventListener("click",(()=>{const e=a.templateTags.selectionStart,t=a.templateTags.value;e>0&&" "===t[e]&&","===t[e-1]&&(a.templateTags.selectionStart=a.templateTags.selectionEnd=e-1)})),a.templateTags.addEventListener("input",(()=>{u();let e=a.templateTags.value;e&&(e=e.replace(/^[,\s]+/g,""),e=e.replace(/,[,\s]*/g,", "),e=e.replace(/\s+/g," "),e=e.replace(/[^a-zA-Z0-9_, ]/g,""),a.templateTags.value=e);const t=a.templateTags.selectionStart;" "===e[t]&&","===e[t-1]&&(a.templateTags.selectionStart=a.templateTags.selectionEnd=t-1),p()})),a.searchBox.addEventListener("focus",(()=>{h(a.typeSelect.value,a.searchBox.value.toLowerCase(),!0)})),a.searchBox.addEventListener("input",(()=>{h(a.typeSelect.value,a.searchBox.value.toLowerCase(),!0)})),a.typeSelect.addEventListener("change",(()=>{h(a.typeSelect.value,a.searchBox.value.toLowerCase(),!0)})),document.addEventListener("click",(e=>{a.searchBox.contains(e.target)||a.dropdownResults.contains(e.target)||a.themeToggle.contains(e.target)||a.typeSelect.contains(e.target)||(a.dropdownResults.innerHTML="",a.overlay.style.display="none",a.dropdownResults.style.display="none")})),a.saveBtn.addEventListener("click",(()=>{l?chrome.storage.sync.get(["templates"],(t=>{let n=t.templates||e.map(((e,t)=>({...e,index:t})));const o=n.find((e=>e.name===l));if(!o)return void g("Selected template not found.");if(a.templateName.value===o.name&&y(a.templateTags.value)===o.tags&&a.promptArea.value===o.content)return void g("No changes to save.");u(),c.templates=[...n];const s=n.findIndex((e=>e.name===l));n[s]={name:a.templateName.value,tags:y(a.templateTags.value),content:a.promptArea.value,type:"custom",favorite:o.favorite||!1,index:o.index},E(n,(()=>{h(a.typeSelect.value,"",!1),p()}))})):g("Please select a template to save changes.")})),a.saveAsBtn.addEventListener("click",(()=>{chrome.storage.sync.get(["templates"],(t=>{const n=t.templates||e.map(((e,t)=>({...e,index:t})));u();let o=a.templateName.value;if(o=o.trim(),n.some((e=>e.name===o)))return g("Name already exists."),void a.templateName.focus();if(!o){g("Name is mandatory."),o="New template";let e=2;const t=o;for(;n.some((e=>e.name===o));)o=`${t} ${e++}`;return a.templateName.value=o,void a.templateName.focus()}const s=y(a.templateTags.value);!function(t,n){chrome.storage.sync.get(["templates"],(o=>{let s=o.templates||e.map(((e,t)=>({...e,index:t})));u(),c.templates=[...s];const r={name:t,tags:n,content:a.promptArea.value,type:"custom",favorite:!1,index:i};s.push(r),E(s,(()=>{l=t,a.templateName.value=t,v(i),i++,h(a.typeSelect.value,"",!1),p()}),!0)}))}(o,s)}))})),a.fetchBtns.forEach((e=>{e.addEventListener("click",(()=>{f((e=>{e?chrome.tabs.sendMessage(e,{action:"getPrompt"},(e=>{if(chrome.runtime.lastError)return console.error("Fetch error:",chrome.runtime.lastError.message),void g("Failed to fetch prompt.\nTry refreshing the page");e&&e.prompt?(u(),a.promptArea.value=e.prompt,a.fetchBtn2.style.display="none",p()):g("No input found on the page.")})):g("No valid tab selected. Please activate a supported webpage.")}))}))})),a.sendBtn.addEventListener("click",(()=>{f((t=>{t?chrome.tabs.sendMessage(t,{action:"sendPrompt",prompt:a.promptArea.value},(t=>{if(chrome.runtime.lastError)return console.error("Send error:",chrome.runtime.lastError.message),void g("Failed to send prompt.\nTry refreshing the page");t&&t.success?l?chrome.storage.sync.get(["templates"],(t=>{const a=(t.templates||e.map(((e,t)=>({...e,index:t})))).find((e=>e.name===l));a&&v(a.index),chrome.runtime.sendMessage({action:"closePopup"})})):chrome.runtime.sendMessage({action:"closePopup"}):g("Failed to send prompt.\nTry refreshing the page")})):g("No valid tab selected. Please activate a supported webpage.")}))})),a.deleteBtn.addEventListener("click",(()=>{l?chrome.storage.sync.get(["templates"],(t=>{const n=t.templates||e.map(((e,t)=>({...e,index:t}))),o="pre-built"===n.find((e=>e.name===l)).type;if(!confirm(`Are you sure you want to delete "${l}"?${o?"\nThis is a pre-built template.":""}`))return;u(),c.templates=[...n];const s=n.findIndex((e=>e.name===l)),r=n[s].index;n.splice(s,1),d=d.filter((e=>e!==r)),chrome.storage.sync.set({templates:n},(()=>{g("Template deleted. Press Ctrl+Z to undo."),l=null,a.templateName.value="",a.templateTags.value="",a.promptArea.value="",a.searchBox.value="",a.fetchBtn2.style.display="block",h(a.typeSelect.value,"",!1),p()}))})):g("Please select a template to delete.")})),document.addEventListener("keydown",(e=>{e.ctrlKey&&"z"===e.key&&c&&(a.templateName.value=c.name||"",a.templateTags.value=c.tags||"",a.promptArea.value=c.content||"",l=c.selectedName||null,c.templates&&chrome.storage.sync.set({templates:c.templates},(()=>{h(a.typeSelect.value,"",!1)})),a.fetchBtn2.style.display=a.promptArea.value?"none":"block",g("Action undone."),c=null,p())})),document.addEventListener("click",(t=>{if(t.target.classList.contains("favorite-toggle")){const n=t.target.dataset.name;chrome.storage.sync.get(["templates"],(t=>{const o=t.templates||e.map(((e,t)=>({...e,index:t}))),s=o.find((e=>e.name===n));s&&(s.favorite=!s.favorite,chrome.storage.sync.set({templates:o},(()=>{h(a.typeSelect.value,a.searchBox.value.toLowerCase(),!0)})))}))}})),a.dropdownResults.addEventListener("keydown",(e=>{const t=a.dropdownResults.querySelectorAll("div[role='option']"),n=document.activeElement;let o=Array.from(t).indexOf(n);"ArrowDown"===e.key?(e.preventDefault(),o=(o+1)%t.length,t[o].focus()):"ArrowUp"===e.key?(e.preventDefault(),o=(o-1+t.length)%t.length,t[o].focus()):"Enter"===e.key&&(e.preventDefault(),n.click())})),document.addEventListener("mousemove",(()=>{clearTimeout(s),s=setTimeout((()=>{a.clearSearch.style.display=a.searchBox.value?"block":"none",a.clearPrompt.style.display=a.promptArea.value?"block":"none"}),50)})),document.addEventListener("click",(e=>{a.searchBox.contains(e.target)||a.dropdownResults.contains(e.target)}))}))})();