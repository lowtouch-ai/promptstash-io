(()=>{"use strict";const e=[{name:"Business Analyst Report",tags:"analysis, report, business",type:"pre-built",content:"# Your Role\nBusiness Analyst\n\n# Your Task\nAnalyze the provided data and generate a concise report.\n\n# Relevant Background Information\nUse formal tone, focus on key metrics.\n\n# Output Format\nExecutive summary (200 words), followed by bullet points.",favorite:!1},{name:"Code Debugging Assistant",tags:"coding, debug, tech",type:"pre-built",content:"# Your Role\nSenior Developer\n\n# Your Task\nIdentify and fix bugs in the provided code snippet.\n\n# Relevant Background Information\nCode is in Python, prioritize efficiency.\n\n# Output Format\nExplanation of issue, corrected code block.",favorite:!1},{name:"Content Generator",tags:"marketing, content, quick",type:"pre-built",content:"# Your Role\nContent Writer\n\n# Your Task\nWrite a 500-word blog post on the given topic.\n\n# Relevant Background Information\nCasual tone, SEO-friendly.\n\n# Output Format\nTitle, intro, 3 sections, conclusion.",favorite:!1}],t="1.0.0";function n(e,t){let n;return function(...a){clearTimeout(n),n=setTimeout((()=>e.apply(this,a)),t)}}let a=[],o=!1,s=null,l=null,r=null,c=null;const i={};let d=!1;function m(e,t){e.disabled=t}document.addEventListener("DOMContentLoaded",(()=>{const u={searchBox:document.getElementById("searchBox"),typeSelect:document.getElementById("typeSelect"),dropdownResults:document.getElementById("dropdownResults"),template:document.getElementById("template"),templateName:document.getElementById("templateName"),templateTags:document.getElementById("templateTags"),promptArea:document.getElementById("promptArea"),buttons:document.getElementById("buttons"),fetchBtns:document.querySelectorAll("#fetchBtn, #fetchBtn2"),fetchBtn2:document.getElementById("fetchBtn2"),saveBtn:document.getElementById("saveBtn"),saveAsBtn:document.getElementById("saveAsBtn"),deleteBtn:document.getElementById("deleteBtn"),clearSearch:document.getElementById("clearSearch"),clearPrompt:document.getElementById("clearPrompt"),clearAllBtn:document.getElementById("clearAllBtn"),sendBtn:document.getElementById("sendBtn"),favoriteSuggestions:document.getElementById("favoriteSuggestions"),fullscreenToggle:document.getElementById("fullscreenToggle"),closeBtn:document.getElementById("closeBtn"),minimizeBtn:document.getElementById("minimizeBtn"),newBtn:document.getElementById("newBtn"),overlay:document.getElementById("overlay"),confirmationOverlay:document.getElementById("confirmationOverlay"),toast:document.getElementById("toast"),themeToggle:document.getElementById("themeToggle")},p=Object.entries(u).filter((([e,t])=>!t)).map((([e])=>e));p.length>0?(console.error("Missing DOM elements:",p),x("Error: Extension UI failed to load. Please reload the extension.",3e3,"red",[],"init")):console.log("All DOM elements found:",Object.keys(u));let g,v=null,f="light",h=null,y=0,B=!1,T=[];function b(){const e={popupState:{name:u.templateName.value,tags:u.templateTags.value,content:u.promptArea.value,selectedName:v},theme:f,isFullscreen:B,extensionVersion:t};chrome.storage.local.set(e)}function k(){chrome.storage.local.set({nextIndex:y})}function E(){h={name:u.templateName.value,tags:u.templateTags.value,content:u.promptArea.value,selectedName:v,templates:null}}function x(e,t=4e3,n="red",s=[],l){console.log("Queueing toast:",{message:e,duration:t,type:n,hasButtons:s.length>0,operationId:l});const c=`${e}|${l}`,m=Date.now();if(0===s.length&&i[c]&&m-i[c]<1010)console.log(`Duplicate toast debounced for key: ${c}`);else{if(i[c]=m,Object.keys(i).forEach((e=>{m-i[e]>7e3&&delete i[e]})),s.length>0&&-1!==a.findIndex((t=>t.message===e&&t.buttons.length>0)))return void console.log("Duplicate confirmation toast found, skipping");if(l!==r){if(o){console.log(`New operation ${l}, closing current toast and clearing queue`),d=!0;const e=u.toast.className.includes("confirmation")&&a[0]||{buttons:[]},t=e.buttons.find((e=>"No"===e.text))?.callback;A(t)}a=[],r=l}l===r?(a.push({message:e,duration:t,type:n,buttons:s,operationId:l}),o||L()):console.log(`Toast for operation ${l} ignored, current operation is ${r}`)}}function A(e){console.log("Closing toast, clearing autoHideTimeout"),clearTimeout(s),s=null,clearTimeout(c),l&&(document.removeEventListener("click",l),l=null,console.log("Outside click listener removed in closeToast")),u.toast.classList.remove("show"),u.toast.classList.add("hide"),u.confirmationOverlay.style.display="none",setTimeout((()=>{u.toast.classList.remove("hide"),u.toast.innerHTML="",o=!1,console.log("Toast closed, executing callback:",!!e),e&&e(),d?(d=!1,L()):c=setTimeout(L,10)}),10)}function L(){if(0===a.length)return o=!1,void console.log("No toasts in queue, stopping display");clearTimeout(s),s=null,o=!0;const{message:e,duration:t,type:n,buttons:r,operationId:c}=a.shift();console.log("Displaying toast:",{message:e,duration:t,type:n,hasButtons:r.length>0,operationId:c}),u.toast.innerHTML=e;const i=document.createElement("button");if(i.textContent="×",i.className="toast-close-btn",i.setAttribute("aria-label","Close toast"),i.addEventListener("click",(e=>{e.stopPropagation(),console.log("Close button clicked"),l&&(document.removeEventListener("click",l),l=null,console.log("Outside click listener removed on close button click"));const t=r.find((e=>"No"===e.text));A(t?.callback)})),u.toast.appendChild(i),r.length>0){const e=document.createElement("div");e.className="toast-button-container",r.forEach((({text:t,callback:n})=>{const a=document.createElement("button");a.textContent=t,a.className="toast-action-btn",a.setAttribute("aria-label","Yes"===t?"Confirm action":"Cancel action"),a.addEventListener("click",(e=>{e.stopPropagation(),console.log(`Confirmation button clicked: ${t}`),l&&(document.removeEventListener("click",l),l=null,console.log("Outside click listener removed on confirmation button click")),A(n)})),e.appendChild(a)})),u.toast.appendChild(e),u.confirmationOverlay.style.display="block",l=e=>{if(!u.toast.contains(e.target)){console.log("Outside click detected");const e=r.find((e=>"No"===e.text));A((()=>{e&&e.callback&&e.callback()}))}},setTimeout((()=>{console.log("Attaching outside click listener"),document.addEventListener("click",l)}),50)}else console.log(`Setting auto-hide timeout for ${t}ms`),s=setTimeout((()=>{console.log("Auto-hide timeout triggered"),A()}),t);u.toast.className=`toast ${n} ${r.length>0?"confirmation":""}`,u.toast.classList.add("show")}function S(e,t,n=!1){const a=e.trim();if(!a)return x("Template name is required.",3e3,"red",[],"save"),{isValid:!1,sanitizedName:null};if(a.length>50)return x("Template name must be 50 characters or less.",3e3,"red",[],"nameLength"),{isValid:!1,sanitizedName:null};const o=a.replace(/[^a-zA-Z0-9\s]/g,"");return o!==a?(x("Template name can only contain letters, numbers, and spaces.",3e3,"red",[],"nameChar"),{isValid:!1,sanitizedName:null}):t.some((e=>e.name===o&&(n||e.name!==v)))?(x("Template name must be unique.",3e3,"red",[],"save"),{isValid:!1,sanitizedName:null}):{isValid:!0,sanitizedName:o}}function I(e){if(!e)return"";const t=e.split(",").map((e=>e.trim())).filter((e=>e));if(t.length>5)return x("Maximum of 5 tags allowed per template.",3e3,"red",[],"tagsLength"),null;const n=t.map((e=>e.replace(/[^a-zA-Z0-9\s]/g,"").slice(0,20)));return n.some((e=>0===e.length))?(x("Each tag must contain only letters or numbers and be 20 characters or less.",3e3,"red",[],"save"),null):n.join(", ")}function w(e){T.unshift(e),T=[...new Set(T)],T.length>10&&(T=T.slice(0,10)),chrome.storage.local.set({recentIndices:T},(()=>{chrome.runtime.lastError&&console.error("Failed to save recent indices:",chrome.runtime.lastError.message)}))}function N(e){const t=setTimeout((()=>{x("Error: No response from tab. Please navigate to a supported AI platform (e.g., grok.com, perplexity.ai, or chatgpt.com).",4e3,"red",[],"fetch"),e(null)}),5e3);chrome.runtime.sendMessage({action:"getTargetTabId"},(n=>{clearTimeout(t),n&&n.tabId?e(n.tabId):(x("Error: This page is not supported. Please navigate to a supported AI platform (e.g., grok.com, perplexity.ai, or chatgpt.com).",4e3,"red",[],"fetch"),e(null))}))}function C(t,n="",a=!1){chrome.storage.local.get(["templates"],(o=>{console.log(o);let s=o.templates||e.map(((e,t)=>({...e,index:t})));u.dropdownResults.innerHTML="",u.favoriteSuggestions.innerHTML="";let l=s.filter((e=>"all"===t||e.type===t));n?(l=l.filter((e=>e.name.toLowerCase().includes(n)||e.tags.toLowerCase().includes(n))),l.sort(((e,t)=>{const a=e.name.toLowerCase().indexOf(n)+e.tags.toLowerCase().indexOf(n),o=t.name.toLowerCase().indexOf(n)+t.tags.toLowerCase().indexOf(n);return a!==o?a-o:e.name.localeCompare(t.name)}))):l.sort(((e,t)=>{const n=T.indexOf(e.index),a=T.indexOf(t.index);return-1===n&&-1===a?e.name.localeCompare(t.name):-1===n?1:-1===a?-1:n-a})),a&&l.forEach(((e,t)=>{const n=document.createElement("div");n.textContent=(e.favorite,`${e.name} (${e.tags})`),n.setAttribute("role","option"),n.setAttribute("aria-selected",v===e.name),u.overlay.style.display="block",u.dropdownResults.style.display="block",u.dropdownResults.classList.add("show"),n.addEventListener("click",(t=>{t.target.classList.contains("favorite-toggle")||(v=e.name,u.templateName.value=e.name,u.templateTags.value=e.tags,u.promptArea.value=e.content,u.searchBox.value="",u.dropdownResults.innerHTML="",u.fetchBtn2.style.display=e.content?"none":"block",u.clearPrompt.style.display=e.content?"block":"none",u.overlay.style.display="none",u.dropdownResults.style.display="none",u.dropdownResults.classList.remove("show"),b(),u.promptArea.focus())})),n.innerHTML+=`<button class="favorite-toggle ${e.favorite?"favorited":"unfavorited"}" data-name="${e.name}" aria-label="${e.favorite?"Unfavorite":"Favorite"} template">${e.favorite?"★":"☆"}</button>`,u.dropdownResults.appendChild(n)}));const r=s.filter((e=>e.favorite));r.length>0?(r.sort(((e,t)=>{const n=T.indexOf(e.index),a=T.indexOf(t.index);return-1===n&&-1===a?e.name.localeCompare(t.name):-1===n?1:-1===a?-1:n-a})),u.favoriteSuggestions.classList.remove("d-none"),r.forEach((e=>{const t=document.createElement("span");t.textContent=e.name,t.className="favorite-suggestion",t.setAttribute("role","button"),t.setAttribute("tabindex","0"),t.addEventListener("click",(()=>{v=e.name,u.templateName.value=e.name,u.templateTags.value=e.tags,u.promptArea.value=e.content,u.searchBox.value="",u.fetchBtn2.style.display=e.content?"none":"block",u.clearPrompt.style.display=e.content?"block":"none",b(),u.promptArea.focus()})),t.addEventListener("keydown",(e=>{"Enter"!==e.key&&" "!==e.key||t.click()})),u.favoriteSuggestions.appendChild(t)}))):u.favoriteSuggestions.classList.add("d-none")}))}function P(e,t,n=!1,a){!function(e){chrome.storage.local.get(null,(t=>{const n=JSON.stringify(t);(new TextEncoder).encode(n).length>4718592&&x("Warning: Storage is nearly full (90% of 5MB limit). Please delete unused templates.",5e3,"red",[],"storage"),e()}))}((()=>{const o=setTimeout((()=>{m(a,!1),x("Operation timed out. Please try again.",3e3,"red",[],"save")}),5e3);chrome.storage.local.set({templates:e},(()=>{if(clearTimeout(o),chrome.runtime.lastError){const e=chrome.runtime.lastError.message;e.includes("QUOTA_BYTES_PER_ITEM")?x("Template size exceeds 8KB limit. Please reduce the size.",5e3,"red",[],"save"):e.includes("QUOTA_BYTES")?x("Total storage limit (5MB) exceeded. Please delete unused templates.",5e3,"red",[],"save"):x("Failed to save template: "+e,5e3,"red",[],"save"),console.error("Local storage error:",e)}else x(n?"Template saved. Press Ctrl+Z to undo.":"Template updated. Press Ctrl+Z to undo.",3e3,"green",[],"save"),t();m(a,!1)}))}))}function O(t,n,a){chrome.storage.local.get(["templates"],(o=>{let s=o.templates||e.map(((e,t)=>({...e,index:t})));E(),h.templates=[...s];const l={name:t,tags:n,content:u.promptArea.value,type:"custom",favorite:!1,index:y};s.push(l),w(y),y++,P(s,(()=>{v=t,u.templateName.value=t,C(u.typeSelect.value,"",!1),b(),k()}),!0,a)}))}chrome.storage.local.get(["popupState","theme","extensionVersion","recentIndices","templates","nextIndex"],(n=>{const a=n.extensionVersion||"0.0.0";a!==t&&(console.log(`Version updated from ${a} to ${t}. No schema migration needed.`),chrome.storage.local.set({extensionVersion:t}));const o=n.popupState||{};u.templateName.value=o.name||"",u.templateTags.value=o.tags||"",u.promptArea.value=o.content||"# Your Role\n* \n\n# Background Information\n* \n\n# Your Task\n* ",v=o.selectedName||null,f=n.theme||"light",y=n.nextIndex||e.length,T=n.recentIndices||[];const s=n.templates||e.map(((e,t)=>({...e,index:t})));n.templates||chrome.storage.local.set({templates:s}),document.body.className=f,u.fetchBtn2.style.display=u.promptArea.value?"none":"block",u.clearPrompt.style.display=u.promptArea.value?"block":"none",C(u.typeSelect.value,"",!1)})),new ResizeObserver((()=>{clearTimeout(g),g=setTimeout((()=>{const e=document.body.clientWidth,t=Math.min(Math.max(e/20,14),24);document.documentElement.style.setProperty("--base-font-size",`${t}px`)}),100)})).observe(document.body),u.templateName.addEventListener("input",n((()=>{let e=u.templateName.value;e.length>50&&(x("Template name must be 50 characters or less.",3e3,"red",[],"nameLength"),e=e.slice(0,50),u.templateName.value=e);const t=e.replace(/[^a-zA-Z0-9\s]/g,"");t!==e&&(u.templateName.value=t,x("Template name can only contain letters, numbers, and spaces.",3e3,"red",[],"nameChar")),b()}),10)),u.templateTags.addEventListener("input",n((()=>{E();let e=u.templateTags.value;if(e){e=e.replace(/^[,\s]+/g,"").replace(/[\s]*,[,\s]*/g,", "),e=e.replace(/\s+/g," ");const t=e.split(", ");t.length>5&&(x("Maximum of 5 tags allowed per template.",3e3,"red",[],"tagsLength"),e=t.slice(0,5).join(", ")),t.some((e=>e.length>20))&&x("Each tag must be 20 characters or less.",3e3,"red",[],"tagLength");const n=t.map((e=>e.slice(0,20))),a=n.map((e=>e.replace(/[^a-zA-Z0-9\s]/g,"")));a.some(((e,t)=>e!==n[t]))&&x("Each tag must contain only letters, numbers, or spaces.",3e3,"red",[],"tagChar"),e=a.join(", "),u.templateTags.value=e}const t=u.templateTags.selectionStart;e&&t>0&&" "===e[t]&&","===e[t-1]&&(u.templateTags.selectionStart=u.templateTags.selectionEnd=t-1),b()}),10)),u.themeToggle.addEventListener("click",(()=>{f="light"===f?"dark":"light",document.body.className=f,b()})),u.fullscreenToggle.addEventListener("click",(()=>{u.fullscreenToggle.querySelector("svg use").setAttribute("href",B?"sprite.svg#compress":"sprite.svg#fullscreen"),B=!B,b(),chrome.runtime.sendMessage({action:"toggleFullscreen"})})),u.minimizeBtn.addEventListener("click",(()=>{chrome.runtime.sendMessage({action:"closePopup"})})),u.closeBtn.addEventListener("click",(()=>{u.templateName.value="",u.templateTags.value="",u.promptArea.value="# Your Role\n* \n\n# Background Information\n* \n\n# Your Task\n* ",v=null,u.fetchBtn2.style.display="block",u.searchBox.value="",C(u.typeSelect.value,"",!1),b(),chrome.runtime.sendMessage({action:"closePopup"})})),u.newBtn.addEventListener("click",(()=>{E(),u.templateName.value="",u.templateTags.value="",u.promptArea.value="# Your Role\n* \n\n# Background Information\n* \n\n# Your Task\n* ",v=null,u.fetchBtn2.style.display="none",u.clearPrompt.style.display="block",u.searchBox.value="",C(u.typeSelect.value,"",!1),b(),x("New template created.",2e3,"green",[],"new")})),u.clearSearch.addEventListener("click",(()=>{u.searchBox.value="",C(u.typeSelect.value,"",!1),u.clearSearch.style.display="none",u.searchBox.focus()})),u.clearPrompt.addEventListener("click",(()=>{E(),u.promptArea.value="",u.fetchBtn2.style.display="block",u.clearPrompt.style.display="none",u.promptArea.focus(),b()})),u.clearAllBtn.addEventListener("click",(()=>{E(),u.templateName.value="",u.templateTags.value="",u.promptArea.value="",v=null,u.fetchBtn2.style.display="block",u.clearPrompt.style.display="none",u.searchBox.value="",C(u.typeSelect.value,"",!1),b(),x("All fields cleared.",2e3,"green",[],"clearAll")})),document.addEventListener("keydown",(e=>{if("Escape"===e.key)if(o&&u.toast.className.includes("confirmation")&&cancelToast()){const e=a[0].buttons.find((e=>"No"===e.text));A(e?.callback)}else chrome.runtime.sendMessage({action:"closePopup"})})),u.promptArea.addEventListener("keydown",(e=>{if("Tab"===e.key){e.preventDefault();const t=u.promptArea.selectionStart,n=u.promptArea.selectionEnd,a=u.promptArea.value;u.promptArea.value=a.substring(0,t)+"  "+a.substring(n),u.promptArea.selectionStart=u.promptArea.selectionEnd=t+2,b()}})),u.promptArea.addEventListener("input",(()=>{E(),u.fetchBtn2.style.display=u.promptArea.value?"none":"block",u.clearPrompt.style.display=u.promptArea.value?"block":"none",b()})),u.templateTags.addEventListener("keydown",(e=>{const t=u.templateTags.selectionStart,n=u.templateTags.value;return"Backspace"===e.key&&t>0&&" "===n[t-1]&&","===n[t-2]?(e.preventDefault(),u.templateTags.value=n.slice(0,t-2)+n.slice(t),u.templateTags.selectionStart=u.templateTags.selectionEnd=t-2,E(),void b()):"Delete"===e.key&&t<n.length&&","===n[t]&&" "===n[t+1]?(e.preventDefault(),u.templateTags.value=n.slice(0,t)+n.slice(t+2),u.templateTags.selectionStart=u.templateTags.selectionEnd=t,E(),void b()):"ArrowLeft"===e.key&&t>1&&" "===n[t-1]&&","===n[t-2]?(e.preventDefault(),void(u.templateTags.selectionStart=u.templateTags.selectionEnd=t-2)):"ArrowRight"===e.key&&t<n.length-1&&","===n[t]&&" "===n[t+1]?(e.preventDefault(),void(u.templateTags.selectionStart=u.templateTags.selectionEnd=t+2)):void 0})),u.templateTags.addEventListener("click",(()=>{const e=u.templateTags.selectionStart,t=u.templateTags.value;e>0&&" "===t[e]&&","===t[e-1]&&(u.templateTags.selectionStart=u.templateTags.selectionEnd=e-1)})),u.searchBox.addEventListener("focus",(()=>{C(u.typeSelect.value,u.searchBox.value.toLowerCase(),!0)})),u.searchBox.addEventListener("input",(()=>{C(u.typeSelect.value,u.searchBox.value.toLowerCase(),!0),u.clearSearch.style.display=u.searchBox.value?"block":"none"})),u.typeSelect.addEventListener("change",(()=>{C(u.typeSelect.value,u.searchBox.value.toLowerCase(),!0)})),document.addEventListener("click",(e=>{u.searchBox.contains(e.target)||u.dropdownResults.contains(e.target)||u.themeToggle.contains(e.target)||u.typeSelect.contains(e.target)||(u.dropdownResults.innerHTML="",u.overlay.style.display="none",u.dropdownResults.style.display="none",u.dropdownResults.classList.remove("show"))})),u.saveBtn.addEventListener("click",(()=>{m(u.saveBtn,!0),chrome.storage.local.get(["templates"],(t=>{let n=t.templates||e.map(((e,t)=>({...e,index:t})));const a=S(u.templateName.value,n);if(!a.isValid)return u.templateName.focus(),void m(u.saveBtn,!1);const o=a.sanitizedName,s=u.templateTags.value,l=I(s);if(null===l)return u.templateTags.focus(),void m(u.saveBtn,!1);const r=u.promptArea.value;if(!r.trim())return x("Prompt content is required to save a template.",3e3,"red",[],"save"),u.promptArea.focus(),void m(u.saveBtn,!1);if(!s.trim())return u.templateTags.focus(),void x("No tags provided. Save without tags?",0,"red",[{text:"Yes",callback:()=>{if(v){const e=n.find((e=>e.name===v));if(!e)return x("Selected template not found.",3e3,"red",[],"save"),void m(u.saveBtn,!1);if(u.templateName.value===e.name&&I(u.templateTags.value)===e.tags&&u.promptArea.value===e.content)return x("No changes to save.",3e3,"red",[],"save"),void m(u.saveBtn,!1);E(),h.templates=[...n];const t=n.findIndex((e=>e.name===v));n[t]={name:o,tags:l,content:r,type:"custom",favorite:e.favorite||!1,index:e.index},P(n,(()=>{v=o,C(u.typeSelect.value,"",!1),b()}),!1,u.saveBtn)}else{E(),h.templates=[...n];const e={name:o,tags:l,content:r,type:"custom",favorite:!1,index:y};n.push(e),w(y),y++,P(n,(()=>{v=o,C(u.typeSelect.value,"",!1),b(),k()}),!0,u.saveBtn)}}},{text:"No",callback:()=>{u.templateTags.focus(),m(u.saveBtn,!1)}}],"save");if(v){const e=n.find((e=>e.name===v));if(!e)return x("Selected template not found.",3e3,"red",[],"save"),void m(u.saveBtn,!1);if(u.templateName.value===e.name&&I(u.templateTags.value)===e.tags&&u.promptArea.value===e.content)return x("No changes to save.",3e3,"red",[],"save"),void m(u.saveBtn,!1);E(),h.templates=[...n];const t=n.findIndex((e=>e.name===v));n[t]={name:o,tags:l,content:r,type:"custom",favorite:e.favorite||!1,index:e.index},P(n,(()=>{v=o,C(u.typeSelect.value,"",!1),b()}),!1,u.saveBtn)}else{E(),h.templates=[...n];const e={name:o,tags:l,content:r,type:"custom",favorite:!1,index:y};n.push(e),w(y),y++,P(n,(()=>{v=o,C(u.typeSelect.value,"",!1),b(),k()}),!0,u.saveBtn)}}))})),u.saveAsBtn.addEventListener("click",(()=>{m(u.saveAsBtn,!0),chrome.storage.local.get(["templates"],(t=>{const n=t.templates||e.map(((e,t)=>({...e,index:t}))),a=S(u.templateName.value,n,!0);if(!a.isValid)return u.templateName.focus(),void m(u.saveAsBtn,!1);const o=a.sanitizedName,s=u.templateTags.value,l=I(s);return null===l?(u.templateTags.focus(),void m(u.saveAsBtn,!1)):u.promptArea.value.trim()?s.trim()?void O(o,l,u.saveAsBtn):(u.templateTags.focus(),void x("No tags provided. Save without tags?",0,"red",[{text:"Yes",callback:()=>{O(o,l,u.saveAsBtn)}},{text:"No",callback:()=>{u.templateTags.focus(),m(u.saveAsBtn,!1)}}],"saveAs")):(x("Prompt content is required to save a template.",3e3,"red",[],"saveAs"),u.promptArea.focus(),void m(u.saveAsBtn,!1))}))})),u.fetchBtns.forEach((e=>{e.addEventListener("click",(()=>{m(e,!0);const t=setTimeout((()=>{m(e,!1),x("Fetch operation timed out. Please try again.",3e3,"red",[],"fetch")}),5e3);N((n=>{if(!n)return clearTimeout(t),x("Error: This page is not supported. Please navigate to a supported AI platform (e.g., grok.com, perplexity.ai, or chatgpt.com).",3e3,"red",[],"fetch"),void m(e,!1);let a=!1;!function o(){chrome.tabs.sendMessage(n,{action:"getPrompt"},(s=>{if(clearTimeout(t),chrome.runtime.lastError){const t=chrome.runtime.lastError.message;return console.error("Fetch error:",t),void(a||!t.includes("Cannot access contents of the page")&&!t.includes("Could not establish connection")?(x("Failed to fetch prompt. Please try again or refresh the page.",3e3,"red",[],"fetch"),m(e,!1)):(a=!0,console.log("Content script unresponsive, attempting to re-inject..."),chrome.runtime.sendMessage({action:"reInjectContentScript",tabId:n},(t=>{t&&t.success?(console.log("Content script re-injected, retrying fetch..."),setTimeout(o,100)):(x("Failed to fetch prompt. Please try again or refresh the page.",3e3,"red",[],"fetch"),m(e,!1))}))))}s&&s.prompt?(E(),u.promptArea.value=s.prompt,u.fetchBtn2.style.display="none",u.clearPrompt.style.display="block",b()):x("No input found on the page.",3e3,"red",[],"fetch"),m(e,!1)}))}()}))}))})),u.sendBtn.addEventListener("click",(()=>{m(u.sendBtn,!0);const t=setTimeout((()=>{m(u.sendBtn,!1),x("Send operation timed out. Please try again.",3e3,"red",[],"send")}),5e3);N((n=>{if(!n)return clearTimeout(t),x("Error: This page is not supported. Please navigate to a supported AI platform (e.g., grok.com, perplexity.ai, or chatgpt.com).",3e3,"red",[],"send"),void m(u.sendBtn,!1);let a=!1;!function o(){chrome.tabs.sendMessage(n,{action:"sendPrompt",prompt:u.promptArea.value},(s=>{if(clearTimeout(t),chrome.runtime.lastError){const e=chrome.runtime.lastError.message;return console.error("Send error:",e),a||!e.includes("Cannot access contents of the page")&&!e.includes("Could not establish connection")?(x("Failed to send prompt. Please try again or refresh the page.",3e3,"red",[],"send"),void m(u.sendBtn,!1)):(a=!0,console.log("Content script unresponsive, attempting to re-inject..."),void chrome.runtime.sendMessage({action:"reInjectContentScript",tabId:n},(e=>{e&&e.success?(console.log("Content script re-injected, retrying send..."),setTimeout(o,100)):(x("Failed to send prompt. Please try again or refresh the page.",3e3,"red",[],"send"),m(u.sendBtn,!1))})))}s&&s.success?v?chrome.storage.local.get(["templates"],(t=>{const n=(t.templates||e.map(((e,t)=>({...e,index:t})))).find((e=>e.name===v));n&&w(n.index),chrome.runtime.sendMessage({action:"closePopup"}),m(u.sendBtn,!1)})):(chrome.runtime.sendMessage({action:"closePopup"}),m(u.sendBtn,!1)):(x("Failed to send prompt. Please try again or refresh the page.",3e3,"red",[],"send"),m(u.sendBtn,!1))}))}()}))})),u.deleteBtn.addEventListener("click",(()=>{if(m(u.deleteBtn,!0),!v)return x("Please select a template to delete.",3e3,"red",[],"delete"),void m(u.deleteBtn,!1);chrome.storage.local.get(["templates","recentIndices"],(t=>{const n=t.templates||e.map(((e,t)=>({...e,index:t}))),a="pre-built"===n.find((e=>e.name===v)).type;x(`Are you sure you want to delete "${v}"?${a?"<br>This is a pre-built template.":""}`,0,"red",[{text:"Yes",callback:()=>{E(),h.templates=[...n];const e=n.findIndex((e=>e.name===v)),t=n[e].index;n.splice(e,1),T=T.filter((e=>e!==t));const a=setTimeout((()=>{m(u.deleteBtn,!1),x("Delete operation timed out. Please try again.",3e3,"red",[],"delete")}),5e3);chrome.storage.local.set({templates:n,recentIndices:T},(()=>{clearTimeout(a),chrome.runtime.lastError?x("Failed to delete template: "+chrome.runtime.lastError.message,3e3,"red",[],"delete"):(x("Template deleted successfully. Press Ctrl+Z to undo.",3e3,"green",[],"delete"),v=null,u.templateName.value="",u.templateTags.value="",u.promptArea.value="# Your Role\n* \n\n# Background Information\n* \n\n# Your Task\n* ",u.searchBox.value="",u.fetchBtn2.style.display="block",u.clearPrompt.style.display="none",C(u.typeSelect.value,"",!1),b()),m(u.deleteBtn,!1)}))}},{text:"No",callback:()=>{m(u.deleteBtn,!1)}}],"delete")}))})),document.addEventListener("keydown",(e=>{e.ctrlKey&&"z"===e.key&&h&&(u.templateName.value=h.name||"",u.templateTags.value=h.tags||"",u.promptArea.value=h.content||"",v=h.selectedName||null,h.templates&&(chrome.storage.local.set({templates:h.templates},(()=>{C(u.typeSelect.value,"",!1)})),x("Action undone successfully.",2e3,"green",[],"undo")),u.fetchBtn2.style.display=u.promptArea.value?"none":"block",u.clearPrompt.style.display=u.promptArea.value?"block":"none",h=null,b())})),document.addEventListener("click",(t=>{if(t.target.classList.contains("favorite-toggle")){const n=t.target.dataset.name;chrome.storage.local.get(["templates"],(t=>{const a=t.templates||e.map(((e,t)=>({...e,index:t}))),o=a.find((e=>e.name===n));if(o){if(!o.favorite&&a.filter((e=>e.favorite)).length>=10)return void x("Maximum of 10 favorite templates allowed.",3e3,"red",[],"favorite");o.favorite=!o.favorite,chrome.storage.local.set({templates:a},(()=>{C(u.typeSelect.value,u.searchBox.value.toLowerCase(),!0)}))}}))}})),document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach((e=>new bootstrap.Tooltip(e,{duration:300}))),u.dropdownResults.addEventListener("keydown",(e=>{const t=u.dropdownResults.querySelectorAll("div"),n=document.activeElement;let a=Array.from(t).indexOf(n);"ArrowDown"===e.key?(e.preventDefault(),a=(a+1)%t.length,t[a].focus()):"ArrowUp"===e.key?(e.preventDefault(),a=(a-1+t.length)%t.length,t[a].focus()):"Enter"===e.key&&(e.preventDefault(),n.click())}))}))})();