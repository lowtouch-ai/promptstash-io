(()=>{"use strict";const e=[{name:"Business Analyst Report",tags:"analysis, report, business",type:"pre-built",content:"# Your Role\nBusiness Analyst\n\n# Your Task\nAnalyze the provided data and generate a concise report.\n\n# Relevant Background Information\nUse formal tone, focus on key metrics.\n\n# Output Format\nExecutive summary (200 words), followed by bullet points.",favorite:!1},{name:"Code Debugging Assistant",tags:"coding, debug, tech",type:"pre-built",content:"# Your Role\nSenior Developer\n\n# Your Task\nIdentify and fix bugs in the provided code snippet.\n\n# Relevant Background Information\nCode is in Python, prioritize efficiency.\n\n# Output Format\nExplanation of issue, corrected code block.",favorite:!1},{name:"Content Generator",tags:"marketing, content, quick",type:"pre-built",content:"# Your Role\nContent Writer\n\n# Your Task\nWrite a 500-word blog post on the given topic.\n\n# Relevant Background Information\nCasual tone, SEO-friendly.\n\n# Output Format\nTitle, intro, 3 sections, conclusion.",favorite:!1}],t="1.1.0";function a(e,t){let a;return function(...n){clearTimeout(a),a=setTimeout((()=>e.apply(this,n)),t)}}let n=[],s=!1,o=null,l=null,r=null,c=null;const i={};let m=!1;document.addEventListener("DOMContentLoaded",(()=>{const d={searchBox:document.getElementById("searchBox"),typeSelect:document.getElementById("typeSelect"),dropdownResults:document.getElementById("dropdownResults"),template:document.getElementById("template"),templateName:document.getElementById("templateName"),templateTags:document.getElementById("templateTags"),promptArea:document.getElementById("promptArea"),buttons:document.getElementById("buttons"),fetchBtns:document.querySelectorAll("#fetchBtn, #fetchBtn2"),fetchBtn2:document.getElementById("fetchBtn2"),saveBtn:document.getElementById("saveBtn"),saveAsBtn:document.getElementById("saveAsBtn"),deleteBtn:document.getElementById("deleteBtn"),clearSearch:document.getElementById("clearSearch"),clearPrompt:document.getElementById("clearPrompt"),clearAllBtn:document.getElementById("clearAllBtn"),sendBtn:document.getElementById("sendBtn"),favoriteSuggestions:document.getElementById("favoriteSuggestions"),fullscreenToggle:document.getElementById("fullscreenToggle"),closeBtn:document.getElementById("closeBtn"),minimizeBtn:document.getElementById("minimizeBtn"),newBtn:document.getElementById("newBtn"),searchOverlay:document.getElementById("searchOverlay"),toastOverlay:document.getElementById("toastOverlay"),toast:document.getElementById("toast"),themeToggle:document.getElementById("themeToggle")};Object.entries(d).filter((([e,t])=>!t)).map((([e])=>e)).length>0&&B("Error: Extension UI failed to load. Please reload the extension.",3e3,"red",[],"init");let u,p=null,g="light",v=null,f=0,h=!1,y=[];function T(){const e={popupState:{name:d.templateName.value,tags:d.templateTags.value,content:d.promptArea.value,selectedName:p},theme:g,isFullscreen:h,extensionVersion:t};chrome.storage.local.set(e)}function E(){chrome.storage.local.set({nextIndex:f})}function b(){v={name:d.templateName.value,tags:d.templateTags.value,content:d.promptArea.value,selectedName:p,templates:null}}function B(e,t=4e3,a="red",o=[],l){console.log("Queueing toast:",{message:e,duration:t,type:a,hasButtons:o.length>0,operationId:l});const c=`${e}|${l}`,u=Date.now();if(!(0===o.length&&i[c]&&u-i[c]<1010)){if(i[c]=u,Object.keys(i).forEach((e=>{u-i[e]>7e3&&delete i[e]})),o.length>0&&-1!==n.findIndex((t=>t.message===e&&t.buttons.length>0)))return;if(l!==r){if(s){m=!0;const e=d.toast.className.includes("confirmation")&&n[0]||{buttons:[]},t=e.buttons.find((e=>"No"===e.text))?.callback;k(t)}n=[],r=l}l===r&&(n.push({message:e,duration:t,type:a,buttons:o,operationId:l}),s||x())}}function k(e){clearTimeout(o),o=null,clearTimeout(c),l&&(document.removeEventListener("click",l),l=null),d.toast.classList.remove("show"),d.toast.classList.add("hide"),d.toastOverlay.style.display="none",setTimeout((()=>{d.toast.classList.remove("hide"),d.toast.innerHTML="",s=!1,e&&e(),m?(m=!1,x()):c=setTimeout(x,10)}),10)}function x(){if(0===n.length)return void(s=!1);clearTimeout(o),o=null,s=!0;const{message:e,duration:t,type:a,buttons:r,operationId:c}=n.shift();d.toast.innerHTML=e;const i=document.createElement("button");if(i.textContent="×",i.className="toast-close-btn",i.setAttribute("aria-label","Close toast"),i.addEventListener("click",(e=>{e.stopPropagation(),l&&(document.removeEventListener("click",l),l=null);const t=r.find((e=>"No"===e.text));k(t?.callback)})),d.toast.appendChild(i),r.length>0){const e=document.createElement("div");e.className="toast-button-container",r.forEach((({text:t,callback:a})=>{const n=document.createElement("button");n.textContent=t,n.className="toast-action-btn",n.setAttribute("aria-label","Yes"===t?"Confirm action":"Cancel action"),n.addEventListener("click",(e=>{e.stopPropagation(),l&&(document.removeEventListener("click",l),l=null),k(a)})),e.appendChild(n)})),d.toast.appendChild(e),d.toastOverlay.style.display="block";const t=d.toast.querySelector(".toast-action-btn[aria-label='Confirm action']");setTimeout((()=>{t&&t.focus()}),0),l=e=>{if(!d.toast.contains(e.target)){const e=r.find((e=>"No"===e.text));k((()=>{e&&e.callback&&e.callback()}))}},setTimeout((()=>{document.addEventListener("click",l)}),50)}else o=setTimeout((()=>{k()}),t);d.toast.className=`toast ${a} ${r.length>0?"confirmation":""}`,d.toast.classList.add("show")}function A(e,t,a=!1){const n=e.trim();if(!n)return B("Template name is required.",3e3,"red",[],"save"),{isValid:!1,sanitizedName:null};if(n.length>50)return B("Template name must be 50 characters or less.",3e3,"red",[],"nameLength"),{isValid:!1,sanitizedName:null};const s=n.replace(/[^a-zA-Z0-9-_.@\s]/g,"");return s!==n?(B("Template name can only contain letters, numbers, underscores(_), hyphens(-), periods(.), at(@), and spaces.",3e3,"red",[],"nameChar"),{isValid:!1,sanitizedName:null}):t.some((e=>e.name===s&&(a||e.name!==p)))?(B("Template name must be unique.",3e3,"red",[],"save"),{isValid:!1,sanitizedName:null}):{isValid:!0,sanitizedName:s}}function L(e){if(!e)return"";const t=e.split(",").map((e=>e.trim())).filter((e=>e));if(t.length>5)return B("Maximum of 5 tags allowed per template.",3e3,"red",[],"tagsLength"),null;const a=t.map((e=>e.replace(/[^a-zA-Z0-9-_.@\s]/g,"").slice(0,20)));return a.some((e=>0===e.length))?(B("Each tag must contain only letters, numbers, underscores(_), hyphens(-), periods(.), at(@), or spaces, and be 20 characters or less.",3e3,"red",[],"save"),null):a.join(", ")}function w(e){y.unshift(e),y=[...new Set(y)],y.length>10&&(y=y.slice(0,10)),chrome.storage.local.set({recentIndices:y},(()=>{chrome.runtime.lastError&&console.error("Failed to save recent indices:",chrome.runtime.lastError.message)}))}function I(e){const t=setTimeout((()=>{e(null)}),5e3);chrome.runtime.sendMessage({action:"getTargetTabId"},(a=>{clearTimeout(t),a&&a.tabId?e(a.tabId):e(null)}))}function N(t="",a=!1){chrome.storage.local.get(["templates"],(n=>{let s=n.templates||e.map(((e,t)=>({...e,index:t})));d.dropdownResults.innerHTML="",d.favoriteSuggestions.innerHTML="",t?(s=s.filter((e=>e.name.toLowerCase().includes(t)||e.tags.toLowerCase().includes(t))),s.sort(((e,a)=>{const n=e.name.toLowerCase().indexOf(t)+e.tags.toLowerCase().indexOf(t),s=a.name.toLowerCase().indexOf(t)+a.tags.toLowerCase().indexOf(t);return n!==s?n-s:e.name.localeCompare(a.name)}))):s.sort(((e,t)=>{const a=y.indexOf(e.index),n=y.indexOf(t.index);return-1===a&&-1===n?e.name.localeCompare(t.name):-1===a?1:-1===n?-1:a-n})),a&&s.forEach(((e,t)=>{const a=document.createElement("div");a.textContent=e.tags?`${e.name} (${e.tags})`:`${e.name}`,a.setAttribute("role","option"),a.setAttribute("aria-selected",p===e.name),d.searchOverlay.style.display="block",d.dropdownResults.style.display="block",d.dropdownResults.classList.add("show"),a.addEventListener("click",(t=>{t.target.classList.contains("favorite-toggle")||(p=e.name,d.templateName.value=e.name,d.templateTags.value=e.tags,d.promptArea.value=e.content,d.searchBox.value="",d.dropdownResults.innerHTML="",d.fetchBtn2.style.display=e.content?"none":"block",d.clearPrompt.style.display=e.content?"block":"none",d.searchOverlay.style.display="none",d.dropdownResults.style.display="none",d.dropdownResults.classList.remove("show"),T(),d.promptArea.focus())})),a.innerHTML+=`<button class="favorite-toggle ${e.favorite?"favorited":"unfavorited"}" data-name="${e.name}" aria-label="${e.favorite?"Unfavorite":"Favorite"} template">${e.favorite?"★":"☆"}</button>`,d.dropdownResults.appendChild(a)}));const o=s.filter((e=>e.favorite));o.length>0?(o.sort(((e,t)=>{const a=y.indexOf(e.index),n=y.indexOf(t.index);return-1===a&&-1===n?e.name.localeCompare(t.name):-1===a?1:-1===n?-1:a-n})),d.favoriteSuggestions.classList.remove("d-none"),o.forEach((e=>{const t=document.createElement("span");t.textContent=e.name,t.className="favorite-suggestion",t.setAttribute("role","button"),t.setAttribute("tabindex","0"),t.addEventListener("click",(()=>{p=e.name,d.templateName.value=e.name,d.templateTags.value=e.tags,d.promptArea.value=e.content,d.searchBox.value="",d.fetchBtn2.style.display=e.content?"none":"block",d.clearPrompt.style.display=e.content?"block":"none",T(),d.promptArea.focus()})),t.addEventListener("keydown",(e=>{"Enter"!==e.key&&" "!==e.key||t.click()})),d.favoriteSuggestions.appendChild(t)}))):d.favoriteSuggestions.classList.add("d-none")}))}function S(e,t,a=!1,n){const s=setTimeout((()=>{B("Operation timed out. Please try again.",3e3,"red",[],"save")}),5e3);chrome.storage.local.set({templates:e},(()=>{if(clearTimeout(s),chrome.runtime.lastError){const e=chrome.runtime.lastError.message;e.includes("QUOTA_BYTES_PER_ITEM")?B("Template size exceeds size limit. Please reduce the size.",5e3,"red",[],"save"):e.includes("QUOTA_BYTES")?B("Total storage limit exceeded. Please delete unused templates.",5e3,"red",[],"save"):B("Failed to save template: "+e,5e3,"red",[],"save"),console.error("Local storage error:",e)}else B(a?"Template saved. Press Ctrl+Z to undo.":"Template updated. Press Ctrl+Z to undo.",3e3,"green",[],"save"),t(),chrome.storage.local.get(null,(e=>{const t=JSON.stringify(e);(new TextEncoder).encode(t).length>9437184&&B("Warning: Storage is nearly full (90% of 10MB limit). Please delete unused templates.",5e3,"red",[],"save")}))}))}function P(t,a,n){chrome.storage.local.get(["templates"],(n=>{let s=n.templates||e.map(((e,t)=>({...e,index:t})));b(),v.templates=[...s];const o={name:t,tags:a,content:d.promptArea.value,type:"custom",favorite:!1,index:f};s.push(o),w(f),f++,S(s,(()=>{p=t,d.templateName.value=t,N(),T(),E()}),!0)}))}chrome.storage.local.get(["popupState","theme","extensionVersion","recentIndices","templates","nextIndex","isFullscreen"],(a=>{(a.extensionVersion||"0.0.0")!==t&&chrome.storage.local.set({extensionVersion:t});const n=a.popupState||{};d.templateName.value=n.name||"",d.templateTags.value=n.tags||"",d.promptArea.value=n.content||"# Your Role\n* \n\n# Background Information\n* \n\n# Your Task\n* ",p=n.selectedName||null,g=a.theme||"light",f=a.nextIndex||e.length,y=a.recentIndices||[],h=a.isFullscreen||!1,d.fullscreenToggle.querySelector("svg use").setAttribute("href",h?"sprite.svg#compress":"sprite.svg#fullscreen");const s=a.templates||e.map(((e,t)=>({...e,index:t})));a.templates||chrome.storage.local.set({templates:s}),document.body.className=g,d.fetchBtn2.style.display=d.promptArea.value?"none":"block",d.clearPrompt.style.display=d.promptArea.value?"block":"none",N()})),new ResizeObserver((()=>{clearTimeout(u),u=setTimeout((()=>{const e=document.body.clientWidth,t=Math.min(Math.max(e/20,14),24);document.documentElement.style.setProperty("--base-font-size",`${t}px`)}),100)})).observe(document.body),d.templateName.addEventListener("input",a((()=>{let e=d.templateName.value;e.length>50&&(B("Template name must be 50 characters or less.",3e3,"red",[],"nameLength"),e=e.slice(0,50),d.templateName.value=e);const t=e.replace(/[^a-zA-Z0-9-_.@\s]/g,"");t!==e&&(d.templateName.value=t,B("Template name can only contain letters, numbers, underscores(_), hyphens(-), periods(.), at(@), and spaces.",3e3,"red",[],"nameChar")),T()}),10)),d.templateTags.addEventListener("input",a((()=>{b();let e=d.templateTags.value;if(e){e=e.replace(/^[,\s]+/g,"").replace(/[\s]*,[,\s]*/g,", "),e=e.replace(/\s+/g," ");const t=e.split(", ");t.length>5&&(B("Maximum of 5 tags allowed per template.",3e3,"red",[],"tagsLength"),e=t.slice(0,5).join(", ")),t.some((e=>e.length>20))&&B("Each tag must be 20 characters or less.",3e3,"red",[],"tagLength");const a=t.map((e=>e.slice(0,20))),n=a.map((e=>e.replace(/[^a-zA-Z0-9-_.@\s]/g,"")));n.some(((e,t)=>e!==a[t]))&&B("Each tag must contain only letters, numbers, underscores(_), hyphens(-), periods(.), at(@), or spaces.",3e3,"red",[],"tagChar"),e=n.join(", "),d.templateTags.value=e}const t=d.templateTags.selectionStart;e&&t>0&&" "===e[t]&&","===e[t-1]&&(d.templateTags.selectionStart=d.templateTags.selectionEnd=t-1),T()}),10)),d.themeToggle.addEventListener("click",(()=>{g="light"===g?"dark":"light",document.body.className=g,T()})),d.fullscreenToggle.addEventListener("click",(()=>{const e=d.fullscreenToggle.querySelector("svg use");h=!h,T(),e.setAttribute("href",h?"sprite.svg#compress":"sprite.svg#fullscreen"),chrome.runtime.sendMessage({action:"toggleFullscreen"})})),d.minimizeBtn.addEventListener("click",(()=>{chrome.runtime.sendMessage({action:"closePopup"})})),d.closeBtn.addEventListener("click",(()=>{d.templateName.value="",d.templateTags.value="",d.promptArea.value="# Your Role\n* \n\n# Background Information\n* \n\n# Your Task\n* ",p=null,d.fetchBtn2.style.display="block",d.searchBox.value="",N(),T(),chrome.runtime.sendMessage({action:"closePopup"})})),d.newBtn.addEventListener("click",(()=>{b(),d.templateName.value="",d.templateTags.value="",d.promptArea.value="# Your Role\n* \n\n# Background Information\n* \n\n# Your Task\n* ",p=null,d.fetchBtn2.style.display="none",d.clearPrompt.style.display="block",d.searchBox.value="",N(),T(),B("New template created.",2e3,"green",[],"new")})),d.clearSearch.addEventListener("click",(()=>{d.searchBox.value="",N(),d.clearSearch.style.display="none",d.searchBox.focus()})),d.clearPrompt.addEventListener("click",(()=>{b(),d.promptArea.value="",d.fetchBtn2.style.display="block",d.clearPrompt.style.display="none",d.promptArea.focus(),T()})),d.clearAllBtn.addEventListener("click",(()=>{b(),d.templateName.value="",d.templateTags.value="",d.promptArea.value="",p=null,d.fetchBtn2.style.display="block",d.clearPrompt.style.display="none",d.searchBox.value="",N(),T(),B("All fields cleared.",2e3,"green",[],"clearAll")})),document.addEventListener("keydown",(e=>{if("Escape"===e.key)if(s&&d.toast.className.includes("confirmation")&&cancelToast()){const e=n[0].buttons.find((e=>"No"===e.text));k(e?.callback)}else chrome.runtime.sendMessage({action:"closePopup"})})),d.promptArea.addEventListener("keydown",(e=>{if("Tab"===e.key){e.preventDefault();const t=d.promptArea.selectionStart,a=d.promptArea.selectionEnd,n=d.promptArea.value;d.promptArea.value=n.substring(0,t)+"  "+n.substring(a),d.promptArea.selectionStart=d.promptArea.selectionEnd=t+2,T()}})),d.promptArea.addEventListener("input",(()=>{b(),d.fetchBtn2.style.display=d.promptArea.value?"none":"block",d.clearPrompt.style.display=d.promptArea.value?"block":"none",T()})),d.templateTags.addEventListener("keydown",(e=>{const t=d.templateTags.selectionStart,a=d.templateTags.value;return"Backspace"===e.key&&t>0&&" "===a[t-1]&&","===a[t-2]?(e.preventDefault(),d.templateTags.value=a.slice(0,t-2)+a.slice(t),d.templateTags.selectionStart=d.templateTags.selectionEnd=t-2,b(),void T()):"Delete"===e.key&&t<a.length&&","===a[t]&&" "===a[t+1]?(e.preventDefault(),d.templateTags.value=a.slice(0,t)+a.slice(t+2),d.templateTags.selectionStart=d.templateTags.selectionEnd=t,b(),void T()):"ArrowLeft"===e.key&&t>1&&" "===a[t-1]&&","===a[t-2]?(e.preventDefault(),void(d.templateTags.selectionStart=d.templateTags.selectionEnd=t-2)):"ArrowRight"===e.key&&t<a.length-1&&","===a[t]&&" "===a[t+1]?(e.preventDefault(),void(d.templateTags.selectionStart=d.templateTags.selectionEnd=t+2)):void 0})),d.templateTags.addEventListener("click",(()=>{const e=d.templateTags.selectionStart,t=d.templateTags.value;e>0&&" "===t[e]&&","===t[e-1]&&(d.templateTags.selectionStart=d.templateTags.selectionEnd=e-1)})),d.searchBox.addEventListener("focus",(()=>{N(d.searchBox.value.toLowerCase(),!0)})),d.searchBox.addEventListener("input",(()=>{N(d.searchBox.value.toLowerCase(),!0),d.clearSearch.style.display=d.searchBox.value?"block":"none"})),d.typeSelect.addEventListener("change",(()=>{N(d.searchBox.value.toLowerCase(),!0)})),document.addEventListener("click",(e=>{d.searchBox.contains(e.target)||d.dropdownResults.contains(e.target)||d.themeToggle.contains(e.target)||d.typeSelect.contains(e.target)||(d.dropdownResults.innerHTML="",d.searchOverlay.style.display="none",d.dropdownResults.style.display="none",d.dropdownResults.classList.remove("show"))})),d.saveBtn.addEventListener("click",(()=>{chrome.storage.local.get(["templates"],(t=>{let a=t.templates||e.map(((e,t)=>({...e,index:t})));const n=A(d.templateName.value,a);if(!n.isValid)return void d.templateName.focus();const s=n.sanitizedName,o=d.templateTags.value,l=L(o);if(null===l)return void d.templateTags.focus();const r=d.promptArea.value;if(!r.trim())return B("Prompt content is required to save a template.",3e3,"red",[],"save"),void d.promptArea.focus();if(o.trim())if(p){const e=a.find((e=>e.name===p));if(!e)return void B("Selected template not found.",3e3,"red",[],"save");if(d.templateName.value===e.name&&L(d.templateTags.value)===e.tags&&d.promptArea.value===e.content)return void B("No changes to save.",3e3,"red",[],"save");b(),v.templates=[...a];const t=a.findIndex((e=>e.name===p));a[t]={name:s,tags:l,content:r,type:"custom",favorite:e.favorite||!1,index:e.index},S(a,(()=>{p=s,N(),T()}),!1,d.saveBtn)}else{b(),v.templates=[...a];const e={name:s,tags:l,content:r,type:"custom",favorite:!1,index:f};a.push(e),w(f),f++,S(a,(()=>{p=s,N(),T(),E()}),!0,d.saveBtn)}else B("No tags provided. Save without tags?",0,"red",[{text:"Yes",callback:()=>{if(p){const e=a.find((e=>e.name===p));if(!e)return void B("Selected template not found.",3e3,"red",[],"save");if(d.templateName.value===e.name&&L(d.templateTags.value)===e.tags&&d.promptArea.value===e.content)return void B("No changes to save.",3e3,"red",[],"save");b(),v.templates=[...a];const t=a.findIndex((e=>e.name===p));a[t]={name:s,tags:l,content:r,type:"custom",favorite:e.favorite||!1,index:e.index},S(a,(()=>{p=s,N(),T()}),!1,d.saveBtn)}else{b(),v.templates=[...a];const e={name:s,tags:l,content:r,type:"custom",favorite:!1,index:f};a.push(e),w(f),f++,S(a,(()=>{p=s,N(),T(),E()}),!0,d.saveBtn)}}},{text:"No",callback:()=>{d.templateTags.focus()}}],"save")}))})),d.saveAsBtn.addEventListener("click",(()=>{chrome.storage.local.get(["templates"],(t=>{const a=t.templates||e.map(((e,t)=>({...e,index:t}))),n=A(d.templateName.value,a,!0);if(!n.isValid)return void d.templateName.focus();const s=n.sanitizedName,o=d.templateTags.value,l=L(o);if(null!==l)return d.promptArea.value.trim()?void(o.trim()?P(s,l,d.saveAsBtn):B("No tags provided. Save without tags?",0,"red",[{text:"Yes",callback:()=>{P(s,l,d.saveAsBtn)}},{text:"No",callback:()=>{d.templateTags.focus()}}],"saveAs")):(B("Prompt content is required to save a template.",3e3,"red",[],"saveAs"),void d.promptArea.focus());d.templateTags.focus()}))})),d.fetchBtns.forEach((e=>{e.addEventListener("click",(()=>{const e=setTimeout((()=>{B("Fetch operation timed out. Please try again.",3e3,"red",[],"fetch")}),5e3);I((t=>{if(!t)return void clearTimeout(e);let a=!1;!function n(){chrome.tabs.sendMessage(t,{action:"getPrompt"},(s=>{if(clearTimeout(e),chrome.runtime.lastError){const e=chrome.runtime.lastError.message;return console.error("Fetch error:",e),void(a||!e.includes("Cannot access contents of the page")&&!e.includes("Could not establish connection")?B("Failed to fetch prompt. Please try again or refresh the page.",3e3,"red",[],"fetch"):(a=!0,chrome.runtime.sendMessage({action:"reInjectContentScript",tabId:t},(e=>{e&&e.success?setTimeout(n,100):B("Failed to fetch prompt. Please try again or refresh the page.",3e3,"red",[],"fetch")}))))}s&&s.prompt?(b(),d.promptArea.value=s.prompt,d.fetchBtn2.style.display="none",d.clearPrompt.style.display="block",T()):B("No text found. Please select a field that contains text.",3e3,"red",[],"fetch")}))}()}))}))})),d.sendBtn.addEventListener("click",(()=>{const t=setTimeout((()=>{B("Send operation timed out. Please try again.",3e3,"red",[],"send")}),5e3);I((a=>{if(!a)return void clearTimeout(t);let n=!1;!function s(){chrome.tabs.sendMessage(a,{action:"sendPrompt",prompt:d.promptArea.value},(o=>{if(clearTimeout(t),chrome.runtime.lastError){const e=chrome.runtime.lastError.message;return console.error("Send error:",e),n||!e.includes("Cannot access contents of the page")&&!e.includes("Could not establish connection")?void B("Failed to send prompt. Please try again or refresh the page.",3e3,"red",[],"send"):(n=!0,void chrome.runtime.sendMessage({action:"reInjectContentScript",tabId:a},(e=>{e&&e.success?setTimeout(s,100):B("Failed to send prompt. Please try again or refresh the page.",3e3,"red",[],"send")})))}o&&o.success?p?chrome.storage.local.get(["templates"],(t=>{const a=(t.templates||e.map(((e,t)=>({...e,index:t})))).find((e=>e.name===p));a&&w(a.index),chrome.runtime.sendMessage({action:"closePopup"})})):chrome.runtime.sendMessage({action:"closePopup"}):B("Failed to send prompt. Please try again or refresh the page.",3e3,"red",[],"send")}))}()}))})),d.deleteBtn.addEventListener("click",(()=>{p?chrome.storage.local.get(["templates","recentIndices"],(t=>{const a=t.templates||e.map(((e,t)=>({...e,index:t}))),n="pre-built"===a.find((e=>e.name===p)).type;B(`Are you sure you want to delete "${p}"?${n?"<br>This is a pre-built template.":""}`,0,"red",[{text:"Yes",callback:()=>{b(),v.templates=[...a];const e=a.findIndex((e=>e.name===p)),t=a[e].index;a.splice(e,1),y=y.filter((e=>e!==t));const n=setTimeout((()=>{B("Delete operation timed out. Please try again.",3e3,"red",[],"delete")}),5e3);chrome.storage.local.set({templates:a,recentIndices:y},(()=>{clearTimeout(n),chrome.runtime.lastError?B("Failed to delete template: "+chrome.runtime.lastError.message,3e3,"red",[],"delete"):(B("Template deleted successfully. Press Ctrl+Z to undo.",3e3,"green",[],"delete"),p=null,d.templateName.value="",d.templateTags.value="",d.promptArea.value="# Your Role\n* \n\n# Background Information\n* \n\n# Your Task\n* ",d.searchBox.value="",d.fetchBtn2.style.display="block",d.clearPrompt.style.display="none",N(),T())}))}},{text:"No",callback:()=>{}}],"delete")})):B("Please select a template to delete.",3e3,"red",[],"delete")})),document.addEventListener("keydown",(e=>{e.ctrlKey&&"z"===e.key&&v&&(d.templateName.value=v.name||"",d.templateTags.value=v.tags||"",d.promptArea.value=v.content||"",p=v.selectedName||null,v.templates&&(chrome.storage.local.set({templates:v.templates},(()=>{N()})),B("Action undone successfully.",2e3,"green",[],"undo")),d.fetchBtn2.style.display=d.promptArea.value?"none":"block",d.clearPrompt.style.display=d.promptArea.value?"block":"none",v=null,T())})),document.addEventListener("click",(t=>{if(t.target.classList.contains("favorite-toggle")){const a=t.target.dataset.name;chrome.storage.local.get(["templates"],(t=>{const n=t.templates||e.map(((e,t)=>({...e,index:t}))),s=n.find((e=>e.name===a));if(s){if(!s.favorite&&n.filter((e=>e.favorite)).length>=10)return void B("Maximum of 10 favorite templates allowed.",3e3,"red",[],"favorite");s.favorite=!s.favorite,chrome.storage.local.set({templates:n},(()=>{N(d.searchBox.value.toLowerCase(),!0)}))}}))}})),document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach((e=>new bootstrap.Tooltip(e,{duration:300}))),d.dropdownResults.addEventListener("keydown",(e=>{const t=d.dropdownResults.querySelectorAll("div"),a=document.activeElement;let n=Array.from(t).indexOf(a);"ArrowDown"===e.key?(e.preventDefault(),n=(n+1)%t.length,t[n].focus()):"ArrowUp"===e.key?(e.preventDefault(),n=(n-1+t.length)%t.length,t[n].focus()):"Enter"===e.key&&(e.preventDefault(),a.click())}))}))})();