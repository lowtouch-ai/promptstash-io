(()=>{const e={"grok.com":{primarySelector:"div.query-bar textarea",previousPromptSelector:"div.message-bubble textarea[placeholder='Enter prompt here']",name:"Grok"},"perplexity.ai":{primarySelector:"textarea#ask-input, textarea[aria-placeholder='Ask anything or @ mention a Space'], div#ask-input",previousPromptSelector:"textarea:not(#ask-input)",name:"Perplexity.ai"},"chatgpt.com":{primarySelector:"div#prompt-textarea.ProseMirror[contenteditable='true']",previousPromptSelector:"textarea:not(#prompt-textarea)",name:"ChatGPT"}};let t=null,n=null,o=null;function r(){const t=window.location.hostname,n=Object.keys(e).find((e=>t.includes(e)));if(!n)return;const{primarySelector:r,previousPromptSelector:i}=e[n],s=`${r}, ${i}`;document.querySelectorAll(s).forEach((e=>{e.addEventListener("focus",(()=>{o=e}))})),new MutationObserver((e=>{e.forEach((e=>{e.addedNodes.length&&e.addedNodes.forEach((e=>{e.nodeType===Node.ELEMENT_NODE&&(e.matches(s)?[e]:e.querySelectorAll(s)).forEach((e=>{e.addEventListener("focus",(()=>{o=e}))}))}))}))})).observe(document.body,{childList:!0,subtree:!0})}function i(e){return e&&null!==e.offsetParent&&document.body.contains(e)}function s(e,t,n){if("sendPrompt"===e.action)if(t){if("DIV"===t.tagName&&"true"===t.contentEditable&&t.classList.contains("ProseMirror")){t.innerHTML="";const n=e.prompt.split("\n");t.innerHTML=n.map((e=>`<p>${e}<br></p>`)).join("")}else"DIV"===t.tagName&&"true"===t.contentEditable?(t.innerHTML="",t.innerHTML=e.prompt.replace(/\n/g,"<br>")):(t.value="",t.value=e.prompt);t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0})),t.focus(),n({success:!0})}else n({success:!1});else if("getPrompt"===e.action)if(t){let e;if("DIV"===t.tagName&&"true"===t.contentEditable&&t.classList.contains("ProseMirror")){const n=Array.from(t.querySelectorAll("p"));e=n.length>0?n.map((e=>e.textContent.trimEnd())).join("\n"):t.textContent.replace(/\n+/g,"\n").trimEnd()}else e="DIV"===t.tagName&&"true"===t.contentEditable?t.innerHTML.replace(/<br\s*\/?>/gi,"\n").replace(/<\/?[^>]+(>|$)/g,"").trimEnd():t.value||"";n({prompt:e})}else n({prompt:""});else"getSelectedText"===e.action&&n({selectedText:window.getSelection().toString()})}function l(){const t=window.location.hostname,n=Object.keys(e).find((e=>t.includes(e)));if(!n)return null;const{primarySelector:o,name:r}=e[n],i=document.querySelector(o);return i&&null!==i.offsetParent?i:null}function c(e,t){const n=document.createElement("div");n.id="promptstash-widget",n.setAttribute("aria-live","polite"),n.innerHTML=`\n      <button class="extension-button" aria-label="Open PromptStash" title="Open PromptStash">\n        <img src="${chrome.runtime.getURL("icon48.png")}" alt="PromptStash Icon" aria-hidden="true" draggable="false" style="width: 30px; height: 30px;">\n      </button>\n  `,n.style.position="absolute",n.style.zIndex="9999",n.style.visibility="hidden";let o={x:-250,y:-35};const r=document.createElement("div");if(r.style.position="absolute",r.style.top="-9999px",r.style.left="-9999px",r.appendChild(n),document.body.appendChild(r),t&&t.offsetParent){const e=t.getBoundingClientRect(),r=t.parentElement.getBoundingClientRect(),i=n.getBoundingClientRect();let s=e.right+window.scrollX+o.x,l=e.bottom+window.scrollY+o.y;s=Math.max(r.left+window.scrollX,Math.min(s,r.right+window.scrollX-i.width)),l=Math.max(r.top+window.scrollY,Math.min(l,r.bottom+window.scrollY-i.height)),n.style.left=`${s}px`,n.style.top=`${l}px`}function i(){if(!t||!t.offsetParent)return;const e=t.getBoundingClientRect(),r=n.getBoundingClientRect(),i=t.parentElement.getBoundingClientRect(),{newLeft:s,newTop:l}=function(e,t,n){let r=e.right+window.scrollX+o.x,i=e.bottom+window.scrollY+o.y;return window.location.hostname.includes("grok.com")?(r=Math.max(e.left+window.scrollX,Math.min(r,e.right+window.scrollX-n.width)),i=Math.max(e.top+window.scrollY,Math.min(i,e.bottom+window.scrollY-n.height))):(r=Math.max(t.left+window.scrollX,Math.min(r,t.right+window.scrollX-n.width)),i=Math.max(t.top+window.scrollY,Math.min(i,t.bottom+window.scrollY-n.height))),{newLeft:r,newTop:i}}(e,i,r);n.style.top=`${l}px`,n.style.left=`${s}px`}r.remove(),document.body.appendChild(n),n.style.visibility="visible",n.previousContainerRect=t.getBoundingClientRect(),chrome.storage.local.get(["widgetOffset"],(e=>{e.widgetOffset&&(o=e.widgetOffset,i())})),n.updatePosition=i,n.addEventListener("mouseenter",(()=>{n.style.transform="scale(1.02)"})),n.addEventListener("mouseleave",(()=>{n.style.transform="scale(1)"}));const s=new ResizeObserver(p((()=>{i()}),50));s.observe(t),n.resizeObserver=s;const l=p((()=>i()),50),c=()=>l();window.addEventListener("resize",c),n.resizeListener=c,function(e,t){let n,r,i=!1;e.addEventListener("mousedown",(t=>{i=!0,n=t.clientX-e.getBoundingClientRect().left,r=t.clientY-e.getBoundingClientRect().top})),window.addEventListener("mousemove",(s=>{if(i){const i=t.getBoundingClientRect(),l=e.getBoundingClientRect(),c=window.location.hostname.includes("grok.com")?i:t.parentElement.getBoundingClientRect();let a=s.clientX-n,d=s.clientY-r;a=Math.max(c.left+window.scrollX,Math.min(a,c.right+window.scrollX-l.width)),d=Math.max(c.top+window.scrollY,Math.min(d,c.bottom+window.scrollY-l.height)),e.style.left=`${a}px`,e.style.top=`${d}px`;const u=a-(i.right+window.scrollX),m=d-(i.bottom+window.scrollY);o={x:u,y:m},chrome.storage.local.set({widgetOffset:o},(()=>{}))}})),window.addEventListener("mouseup",(()=>{i=!1}),{capture:!0}),window.addEventListener("touchend",(()=>{i=!1}),{capture:!0}),window.addEventListener("touchcancel",(()=>{i=!1}),{capture:!0});const s=document.getElementById("promptstash-popup");s&&(s.addEventListener("mousemove",(()=>{i=!1,console.log("Drag stopped on mousemove popup iframe")})),s.addEventListener("touchmove",(()=>{i=!1,console.log("Touch dragging stopped on mousemove popup iframe")})));const l=new MutationObserver((()=>{const e=document.getElementById("promptstash-popup");e&&!e.dataset.mouseenterAttached&&(e.addEventListener("mouseenter",(()=>{i=!1,console.log("Drag stopped on mouseenter popup iframe (dynamic listener)")})),e.dataset.mouseenterAttached="true")}));l.observe(document.body,{childList:!0,subtree:!0})}(n,t);const a=n.querySelector(".extension-button");let d,u,m,g=!1;function h(e){if(clearTimeout(m),!g){if(document.getElementById("promptstash-popup"))return g=!1,void console.log("Widget clicked; pop-up already open; isDragging =",g);try{chrome.runtime.sendMessage({action:"togglePopup"},(e=>{if(chrome.runtime.lastError)return console.error("Failed to send togglePopup message:",chrome.runtime.lastError.message),void chrome.runtime.sendMessage({action:"reInjectContentScript",tabId:null},(e=>{e&&e.success?(console.log("Content script re-injected, retrying togglePopup..."),setTimeout((()=>{chrome.runtime.sendMessage({action:"togglePopup"})}),100)):console.error("Failed to re-inject content script:",chrome.runtime.lastError?.message)}));console.log("Widget clicked; pop-up opened; isDragging =",g)}))}catch(e){console.error("Widget click error:",e.message),chrome.runtime.sendMessage({action:"reInjectContentScript",tabId:null},(e=>{e&&e.success?(console.log("Content script re-injected due to error, retrying togglePopup..."),setTimeout((()=>{chrome.runtime.sendMessage({action:"togglePopup"})}),100)):console.error("Failed to re-inject content script:",chrome.runtime.lastError?.message)}))}}g=!1}return a.addEventListener("mousedown",(e=>{d=e.clientX,u=e.clientY,g=!1,m=setTimeout((()=>{g=!0}),300)})),a.addEventListener("mousemove",(e=>{(Math.abs(e.clientX-d)>3||Math.abs(e.clientY-u)>3)&&(g=!0)})),a.addEventListener("click",h),a.addEventListener("touchstart",(e=>{touchStartTime=Date.now(),g=!1,d=e.touches[0].clientX,u=e.touches[0].clientY,e.preventDefault(),m=setTimeout((()=>{g=!0}),300)})),a.addEventListener("touchmove",(e=>{(Math.abs(e.touches[0].clientX-d)>3||Math.abs(e.touches[0].clientY-u)>3)&&(g=!0)})),a.addEventListener("touchend",(e=>{clearTimeout(m);const t=Date.now()-touchStartTime;!g&&t<300&&(g=!1,h()),g=!1,e.preventDefault()})),a.addEventListener("touchcancel",(()=>{clearTimeout(m),g=!1})),a.addEventListener("mouseleave",(()=>{clearTimeout(m)})),a.addEventListener("keydown",(e=>{"Enter"!==e.key&&"Space"!==e.key||(e.preventDefault(),h())})),n}chrome.runtime.onMessage.addListener(((e,n,r)=>{let c=t||l(),a=o&&i(o)?o:c;if(!c&&("sendPrompt"===e.action||"getPrompt"===e.action)){let n=0;const d=3,u=500,m=()=>{n++,c=l(),c?(t=c,a=o&&i(o)?o:c,s(e,a,r)):n<d?setTimeout(m,u):s(e,a,r)};return setTimeout(m,u),!0}return s(e,a,r),!0}));let a=null,d=null,u=null,m=!1;function p(e,t){let n;return function(...o){clearTimeout(n),n=setTimeout((()=>e.apply(this,o)),t)}}const g=p((function(){let e=l(),o=function(e){if(!e)return null;if(window.location.hostname.includes("grok.com")){const t=e.closest("div.query-bar");if(t)return t}let t=e.parentElement;for(;t&&t!==document.body;){const e=t.querySelectorAll('button, [role="button"], [type="submit"]').length>0,n="FORM"===t.tagName||"DIV"===t.tagName&&t.classList.contains("input-container");if(e||n||t.querySelector('[aria-label*="send" i], [aria-label*="submit" i]'))return t;t=t.parentElement}return e.parentElement||document.body}(e);if(!e||!o)return void(m&&u&&setTimeout(g,500));const r=u&&document.body.contains(u)&&null!==u.offsetParent;if(e&&o)if(m&&r){if(e!==a||o!==d)u&&(u.resizeObserver&&u.resizeObserver.disconnect(),u.resizeListener&&window.removeEventListener("resize",u.resizeListener),u.remove()),u=c(0,o),a=e,d=o,t=e,n=o;else if(m&&u&&o){const e=o.getBoundingClientRect();u.previousContainerRect&&(s=e,(i=u.previousContainerRect)&&s&&i.top===s.top&&i.left===s.left&&i.width===s.width&&i.height===s.height)||(u.updatePosition(),u.previousContainerRect=e)}}else u&&(u.resizeObserver&&u.resizeObserver.disconnect(),u.resizeListener&&window.removeEventListener("resize",u.resizeListener),u.remove()),u=c(0,o),a=e,d=o,t=e,n=o,m=!0;var i,s}),150);g(),r();const h=p((function(){m&&u&&!document.body.contains(u)&&(m=!1,g())}),3e4);setInterval(h,3e4),new MutationObserver(p((()=>{g(),r()}),150)).observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class","style","aria-label","placeholder"]})})();