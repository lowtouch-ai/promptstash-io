(()=>{const e={"grok.com":{primarySelector:"div.query-bar textarea",previousPromptSelector:"div.message-bubble textarea[placeholder='Enter prompt here']",name:"Grok"},"perplexity.ai":{primarySelector:"textarea#ask-input, textarea[aria-placeholder='Ask anything or @ mention a Space'], div#ask-input",previousPromptSelector:"textarea:not(#ask-input)",name:"Perplexity.ai"},"chatgpt.com":{primarySelector:"div#prompt-textarea.ProseMirror[contenteditable='true']",previousPromptSelector:"textarea:not(#prompt-textarea)",name:"ChatGPT"}};let t=null,n=null,o=null;function i(){const t=window.location.hostname,n=Object.keys(e).find((e=>t.includes(e)));if(!n)return;const{primarySelector:i,previousPromptSelector:r}=e[n],s=`${i}, ${r}`;document.querySelectorAll(s).forEach((e=>{e.addEventListener("focus",(()=>{o=e}))})),new MutationObserver((e=>{e.forEach((e=>{e.addedNodes.length&&e.addedNodes.forEach((e=>{e.nodeType===Node.ELEMENT_NODE&&(e.matches(s)?[e]:e.querySelectorAll(s)).forEach((e=>{e.addEventListener("focus",(()=>{o=e}))}))}))}))})).observe(document.body,{childList:!0,subtree:!0})}function r(e){return e&&null!==e.offsetParent&&document.body.contains(e)}function s(e,t,n){if("sendPrompt"===e.action)if(t){if("DIV"===t.tagName&&"true"===t.contentEditable&&t.classList.contains("ProseMirror")){t.innerHTML="";const n=e.prompt.split("\n");t.innerHTML=n.map((e=>`<p>${e}<br></p>`)).join("")}else"DIV"===t.tagName&&"true"===t.contentEditable?(t.innerHTML="",t.innerHTML=e.prompt.replace(/\n/g,"<br>")):(t.value="",t.value=e.prompt);t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0})),t.focus(),n({success:!0})}else n({success:!1});else if("getPrompt"===e.action)if(t){let e;if("DIV"===t.tagName&&"true"===t.contentEditable&&t.classList.contains("ProseMirror")){const n=Array.from(t.querySelectorAll("p"));e=n.length>0?n.map((e=>e.textContent.trimEnd())).join("\n"):t.textContent.replace(/\n+/g,"\n").trimEnd()}else e="DIV"===t.tagName&&"true"===t.contentEditable?t.innerHTML.replace(/<br\s*\/?>/gi,"\n").replace(/<\/?[^>]+(>|$)/g,"").trimEnd():t.value||"";n({prompt:e})}else n({prompt:""});else"getSelectedText"===e.action&&n({selectedText:window.getSelection().toString()})}function l(){const t=window.location.hostname,n=Object.keys(e).find((e=>t.includes(e)));if(!n)return null;const{primarySelector:o,name:i}=e[n],r=document.querySelector(o);return r&&null!==r.offsetParent?r:null}function a(e,t){const n=document.createElement("div");n.id="promptstash-widget",n.setAttribute("aria-live","polite"),n.innerHTML=`\n      <button class="extension-button" aria-label="Open PromptStash" title="Open PromptStash">\n        <img src="${chrome.runtime.getURL("icon48.png")}" alt="PromptStash Icon" aria-hidden="true" draggable="false" style="width: 30px; height: 30px;">\n      </button>\n  `,n.style.position="absolute",n.style.zIndex="9999",n.style.visibility="hidden";let o={x:-250,y:-35};const i=document.createElement("div");if(i.style.position="absolute",i.style.top="-9999px",i.style.left="-9999px",i.appendChild(n),document.body.appendChild(i),t&&t.offsetParent){const e=t.getBoundingClientRect(),i=t.parentElement.getBoundingClientRect(),r=n.getBoundingClientRect();let s=e.right+window.scrollX+o.x,l=e.bottom+window.scrollY+o.y;s=Math.max(i.left+window.scrollX,Math.min(s,i.right+window.scrollX-r.width)),l=Math.max(i.top+window.scrollY,Math.min(l,i.bottom+window.scrollY-r.height)),n.style.left=`${s}px`,n.style.top=`${l}px`}function r(){if(!t||!t.offsetParent)return;const e=t.getBoundingClientRect(),i=n.getBoundingClientRect(),r=t.parentElement.getBoundingClientRect(),{newLeft:s,newTop:l}=function(e,t,n){let i=e.right+window.scrollX+o.x,r=e.bottom+window.scrollY+o.y;return window.location.hostname.includes("grok.com")?(i=Math.max(e.left+window.scrollX,Math.min(i,e.right+window.scrollX-n.width)),r=Math.max(e.top+window.scrollY,Math.min(r,e.bottom+window.scrollY-n.height))):(i=Math.max(t.left+window.scrollX,Math.min(i,t.right+window.scrollX-n.width)),r=Math.max(t.top+window.scrollY,Math.min(r,t.bottom+window.scrollY-n.height))),{newLeft:i,newTop:r}}(e,r,i);n.style.top=`${l}px`,n.style.left=`${s}px`}i.remove(),document.body.appendChild(n),n.style.visibility="visible",n.previousContainerRect=t.getBoundingClientRect(),chrome.storage.local.get(["widgetOffset"],(e=>{e.widgetOffset&&(o=e.widgetOffset,r())})),n.updatePosition=r,n.addEventListener("mouseenter",(()=>{n.style.transform="scale(1.02)"})),n.addEventListener("mouseleave",(()=>{n.style.transform="scale(1)"}));const s=new ResizeObserver(m((()=>{r()}),50));s.observe(t),n.resizeObserver=s;const l=m((()=>r()),50),a=()=>l();window.addEventListener("resize",a),n.resizeListener=a,function(e,t){let n,i,r=!1;e.addEventListener("mousedown",(t=>{r=!0,n=t.clientX-e.getBoundingClientRect().left,i=t.clientY-e.getBoundingClientRect().top})),window.addEventListener("mousemove",(s=>{if(r){const r=t.getBoundingClientRect(),l=e.getBoundingClientRect(),a=window.location.hostname.includes("grok.com")?r:t.parentElement.getBoundingClientRect();let c=s.clientX-n,d=s.clientY-i;c=Math.max(a.left+window.scrollX,Math.min(c,a.right+window.scrollX-l.width)),d=Math.max(a.top+window.scrollY,Math.min(d,a.bottom+window.scrollY-l.height)),e.style.left=`${c}px`,e.style.top=`${d}px`;const u=c-(r.right+window.scrollX),p=d-(r.bottom+window.scrollY);o={x:u,y:p},chrome.storage.local.set({widgetOffset:o},(()=>{}))}})),window.addEventListener("mouseup",(()=>{r=!1}),{capture:!0}),window.addEventListener("touchend",(()=>{r=!1}),{capture:!0}),window.addEventListener("touchcancel",(()=>{r=!1}),{capture:!0});const s=document.getElementById("promptstash-popup");s&&(s.addEventListener("mousemove",(()=>{r=!1,console.log("Drag stopped on mousemove popup iframe")})),s.addEventListener("touchmove",(()=>{r=!1,console.log("Touch dragging stopped on mousemove popup iframe")})));const l=new MutationObserver((()=>{const e=document.getElementById("promptstash-popup");e&&!e.dataset.mouseenterAttached&&(e.addEventListener("mouseenter",(()=>{r=!1,console.log("Drag stopped on mouseenter popup iframe (dynamic listener)")})),e.dataset.mouseenterAttached="true")}));l.observe(document.body,{childList:!0,subtree:!0})}(n,t);const c=n.querySelector(".extension-button");let d,u,p,g,h=!1;return c.addEventListener("mousedown",(e=>{d=e.clientX,u=e.clientY,h=!1,p=setTimeout((()=>{h=!0}),300)})),c.addEventListener("mousemove",(e=>{(Math.abs(e.clientX-d)>3||Math.abs(e.clientY-u)>3)&&(h=!0)})),c.addEventListener("click",(e=>{if(clearTimeout(p),!h){if(document.getElementById("promptstash-popup"))return h=!1,void console.log("Widget clicked; pop-up already open; isDragging =",h);chrome.runtime.sendMessage({action:"togglePopup"}),console.log("Widget clicked; pop-up opened; isDragging =",h)}h=!1})),c.addEventListener("touchstart",(e=>{g=Date.now(),h=!1,d=e.touches[0].clientX,u=e.touches[0].clientY,e.preventDefault(),p=setTimeout((()=>{h=!0}),300)})),c.addEventListener("touchmove",(e=>{(Math.abs(e.touches[0].clientX-d)>3||Math.abs(e.touches[0].clientY-u)>3)&&(h=!0)})),c.addEventListener("touchend",(e=>{clearTimeout(p);const t=Date.now()-g;!h&&t<300&&(h=!1,chrome.runtime.sendMessage({action:"togglePopup"})),h=!1,e.preventDefault()})),c.addEventListener("touchcancel",(()=>{clearTimeout(p),h=!1})),c.addEventListener("mouseleave",(()=>{clearTimeout(p)})),c.addEventListener("keydown",(e=>{"Enter"!==e.key&&"Space"!==e.key||(e.preventDefault(),chrome.runtime.sendMessage({action:"togglePopup"}))})),n}chrome.runtime.onMessage.addListener(((e,n,i)=>{let a=t||l(),c=o&&r(o)?o:a;if(!a&&("sendPrompt"===e.action||"getPrompt"===e.action)){let n=0;const d=3,u=()=>{n++,a=l(),a?(t=a,c=o&&r(o)?o:a,s(e,c,i)):n<d?setTimeout(u,timeout):s(e,c,i)};return setTimeout(u,500),!0}return s(e,c,i),!0}));let c=null,d=null,u=null,p=!1;function m(e,t){let n;return function(...o){clearTimeout(n),n=setTimeout((()=>e.apply(this,o)),t)}}const g=m((function(){let e=l(),o=function(e){if(!e)return null;if(window.location.hostname.includes("grok.com")){const t=e.closest("div.query-bar");if(t)return t}let t=e.parentElement;for(;t&&t!==document.body;){const e=t.querySelectorAll('button, [role="button"], [type="submit"]').length>0,n="FORM"===t.tagName||"DIV"===t.tagName&&t.classList.contains("input-container");if(e||n||t.querySelector('[aria-label*="send" i], [aria-label*="submit" i]'))return t;t=t.parentElement}return e.parentElement||document.body}(e);var i,r;if(e&&o){if(e&&o)if(p){if(e!==c||o!==d)u&&(u.resizeObserver&&u.resizeObserver.disconnect(),u.resizeListener&&window.removeEventListener("resize",u.resizeListener),u.remove()),u=a(0,o),c=e,d=o,t=e,n=o;else if(p&&u&&o){const e=o.getBoundingClientRect();u.previousContainerRect&&(r=e,(i=u.previousContainerRect)&&r&&i.top===r.top&&i.left===r.left&&i.width===r.width&&i.height===r.height)||(u.updatePosition(),u.previousContainerRect=e)}}else u=a(0,o),c=e,d=o,t=e,n=o,p=!0}else p&&u&&setTimeout(g,500)}),150);g(),i(),new MutationObserver(m((()=>{g(),i()}),150)).observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class","style","aria-label","placeholder"]})})();