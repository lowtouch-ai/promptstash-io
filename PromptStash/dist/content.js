(()=>{const e={"grok.com":{primarySelector:"div.query-bar textarea",previousPromptSelector:"div.message-bubble textarea[placeholder='Enter prompt here']",name:"Grok"},"perplexity.ai":{primarySelector:"div#ask-input, textarea[aria-placeholder='Ask anythingâ€¦'], textarea#ask-input",previousPromptSelector:"textarea:not(#ask-input)",name:"Perplexity.ai"},"chatgpt.com":{primarySelector:"div#prompt-textarea.ProseMirror[contenteditable='true']",previousPromptSelector:"textarea:not(#prompt-textarea)",name:"ChatGPT"}};let t=null,o=null,n=null;function i(){const t=window.location.hostname,o=Object.keys(e).find((e=>t.includes(e)));if(!o)return;const{primarySelector:i,previousPromptSelector:r}=e[o],l=`${i}, ${r}`;document.querySelectorAll(l).forEach((e=>{e.addEventListener("focus",(()=>{n=e,console.log("Focused field updated:")}))})),new MutationObserver((e=>{e.forEach((e=>{e.addedNodes.length&&e.addedNodes.forEach((e=>{e.nodeType===Node.ELEMENT_NODE&&(e.matches(l)?[e]:e.querySelectorAll(l)).forEach((e=>{e.addEventListener("focus",(()=>{n=e,console.log("Focused field updated (dynamic):")}))}))}))}))})).observe(document.body,{childList:!0,subtree:!0})}function r(e){return e&&null!==e.offsetParent&&document.body.contains(e)}function l(e,t,o){if("sendPrompt"===e.action){if(!e.prompt||!e.prompt.trim())return console.log("Empty or invalid prompt received."),void o({success:!1,error:"Prompt is empty or invalid"});if(t){console.log("Setting the prompt to target field:",e.prompt);const n=window.location.hostname;if(console.log(`Target field value before clearing: ${t.value}`),console.log(`Target field innerHTML before clearing: ${t.innerHTML}`),"TEXTAREA"===t.tagName||"INPUT"===t.tagName)t.value="",console.log(`Target field value after clearing globally: ${t.value}`);else{const e=t.innerHTML;console.log("oldText =",e),t.innerHTML="",console.log(`Target field innerHTML after clearing globally: ${t.innerHTML}`)}if(n.includes("perplexity.ai"))if("ask-input"===t.id&&"true"===t.getAttribute("data-lexical-editor")){t.innerHTML="",console.log(`Target field innerHTML after clearing locally: ${t.innerHTML}`);const o=document.createElement("p");o.setAttribute("dir","ltr");const n=e.prompt.split("\n").filter((e=>e.trim()));n.forEach(((e,t)=>{if(e){const i=document.createElement("span");i.setAttribute("data-lexical-text","true"),i.textContent=e,o.appendChild(i),t<n.length-1&&o.appendChild(document.createElement("br"))}})),t.appendChild(o),console.log("Target field innerHTML after appendChild(p):",t.innerHTML);try{t.focus(),document.execCommand("selectAll",!1,null),document.execCommand("delete",!1,null),document.execCommand("insertHTML",!1,o.outerHTML),console.log("Simulated user input with execCommand, new innerHTML:",t.innerHTML)}catch(e){console.log("execCommand failed:",e.message),t.innerHTML=o.outerHTML}try{const e=document.createRange(),t=window.getSelection();e.selectNodeContents(o),e.collapse(!1),t.removeAllRanges(),t.addRange(e)}catch(e){console.log("Failed to set selection range:",e.message)}const i=new InputEvent("beforeinput",{bubbles:!0,cancelable:!0,inputType:"insertParagraph",data:e.prompt});t.dispatchEvent(i);const r=new InputEvent("input",{bubbles:!0,inputType:"insertText",data:e.prompt});t.dispatchEvent(r);const l=new Event("compositionend",{bubbles:!0});t.dispatchEvent(l),t.dispatchEvent(new Event("change",{bubbles:!0})),t.dispatchEvent(new Event("selectionchange",{bubbles:!0})),console.log("FINAL TEXT IN INPUT FIELD:",t.innerHTML)}else"TEXTAREA"===t.tagName&&(t.value=e.prompt,console.log("Set value for Perplexity.ai textarea:"),t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0})));else if("DIV"===t.tagName&&"true"===t.contentEditable&&t.classList.contains("ProseMirror")){const o=e.prompt.split("\n");t.innerHTML=o.map((e=>`<p>${e}<br></p>`)).join(""),console.log("Set innerHTML for ChatGPT ProseMirror div with <p> and <br> tags.")}else"DIV"===t.tagName&&"true"===t.contentEditable?(t.innerHTML=e.prompt.replace(/\n/g,"<br>"),console.log("Set innerHTML for contenteditable div with <br> for newlines.")):(t.value=e.prompt,console.log("Set value for input/textarea."));n.includes("perplexity.ai")||(t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0}))),t.focus(),o({success:!0})}else console.log("No target field found for sendPrompt"),o({success:!1,error:"No target field found"})}else if("getPrompt"===e.action)if(t){let e;if(window.location.hostname.includes("perplexity.ai")&&"ask-input"===t.id&&"true"===t.getAttribute("data-lexical-editor")){const o=t.querySelectorAll("span[data-lexical-text='true']");o.length>0?(e=Array.from(o).map((e=>e.textContent.trimEnd())).filter((e=>e)).join("\n"),console.log("Retrieved prompt from Perplexity.ai Lexical editor:",e)):(e=t.textContent.replace(/\n+/g,"\n").trimEnd(),console.log("Retrieved prompt from Perplexity.ai Lexical editor (fallback):",e))}else if("DIV"===t.tagName&&"true"===t.contentEditable&&t.classList.contains("ProseMirror")){const o=Array.from(t.querySelectorAll("p"));o.length>0?(e=o.map((e=>e.textContent.trimEnd())).join("\n"),console.log("Retrieved prompt from ChatGPT ProseMirror div:",e)):(e=t.textContent.replace(/\n+/g,"\n").trimEnd(),console.log("Retrieved prompt from ChatGPT ProseMirror div (fallback):",e))}else"DIV"===t.tagName&&"true"===t.contentEditable?(e=t.innerHTML.replace(/<br\s*\/?>/gi,"\n").replace(/<\/?[^>]+(>|$)/g,"").trimEnd(),console.log("Retrieved prompt from contenteditable div:",e)):(e=t.value||"",console.log("Retrieved prompt from input/textarea:",e));o({prompt:e})}else console.log("No target field found for getPrompt"),o({prompt:""});else if("getSelectedText"===e.action){const e=window.getSelection().toString();console.log("Retrieved selected text:",e),o({selectedText:e})}}function a(){const t=window.location.hostname;console.log("Checking hostname for platform detection:",t);const o=Object.keys(e).find((e=>t.includes(e)));if(!o)return console.log("No supported platform detected for hostname:",t),null;const{primarySelector:n,name:i}=e[o];console.log(`Attempting to find primary input field for ${i} with selector: ${n}`);const r=document.querySelector(n);return r&&null!==r.offsetParent?(console.log(`Found primary input field for ${i}:`,"Visible:",!0),r):(console.log(`No primary input field found for ${i} with selector: ${n}`),null)}function s(e,t){const o=document.createElement("div");o.id="promptstash-widget",o.setAttribute("aria-live","polite"),o.innerHTML=`\n      <button class="extension-button" aria-label="Open PromptStash" title="Open PromptStash">\n        <img src="${chrome.runtime.getURL("icon48.png")}" alt="PromptStash Icon" aria-hidden="true" draggable="false" style="width: 30px; height: 30px;">\n      </button>\n  `,o.style.position="absolute",o.style.zIndex="9999",o.style.visibility="hidden";let n={x:-100,y:-100};const i=document.createElement("div");if(i.style.position="absolute",i.style.top="-9999px",i.style.left="-9999px",i.appendChild(o),document.body.appendChild(i),t&&t.offsetParent){const e=t.getBoundingClientRect(),i=t.parentElement.getBoundingClientRect(),r=o.getBoundingClientRect();let l=e.right+window.scrollX+n.x,a=e.bottom+window.scrollY+n.y;l=Math.max(i.left+window.scrollX,Math.min(l,i.right+window.scrollX-r.width)),a=Math.max(i.top+window.scrollY,Math.min(a,i.bottom+window.scrollY-r.height)),o.style.left=`${l}px`,o.style.top=`${a}px`}function r(){if(!t||!t.offsetParent)return;const e=t.getBoundingClientRect(),i=o.getBoundingClientRect(),r=t.parentElement.getBoundingClientRect(),{newLeft:l,newTop:a}=function(e,t,o){let i=e.right+window.scrollX+n.x,r=e.bottom+window.scrollY+n.y;return window.location.hostname.includes("grok.com")?(i=Math.max(e.left+window.scrollX,Math.min(i,e.right+window.scrollX-o.width)),r=Math.max(e.top+window.scrollY,Math.min(r,e.bottom+window.scrollY-o.height))):(i=Math.max(t.left+window.scrollX,Math.min(i,t.right+window.scrollX-o.width)),r=Math.max(t.top+window.scrollY,Math.min(r,t.bottom+window.scrollY-o.height))),{newLeft:i,newTop:r}}(e,r,i);o.style.top=`${a}px`,o.style.left=`${l}px`}i.remove(),document.body.appendChild(o),o.style.visibility="visible",o.previousContainerRect=t.getBoundingClientRect(),chrome.storage.local.get(["widgetOffset"],(e=>{e.widgetOffset&&(n=e.widgetOffset,r())})),o.updatePosition=r,o.addEventListener("mouseenter",(()=>{o.style.transform="scale(1.02)"})),o.addEventListener("mouseleave",(()=>{o.style.transform="scale(1)"}));const l=new ResizeObserver(m((()=>{r()}),50));l.observe(t),o.resizeObserver=l;const a=m((()=>r()),50),s=()=>a();window.addEventListener("resize",s),o.resizeListener=s,function(e,t){let o,i,r=!1;e.addEventListener("mousedown",(t=>{r=!0,o=t.clientX-e.getBoundingClientRect().left,i=t.clientY-e.getBoundingClientRect().top})),window.addEventListener("mousemove",(l=>{if(r){const r=t.getBoundingClientRect(),a=e.getBoundingClientRect(),s=window.location.hostname.includes("grok.com")?r:t.parentElement.getBoundingClientRect();let c=l.clientX-o,d=l.clientY-i;c=Math.max(s.left+window.scrollX,Math.min(c,s.right+window.scrollX-a.width)),d=Math.max(s.top+window.scrollY,Math.min(d,s.bottom+window.scrollY-a.height)),e.style.left=`${c}px`,e.style.top=`${d}px`;const u=c-(r.right+window.scrollX),p=d-(r.bottom+window.scrollY);n={x:u,y:p},chrome.storage.local.set({widgetOffset:n},(()=>{}))}})),window.addEventListener("mouseup",(()=>{r=!1}),{capture:!0}),window.addEventListener("touchend",(()=>{r=!1}),{capture:!0}),window.addEventListener("touchcancel",(()=>{r=!1}),{capture:!0});const l=document.getElementById("promptstash-popup");l&&(l.addEventListener("mousemove",(()=>{r=!1,console.log("Drag stopped on mousemove popup iframe")})),l.addEventListener("touchmove",(()=>{r=!1,console.log("Touch dragging stopped on mousemove popup iframe")})));const a=new MutationObserver((()=>{const e=document.getElementById("promptstash-popup");e&&!e.dataset.mouseenterAttached&&(e.addEventListener("mouseenter",(()=>{r=!1,console.log("Drag stopped on mouseenter popup iframe (dynamic listener)")})),e.dataset.mouseenterAttached="true")}));a.observe(document.body,{childList:!0,subtree:!0})}(o,t);const c=o.querySelector(".extension-button");let d,u,p,g,f=!1;return c.addEventListener("mousedown",(e=>{d=e.clientX,u=e.clientY,f=!1,p=setTimeout((()=>{f=!0}),300)})),c.addEventListener("mousemove",(e=>{(Math.abs(e.clientX-d)>3||Math.abs(e.clientY-u)>3)&&(f=!0)})),c.addEventListener("click",(e=>{if(clearTimeout(p),!f){if(document.getElementById("promptstash-popup"))return f=!1,void console.log("Widget clicked; pop-up already open; isDragging =",f);chrome.runtime.sendMessage({action:"togglePopup"}),console.log("Widget clicked; pop-up opened; isDragging =",f)}f=!1})),c.addEventListener("touchstart",(e=>{g=Date.now(),f=!1,d=e.touches[0].clientX,u=e.touches[0].clientY,e.preventDefault(),p=setTimeout((()=>{f=!0}),300)})),c.addEventListener("touchmove",(e=>{(Math.abs(e.touches[0].clientX-d)>3||Math.abs(e.touches[0].clientY-u)>3)&&(f=!0)})),c.addEventListener("touchend",(e=>{clearTimeout(p);const t=Date.now()-g;!f&&t<300&&(f=!1,chrome.runtime.sendMessage({action:"togglePopup"})),f=!1,e.preventDefault()})),c.addEventListener("touchcancel",(()=>{clearTimeout(p),f=!1})),c.addEventListener("mouseleave",(()=>{clearTimeout(p)})),c.addEventListener("keydown",(e=>{"Enter"!==e.key&&"Space"!==e.key||(e.preventDefault(),chrome.runtime.sendMessage({action:"togglePopup"}))})),o}chrome.runtime.onMessage.addListener(((e,o,i)=>{console.log("Received message:",e);let s=t||a(),c=n&&r(n)?n:s;if(s?console.log("Primary input field found:",s,"Tag:",s.tagName,"Visible:",null!==s.offsetParent):console.log("No primary input field found with initial querySelector."),!s&&("sendPrompt"===e.action||"getPrompt"===e.action)){console.log("Retrying to find primary input field...");let o=0;const d=3,u=500,p=()=>{o++,s=a(),s?(console.log(`Primary input field found on retry ${o}:`,s,"Tag:",s.tagName,"Visible:",null!==s.offsetParent),t=s,c=n&&r(n)?n:s,l(e,c,i)):o<d?(console.log(`Retry ${o} failed, retrying in ${u}ms...`),setTimeout(p,u)):(console.log("No primary input field found after max retries."),l(e,c,i))};return setTimeout(p,u),!0}return l(e,c,i),!0}));let c=null,d=null,u=null,p=!1;function m(e,t){let o;return function(...n){clearTimeout(o),o=setTimeout((()=>e.apply(this,n)),t)}}const g=m((function(){let e=a(),n=function(e){if(!e)return null;if(window.location.hostname.includes("grok.com")){const t=e.closest("div.query-bar");if(t)return console.log("Found query-bar container for grok.com:",t),t}let t=e.parentElement;for(;t&&t!==document.body;){const e=t.querySelectorAll('button, [role="button"], [type="submit"]').length>0,o="FORM"===t.tagName||"DIV"===t.tagName&&t.classList.contains("input-container");if(e||o||t.querySelector('[aria-label*="send" i], [aria-label*="submit" i]'))return t;t=t.parentElement}return e.parentElement||document.body}(e);var i,r;if(e&&n){if(e&&n)if(p){if(e!==c||n!==d)u&&(u.resizeObserver&&u.resizeObserver.disconnect(),u.resizeListener&&window.removeEventListener("resize",u.resizeListener),u.remove()),u=s(0,n),c=e,d=n,t=e,o=n;else if(p&&u&&n){const e=n.getBoundingClientRect();u.previousContainerRect&&(r=e,(i=u.previousContainerRect)&&r&&i.top===r.top&&i.left===r.left&&i.width===r.width&&i.height===r.height)||(u.updatePosition(),u.previousContainerRect=e)}}else u=s(0,n),c=e,d=n,t=e,o=n,p=!0}else p&&u&&setTimeout(g,500)}),150);g(),i(),new MutationObserver(m((()=>{g(),i()}),150)).observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class","style","aria-label","placeholder"]})})();