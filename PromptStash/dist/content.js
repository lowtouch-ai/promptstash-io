(()=>{const e={"grok.com":{primarySelector:"div.query-bar textarea",previousPromptSelector:"div.message-bubble textarea[placeholder='Enter prompt here']",name:"Grok"},"perplexity.ai":{primarySelector:"div#ask-input, textarea[aria-placeholder='Ask anythingâ€¦'], textarea#ask-input",previousPromptSelector:"textarea:not(#ask-input)",name:"Perplexity.ai"},"chatgpt.com":{primarySelector:"div#prompt-textarea.ProseMirror[contenteditable='true']",previousPromptSelector:"textarea:not(#prompt-textarea)",name:"ChatGPT"}};let t=null,n=null,o=null;function r(){const t=window.location.hostname,n=Object.keys(e).find((e=>t.includes(e)));if(!n)return;const{primarySelector:r,previousPromptSelector:i}=e[n],l=`${r}, ${i}`;document.addEventListener("focusin",(e=>{const t=e.target;t.matches(l)&&(o=t,console.log("Focused field updated via focusin:",t))}));const a=document.activeElement;a&&a.matches(l)&&(o=a,console.log("Initial focused field set:",a))}function i(e){return e&&null!==e.offsetParent&&document.body.contains(e)}function l(e,t,n){if("sendPrompt"===e.action){if(!e.prompt||!e.prompt.trim())return console.log("Empty or invalid prompt received."),void n({success:!1,error:"Prompt is empty or invalid"});if(t){console.log("Target field for sendPrompt:",t,"Type:",t.tagName);const o=window.location.hostname;if(console.log("Target field innerHTML before clearing:",t.innerHTML),"TEXTAREA"===t.tagName||"INPUT"===t.tagName?(t.value="",console.log("Target field value after clearing:",t.value)):(t.innerHTML="",console.log("Target field innerHTML after clearing:",t.innerHTML)),o.includes("perplexity.ai"))if("ask-input"===t.id&&"true"===t.getAttribute("data-lexical-editor")){t.focus();const n=new KeyboardEvent("keydown",{key:"a",ctrlKey:!0,bubbles:!0,cancelable:!0});t.dispatchEvent(n),setTimeout((()=>{t.innerHTML="";const n=document.createElement("p");if(n.setAttribute("dir","ltr"),e.prompt.trim()){const t=e.prompt.split("\n");t.forEach(((e,o)=>{const r=document.createElement("span");r.setAttribute("data-lexical-text","true"),r.textContent=e,n.appendChild(r),o<t.length-1&&n.appendChild(document.createElement("br"))}))}else{const e=document.createElement("span");e.setAttribute("data-lexical-text","true"),e.textContent="",n.appendChild(e)}t.appendChild(n);const o=new InputEvent("input",{bubbles:!0,cancelable:!0,inputType:"insertText",data:e.prompt});t.dispatchEvent(o);const r=document.createRange(),i=window.getSelection();r.selectNodeContents(n),r.collapse(!1),i.removeAllRanges(),i.addRange(r),console.log("Perplexity Lexical editor updated with new content")}),5)}else"TEXTAREA"===t.tagName&&(t.focus(),t.value=e.prompt,t.dispatchEvent(new Event("input",{bubbles:!0})),t.setSelectionRange(t.value.length,t.value.length),console.log("Perplexity textarea updated with new content"));else if("DIV"===t.tagName&&"true"===t.contentEditable&&t.classList.contains("ProseMirror")){const n=e.prompt.split("\n");t.innerHTML=n.map((e=>`<p>${e}<br></p>`)).join(""),console.log("Set innerHTML for ChatGPT ProseMirror div with <p> and <br> tags.")}else"DIV"===t.tagName&&"true"===t.contentEditable?(t.innerHTML=e.prompt.replace(/\n/g,"<br>"),console.log("Set innerHTML for contenteditable div with <br> for newlines.")):(t.value=e.prompt,console.log("Set value for input/textarea."));o.includes("perplexity.ai")||(t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0}))),t.focus(),n({success:!0})}else console.log("No target field found for sendPrompt"),n({success:!1,error:"No target field found"})}else if("getPrompt"===e.action)if(t){let e;if(console.log("Target field for getPrompt:",t,"Type:",t.tagName),window.location.hostname.includes("perplexity.ai")&&"ask-input"===t.id&&"true"===t.getAttribute("data-lexical-editor")){const n=t.querySelectorAll("span[data-lexical-text='true']");n.length>0?(e=Array.from(n).map((e=>e.textContent.trimEnd())).filter((e=>e)).join("\n"),console.log("Retrieved prompt from Perplexity.ai Lexical editor:",e)):(e=t.textContent.replace(/\n+/g,"\n").trimEnd(),console.log("Retrieved prompt from Perplexity.ai Lexical editor (fallback):",e))}else if("DIV"===t.tagName&&"true"===t.contentEditable&&t.classList.contains("ProseMirror")){const n=Array.from(t.querySelectorAll("p"));n.length>0?(e=n.map((e=>e.textContent.trimEnd())).join("\n"),console.log("Retrieved prompt from ChatGPT ProseMirror div:",e)):(e=t.textContent.replace(/\n+/g,"\n").trimEnd(),console.log("Retrieved prompt from ChatGPT ProseMirror div (fallback):",e))}else"DIV"===t.tagName&&"true"===t.contentEditable?(e=t.innerHTML.replace(/<br\s*\/?>/gi,"\n").replace(/<\/?[^>]+(>|$)/g,"").trimEnd(),console.log("Retrieved prompt from contenteditable div:",e)):(e=t.value||"",console.log("Retrieved prompt from input/textarea:",e));n({prompt:e})}else console.log("No target field found for getPrompt"),n({prompt:""});else if("getSelectedText"===e.action){const e=window.getSelection().toString();console.log("Retrieved selected text:",e),n({selectedText:e})}}function a(){const t=window.location.hostname;console.log("Checking hostname for platform detection:",t);const n=Object.keys(e).find((e=>t.includes(e)));if(!n)return console.log("No supported platform detected for hostname:",t),null;const{primarySelector:o,name:r}=e[n];console.log(`Attempting to find primary input field for ${r} with selector: ${o}`);const i=document.querySelector(o);return i&&null!==i.offsetParent?(console.log(`Found primary input field for ${r}:`,i.tagName,"Visible:",!0),i):(console.log(`No primary input field found for ${r} with selector: ${o}`),null)}function s(e,t){const n=document.createElement("div");n.id="promptstash-widget",n.setAttribute("aria-live","polite"),n.innerHTML=`\n      <button class="extension-button" style="border-radius: 100%;" aria-label="Open PromptStash" title="Open PromptStash">\n        <img src="${chrome.runtime.getURL("icon48.png")}" alt="PromptStash Icon" aria-hidden="true" draggable="false" style="width: 30px; height: 30px;">\n      </button>\n  `,n.style.position="absolute",n.style.zIndex="9999",n.style.visibility="hidden",n.style.borderRadius="100%";let o={x:-100,y:-100};const r=document.createElement("div");if(r.style.position="absolute",r.style.top="-9999px",r.style.left="-9999px",r.appendChild(n),document.body.appendChild(r),t&&t.offsetParent){const e=t.getBoundingClientRect(),r=t.parentElement.getBoundingClientRect(),i=n.getBoundingClientRect();let l=e.right+window.scrollX+o.x,a=e.bottom+window.scrollY+o.y;l=Math.max(r.left+window.scrollX,Math.min(l,r.right+window.scrollX-i.width)),a=Math.max(r.top+window.scrollY,Math.min(a,r.bottom+window.scrollY-i.height)),n.style.left=`${l}px`,n.style.top=`${a}px`}function i(){if(!t||!t.offsetParent)return;const e=t.getBoundingClientRect(),r=n.getBoundingClientRect(),i=t.parentElement.getBoundingClientRect(),{newLeft:l,newTop:a}=function(e,t,n){let r=e.right+window.scrollX+o.x,i=e.bottom+window.scrollY+o.y;return window.location.hostname.includes("grok.com")?(r=Math.max(e.left+window.scrollX,Math.min(r,e.right+window.scrollX-n.width)),i=Math.max(e.top+window.scrollY,Math.min(i,e.bottom+window.scrollY-n.height))):(r=Math.max(t.left+window.scrollX,Math.min(r,t.right+window.scrollX-n.width)),i=Math.max(t.top+window.scrollY,Math.min(i,t.bottom+window.scrollY-n.height))),{newLeft:r,newTop:i}}(e,i,r);n.style.top=`${a}px`,n.style.left=`${l}px`}r.remove(),document.body.appendChild(n),n.style.visibility="visible",n.previousContainerRect=t.getBoundingClientRect(),chrome.storage.local.get(["widgetOffset"],(e=>{e.widgetOffset&&(o=e.widgetOffset,i())})),n.updatePosition=i;const l=n.querySelector(".extension-button");l.addEventListener("pointerenter",(()=>{l.style.transform="scale(1.02)"})),l.addEventListener("pointerleave",(()=>{l.style.transform="scale(1)"}));const a=new ResizeObserver(m((()=>{i()}),5));a.observe(t),n.resizeObserver=a;const s=m((()=>i()),5),c=()=>s();window.addEventListener("resize",c),n.resizeListener=c,function(e,t){let n,r,i=!1;e.addEventListener("pointerdown",(t=>{t.preventDefault(),document.getElementById("promptstash-popup")||(i=!0,n=t.clientX-e.getBoundingClientRect().left,r=t.clientY-e.getBoundingClientRect().top,e.style.cursor="grabbing")})),window.addEventListener("pointermove",(l=>{if(!i)return;const a=t.getBoundingClientRect(),s=e.getBoundingClientRect(),c=window.location.hostname.includes("grok.com")?a:t.parentElement.getBoundingClientRect();let d=l.clientX-n,p=l.clientY-r;d=Math.max(c.left+window.scrollX,Math.min(d,c.right+window.scrollX-s.width)),p=Math.max(c.top+window.scrollY,Math.min(p,c.bottom+window.scrollY-s.height)),e.style.left=`${d}px`,e.style.top=`${p}px`;const u=d-(a.right+window.scrollX),m=p-(a.bottom+window.scrollY);o={x:u,y:m},chrome.storage.local.set({widgetOffset:o},(()=>{}))}),{capture:!0}),window.addEventListener("pointerup",(()=>{i=!1,e.style.cursor=""}),{capture:!0}),window.addEventListener("pointercancel",(()=>{i=!1,e.style.cursor=""}),{capture:!0});new MutationObserver((()=>{const t=document.getElementById("promptstash-popup");t&&!t.dataset.pointerenterAttached&&(t.addEventListener("pointerenter",(()=>{i=!1,e.style.cursor=""})),t.dataset.pointerenterAttached="true")})).observe(document.body,{childList:!0,subtree:!0})}(n,t);let d,p,u,g,f=!1,h=!1;const w=m((()=>{h||(h=!0,chrome.runtime.sendMessage({action:"togglePopup"},(()=>{setTimeout((()=>{h=!1}),300)})))}),300);return l.addEventListener("pointerdown",(e=>{e.preventDefault(),document.getElementById("promptstash-popup")||(d=e.clientX,p=e.clientY,g=Date.now(),f=!1,u=setTimeout((()=>{f=!0,l.style.cursor="grabbing"}),300))})),l.addEventListener("pointermove",(e=>{(Math.abs(e.clientX-d)>1||Math.abs(e.clientY-p)>1)&&(f=!0)})),l.addEventListener("pointerup",(e=>{clearTimeout(u);const t=Date.now()-g;!f&&t<300&&!document.getElementById("promptstash-popup")&&w(),f=!1,l.style.cursor=""})),l.addEventListener("pointercancel",(()=>{clearTimeout(u),f=!1,l.style.cursor=""})),l.addEventListener("pointerleave",(()=>{clearTimeout(u),f=!1,l.style.cursor=""})),l.addEventListener("keydown",(e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),document.getElementById("promptstash-popup")||h||w(),f=!1)})),l.setAttribute("role","button"),l.setAttribute("tabindex","0"),n}chrome.runtime.onMessage.addListener(((e,n,r)=>{console.log("Received message:",e);let s=t||a(),c=o&&i(o)?o:s;if(s?console.log("Primary input field found:",s.tagName,"Visible:",null!==s.offsetParent):console.log("No primary input field found with initial querySelector."),!s&&("sendPrompt"===e.action||"getPrompt"===e.action)){console.log("Retrying to find primary input field...");let n=0;const d=3,p=500,u=()=>{n++,s=a(),s?(console.log(`Primary input field found on retry ${n}:`,s.tagName,"Visible:",null!==s.offsetParent),t=s,c=o&&i(o)?o:s,l(e,c,r)):n<d?(console.log(`Retry ${n} failed, retrying in ${p}ms...`),setTimeout(u,p)):(console.log("No primary input field found after max retries."),l(e,c,r))};return setTimeout(u,p),!0}return l(e,c,r),!0}));let c=null,d=null,p=null,u=!1;function m(e,t){let n;return function(...o){clearTimeout(n),n=setTimeout((()=>e.apply(this,o)),t)}}const g=m((function(){let e=a(),o=function(e){if(!e)return null;if(window.location.hostname.includes("grok.com")){const t=e.closest("div.query-bar");if(t)return console.log("Found query-bar container for grok.com:",t),t}let t=e.parentElement;for(;t&&t!==document.body;){const e=t.querySelectorAll('button, [role="button"], [type="submit"]').length>0,n="FORM"===t.tagName||"DIV"===t.tagName&&t.classList.contains("input-container");if(e||n||t.querySelector('[aria-label*="send" i], [aria-label*="submit" i]'))return t;t=t.parentElement}return e.parentElement||document.body}(e);var r,i;if(e&&o){if(e&&o)if(u){if(e!==c||o!==d)p&&(p.resizeObserver&&p.resizeObserver.disconnect(),p.resizeListener&&window.removeEventListener("resize",p.resizeListener),p.remove()),p=s(0,o),c=e,d=o,t=e,n=o;else if(u&&p&&o){const e=o.getBoundingClientRect();p.previousContainerRect&&(i=e,(r=p.previousContainerRect)&&i&&r.top===i.top&&r.left===i.left&&r.width===i.width&&r.height===i.height)||(p.updatePosition(),p.previousContainerRect=e)}}else p=s(0,o),c=e,d=o,t=e,n=o,u=!0}else u&&p&&setTimeout(g,500)}),150);g(),r(),new MutationObserver(m((()=>{g(),r()}),150)).observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class","style","aria-label","placeholder"]})})();