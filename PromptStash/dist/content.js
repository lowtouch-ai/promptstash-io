(()=>{const e=chrome.runtime.connect({name:"keepAlive"});e.postMessage({status:"connected"}),setInterval((()=>{e.postMessage({status:"heartbeat"})}),6e4);const t={"grok.com":{primarySelector:"div.query-bar textarea",previousPromptSelector:"div.message-bubble textarea[placeholder='Enter prompt here']",name:"Grok"},"perplexity.ai":{primarySelector:"div#ask-input, textarea[aria-placeholder='Ask anythingâ€¦'], textarea#ask-input",previousPromptSelector:"textarea:not(#ask-input)",name:"Perplexity.ai"},"chatgpt.com":{primarySelector:"div#prompt-textarea.ProseMirror[contenteditable='true']",previousPromptSelector:"textarea:not(#prompt-textarea)",name:"ChatGPT"},"gemini.google.com":{primarySelector:"div.ql-editor, div.textarea[data-placeholder='Ask Gemini'], rich-textarea[aria-label='Enter a prompt here'] div.ql-editor",previousPromptSelector:"textarea[aria-label='Edit prompt']",name:"Gemini"},"claude.ai":{primarySelector:"div[aria-label='Write your prompt to Claude'].ProseMirror",previousPromptSelector:"textarea.bg-bg-000, div.bg-bg-000, textarea[aria-label*='screen reader interactions']",name:"Claude"}};let n=null,o=null,r=null;function i(){const e=window.location.hostname,n=Object.keys(t).find((t=>e.includes(t)));if(!n)return;const{primarySelector:o,previousPromptSelector:i}=t[n],a=`${o}, ${i}`;document.addEventListener("focusin",(e=>{const t=e.target;t.matches(a)&&(r=t)}));const l=document.activeElement;l&&l.matches(a)&&(r=l)}function a(e){return e&&null!==e.offsetParent&&document.body.contains(e)}function l(e,t,n){if("sendPrompt"===e.action){if(!e.prompt||!e.prompt.trim())return void n({success:!1,error:"Prompt is empty or invalid"});if(t)if("TEXTAREA"===(o=t).tagName||"INPUT"===o.tagName?o.disabled||o.readOnly:"DIV"!==o.tagName||"true"!==o.contentEditable)n({success:!1,error:"Target field is not editable"});else{const o=window.location.hostname;if("TEXTAREA"===t.tagName||"INPUT"===t.tagName?t.value="":t.innerHTML="",o.includes("perplexity.ai"))if("ask-input"===t.id&&"true"===t.getAttribute("data-lexical-editor")){t.focus();const n=new KeyboardEvent("keydown",{key:"a",ctrlKey:!0,bubbles:!0,cancelable:!0});t.dispatchEvent(n),setTimeout((()=>{t.innerHTML="";const n=document.createElement("p");if(n.setAttribute("dir","ltr"),e.prompt.trim()){const t=e.prompt.split("\n");t.forEach(((e,o)=>{const r=document.createElement("span");r.setAttribute("data-lexical-text","true"),r.textContent=e,n.appendChild(r),o<t.length-1&&n.appendChild(document.createElement("br"))}))}else{const e=document.createElement("span");e.setAttribute("data-lexical-text","true"),e.textContent="",n.appendChild(e)}t.appendChild(n);const o=new InputEvent("input",{bubbles:!0,cancelable:!0,inputType:"insertText",data:e.prompt});t.dispatchEvent(o);const r=document.createRange(),i=window.getSelection();r.selectNodeContents(n),r.collapse(!1),i.removeAllRanges(),i.addRange(r)}),5)}else"TEXTAREA"===t.tagName&&(t.focus(),t.value=e.prompt,t.dispatchEvent(new Event("input",{bubbles:!0})),t.setSelectionRange(t.value.length,t.value.length));else if("DIV"===t.tagName&&"true"===t.contentEditable&&(t.classList.contains("ProseMirror")||t.classList.contains("ql-editor"))){const n=e.prompt.split("\n");t.innerHTML=n.map((e=>`<p>${e}<br></p>`)).join("")}else"DIV"===t.tagName&&"true"===t.contentEditable?t.innerHTML=e.prompt.replace(/\n/g,"<br>"):t.value=e.prompt;o.includes("perplexity.ai")||(t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0}))),t.focus(),n({success:!0})}else n({success:!1,error:"No target field found"})}else if("getPrompt"===e.action)if(t){let e;if(window.location.hostname.includes("perplexity.ai")&&"ask-input"===t.id&&"true"===t.getAttribute("data-lexical-editor")){const n=t.querySelectorAll("span[data-lexical-text='true']");e=n.length>0?Array.from(n).map((e=>e.textContent.trimEnd())).filter((e=>e)).join("\n"):t.textContent.replace(/\n+/g,"\n").trimEnd()}else if("DIV"===t.tagName&&"true"===t.contentEditable&&(t.classList.contains("ProseMirror")||t.classList.contains("ql-editor"))){const n=Array.from(t.querySelectorAll("p"));e=n.length>0?n.map((e=>e.textContent.trimEnd())).join("\n"):t.textContent.replace(/\n+/g,"\n").trimEnd()}else e="DIV"===t.tagName&&"true"===t.contentEditable?t.innerHTML.replace(/<br\s*\/?>/gi,"\n").replace(/<\/?[^>]+(>|$)/g,"").trimEnd():t.value||"";n({prompt:e})}else n({prompt:""});else"getSelectedText"===e.action?n({selectedText:window.getSelection().toString()}):"ping"===e.action&&n({status:"alive"});var o}function s(){const e=window.location.hostname,n=Object.keys(t).find((t=>e.includes(t)));if(!n)return null;const{primarySelector:o,name:r}=t[n],i=document.querySelector(o);return i&&null!==i.offsetParent?i:null}function c(e,t){const n=document.createElement("div");n.id="promptstash-widget",n.setAttribute("aria-live","polite"),n.innerHTML=`\n    <button class="extension-button" style="background: none; border: none; border-radius: 100%;" aria-label="Open PromptStash" title="Open PromptStash">\n      <img src="${chrome.runtime.getURL("icon48.png")}" alt="PromptStash" aria-hidden="true" draggable="false" style="width: 30px; height: 30px;">\n    </button>\n  `,n.style.position="absolute",n.style.zIndex="9999",n.style.visibility="hidden",n.style.borderRadius="100%";let o={x:30,y:-30};if(t&&t.offsetParent){const e=t.getBoundingClientRect(),r=t.parentElement.getBoundingClientRect(),i=n.getBoundingClientRect();let a=e.right+window.scrollX+o.x,l=e.top+window.scrollY+o.y,s=.3*i.width;a=Math.max(r.left+window.scrollX-s,Math.min(a,r.right+window.scrollX-i.width+s)),l=Math.max(r.top+window.scrollY-s,Math.min(l,r.bottom+window.scrollY-i.height+s)),n.style.left=`${a}px`,n.style.top=`${l}px`}function r(){if(!t||!t.offsetParent)return;const e=t.getBoundingClientRect(),r=n.getBoundingClientRect(),i=t.parentElement.getBoundingClientRect(),{newLeft:a,newTop:l}=function(e,t,n){let r=e.right+window.scrollX+o.x,i=e.top+window.scrollY+o.y,a=.3*n.width;return window.location.hostname.includes("grok.com")?(r=Math.max(e.left+window.scrollX-a,Math.min(r,e.right+window.scrollX-n.width+a)),i=Math.max(e.top+window.scrollY-a,Math.min(i,e.bottom+window.scrollY-n.height+a))):(r=Math.max(t.left+window.scrollX-a,Math.min(r,t.right+window.scrollX-n.width+a)),i=Math.max(t.top+window.scrollY-a,Math.min(i,t.bottom+window.scrollY-n.height+a))),{newLeft:r,newTop:i}}(e,i,r);n.style.top=`${l}px`,n.style.left=`${a}px`}document.body.appendChild(n),setTimeout((()=>{n.style.visibility="visible"}),50),n.previousContainerRect=t.getBoundingClientRect(),chrome.storage.local.get(["widgetOffset"],(e=>{e.widgetOffset&&(o=e.widgetOffset,r())})),n.updatePosition=r;const i=n.querySelector(".extension-button");i.addEventListener("pointerenter",(()=>{i.style.transform="scale(1.02)"})),i.addEventListener("pointerleave",(()=>{i.style.transform="scale(1)"}));const a=new ResizeObserver(g((()=>{r()}),100));a.observe(t),n.resizeObserver=a;const l=g((()=>r()),100),s=()=>l();window.addEventListener("resize",s),n.resizeListener=s,function(e,t){let n,r,i=!1;e.addEventListener("pointerdown",(t=>{t.preventDefault(),document.getElementById("promptstash-popup")||(i=!0,n=t.clientX-e.getBoundingClientRect().left,r=t.clientY-e.getBoundingClientRect().top,e.style.cursor="grabbing")})),window.addEventListener("pointermove",(a=>{if(!i)return;const l=t.getBoundingClientRect(),s=e.getBoundingClientRect(),c=window.location.hostname.includes("grok.com")?l:t.parentElement.getBoundingClientRect();let d=a.clientX-n,u=a.clientY-r,p=.3*s.width;d=Math.max(c.left+window.scrollX-p,Math.min(d,c.right+window.scrollX-s.width+p)),u=Math.max(c.top+window.scrollY-p,Math.min(u,c.bottom+window.scrollY-s.height+p)),e.style.left=`${d}px`,e.style.top=`${u}px`;const m=d-(l.right+window.scrollX),g=u-(l.top+window.scrollY);o={x:m,y:g},chrome.storage.local.set({widgetOffset:o},(()=>{}))}),{capture:!0}),window.addEventListener("pointerup",(()=>{i=!1,e.style.cursor=""}),{capture:!0}),window.addEventListener("pointercancel",(()=>{i=!1,e.style.cursor=""}),{capture:!0});new MutationObserver((()=>{const t=document.getElementById("promptstash-popup");t&&!t.dataset.pointerenterAttached&&(t.addEventListener("pointerenter",(()=>{i=!1,e.style.cursor=""})),t.dataset.pointerenterAttached="true")})).observe(document.body,{childList:!0,subtree:!0})}(n,t);let c,d,u,p,m=!1;const h=function(e){let t=!1;return function(...n){t||(e.apply(this,n),t=!0,setTimeout((()=>{t=!1}),500))}}((()=>{chrome.runtime.sendMessage({action:"togglePopup"})}));return n.addEventListener("pointerdown",(e=>{if(e.preventDefault(),document.getElementById("promptstash-popup"))return;c=e.clientX,d=e.clientY,p=Date.now(),m=!1,u=setTimeout((()=>{m=!0,n.style.cursor="grabbing"}),300);const t=e=>{!m&&(Math.abs(e.clientX-c)>1||Math.abs(e.clientY-d)>1)&&(m=!0,n.style.cursor="grabbing")},o=()=>{clearTimeout(u);const e=Date.now()-p;!m&&e<300&&!document.getElementById("promptstash-popup")&&h(),m=!1,n.style.cursor="",document.removeEventListener("pointermove",t),document.removeEventListener("pointerup",o)};document.addEventListener("pointermove",t),document.addEventListener("pointerup",o)})),n.addEventListener("pointercancel",(()=>{clearTimeout(u),m=!1,n.style.cursor=""})),n.addEventListener("pointerleave",(()=>{clearTimeout(u),m=!1,n.style.cursor=""})),i.addEventListener("keydown",(e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),document.getElementById("promptstash-popup")||h(),m=!1,n.style.cursor="")})),i.setAttribute("role","button"),i.setAttribute("tabindex","0"),n}chrome.runtime.onMessage.addListener(((e,t,o)=>{let i=n||s(),c=r&&a(r)?r:i;if(!i&&("sendPrompt"===e.action||"getPrompt"===e.action)){let t=0;const d=3,u=500,p=()=>{t++,i=s(),i?(n=i,c=r&&a(r)?r:i,l(e,c,o)):t<d?setTimeout(p,u):l(e,c,o)};return setTimeout(p,u),!0}return l(e,c,o),!0}));let d=null,u=null,p=null,m=!1;function g(e,t){let n;return function(...o){clearTimeout(n),n=setTimeout((()=>e.apply(this,o)),t)}}const h=g((function(){let e=s(),t=function(e){if(!e)return null;if(window.location.hostname.includes("grok.com")){const t=e.closest("div.query-bar");if(t)return t}let t=e.parentElement;for(;t&&t!==document.body;){const e=t.querySelectorAll('button, [role="button"], [type="submit"]').length>0,n="FORM"===t.tagName||"DIV"===t.tagName&&t.classList.contains("input-container");if(e||n||t.querySelector('[aria-label*="send" i], [aria-label*="submit" i]'))return t;t=t.parentElement}return e.parentElement||document.body}(e);var r,i;if(e&&t){if(e&&t)if(m){if(e!==d||t!==u)p&&(p.resizeObserver&&p.resizeObserver.disconnect(),p.resizeListener&&window.removeEventListener("resize",p.resizeListener),p.remove()),p=c(0,t),d=e,u=t,n=e,m=!0;else if(m&&p&&t){const e=t.getBoundingClientRect();p.previousContainerRect&&(i=e,(r=p.previousContainerRect)&&i&&r.top===i.top&&r.left===i.left&&r.width===i.width&&r.height===i.height)||(p.updatePosition(),p.previousContainerRect=e)}}else p=c(0,t),d=e,u=t,n=e,o=t,m=!0}else m&&p&&setTimeout(h,500)}),150);h(),i(),new MutationObserver(g((()=>{h(),i()}),150)).observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class","style","aria-label","placeholder"]})})();