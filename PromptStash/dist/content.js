(()=>{function e(e,t,o){if("sendPrompt"===e.action)t?(console.log("Setting prompt:",e.prompt),"DIV"===t.tagName&&"true"===t.contentEditable?(t.innerHTML=e.prompt.replace(/\n/g,"<br>"),console.log("Set innerHTML for contenteditable div with <br> for newlines.")):(t.value=e.prompt,console.log("Set value for input/textarea.")),t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0})),t.focus(),console.log("Dispatched input and change events."),o({success:!0})):(console.log("No input field found for sendPrompt"),o({success:!1}));else if("getPrompt"===e.action)if(t){let e;"DIV"===t.tagName&&"true"===t.contentEditable?(e=t.innerHTML.replace(/<br\s*\/?>/gi,"\n").replace(/<\/?[^>]+(>|$)/g,""),console.log("Retrieved prompt from contenteditable div:",e)):(e=t.value||"",console.log("Retrieved prompt from input/textarea:",e)),o({prompt:e})}else console.log("No input field found for getPrompt"),o({prompt:""});else if("getSelectedText"===e.action){const e=window.getSelection().toString();console.log("Retrieved selected text:",e),o({selectedText:e})}}chrome.runtime.onMessage.addListener(((t,o,n)=>{console.log("Received message:",t);let r=document.querySelectorAll("div#prompt-textarea.ProseMirror[contenteditable='true'], [contenteditable='true'][role='textbox'], textarea:not([disabled]), input[type='text']:not([disabled]), [contenteditable='true'][aria-label*='prompt' i], textarea[aria-label*='prompt' i], input[aria-label*='prompt' i]"),l=Array.from(r).find((e=>null!==e.offsetParent));if(l?console.log("Input field found:",l,"Tag:",l.tagName,"Visible:",null!==l.offsetParent):console.log("No visible input field found with initial querySelector."),!l&&("sendPrompt"===t.action||"getPrompt"===t.action))return console.log("Retrying to find input field after 500ms..."),setTimeout((()=>{r=document.querySelectorAll("div#prompt-textarea.ProseMirror[contenteditable='true'], [contenteditable='true'][role='textbox'], textarea:not([disabled]), input[type='text']:not([disabled]), [contenteditable='true'][aria-label*='prompt' i], textarea[aria-label*='prompt' i], input[aria-label*='prompt' i]"),l=Array.from(r).find((e=>null!==e.offsetParent)),l?console.log("Input field found on retry:",l,"Tag:",l.tagName,"Visible:",null!==l.offsetParent):console.log("No visible input field found after retry."),e(t,l,n)}),500),!0;e(t,l,n)})),document.addEventListener("click",(e=>{const t=document.getElementById("promptstash-popup");t&&!t.contains(e.target)&&chrome.runtime.sendMessage({action:"closePopup"})}))})();